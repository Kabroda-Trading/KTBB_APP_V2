{% extends "base.html" %}

{% block title %}Kabroda | Battle Control{% endblock %}

{% block content %}
<div class="app-container" style="max-width: 1400px; margin: 0 auto;">
    
    <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 15px;">
        <div>
            <h1 style="font-size: 1.8rem; margin: 0; color: #fff; letter-spacing: -1px;">BATTLE CONTROL</h1>
            <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">War Map Context & Session Execution</div>
        </div>
        <div style="display: flex; gap: 15px; align-items: center;">
            <div class="live-toggle">
                <input type="checkbox" id="autoRefreshToggle" onchange="toggleAutoRefresh()">
                <label for="autoRefreshToggle">LIVE LINK</label>
                <div id="live-dot"></div>
            </div>
            <div class="input-group" style="margin:0;">
                <select id="sessionMode" onchange="toggleManualSession()" class="cyber-select">
                    <option value="AUTO">AUTO (Dominant)</option>
                    <option value="MANUAL">MANUAL OVERRIDE</option>
                </select>
                <select id="manualSessionId" class="cyber-select" style="display:none; margin-left:5px;">
                    <option value="us_ny_futures">NY Futures</option>
                    <option value="eu_london">London</option>
                    <option value="asia_tokyo">Tokyo</option>
                </select>
            </div>
            <button onclick="runLivePulse()" class="cyber-btn-primary" id="main-action-btn" style="height: 42px;">UPDATE INTEL</button>
        </div>
    </div>

    <div style="display: grid; grid-template-columns: 280px 1fr; gap: 20px;">
        
        <div style="display: flex; flex-direction: column; gap: 15px;">
            <div class="cyber-card" style="border-left: 3px solid #8b5cf6;">
                <div class="card-header" style="color:#a78bfa;">WAR MAP CONTEXT</div>
                <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                    <span style="color:#888; font-size:0.8rem;">LEAN</span>
                    <span id="wm-lean" style="font-weight:bold; color:#fff;">--</span>
                </div>
                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <span style="color:#888; font-size:0.8rem;">PHASE</span>
                    <span id="wm-phase" style="font-weight:bold; color:#fff;">--</span>
                </div>
                <div id="wm-note" style="font-size:0.75rem; color:#888; border-top:1px solid #333; padding-top:10px;">--</div>
            </div>

            <div class="cyber-card">
                <div class="card-header">KEY LEVELS</div>
                <div class="level-row"><span>Daily Res</span><span id="val-dr" class="val">---</span></div>
                <div class="level-row"><span style="color:var(--bull);">Breakout</span><span id="val-bo" class="val">---</span></div>
                <div class="level-row"><span style="color:var(--bear);">Breakdown</span><span id="val-bd" class="val">---</span></div>
                <div class="level-row"><span>Daily Sup</span><span id="val-ds" class="val">---</span></div>
            </div>
            
            <button onclick="toggleTactical()" class="cyber-btn-sec" style="width:100%; font-size:0.8rem;">TOGGLE TACTICAL DRAWER</button>
        </div>

        <div class="cyber-card" style="border-left: 4px solid #3b82f6;">
            <div class="card-header" style="color:#60a5fa; display:flex; justify-content:space-between;">
                <span>SESSION BATTLE</span>
                <span id="session-name" style="color:#fff;">--</span>
            </div>

            <div style="text-align: center; padding: 25px; background: #080808; border: 1px solid #333; border-radius: 4px; margin-bottom: 25px;">
                <div style="font-size: 0.8rem; color: #666; letter-spacing: 2px;">CURRENT DIRECTIVE</div>
                <div id="sb-action" style="font-size: 4rem; font-weight: 900; color: #444; line-height: 1.1;">HOLD FIRE</div>
                <div id="sb-reason" style="margin-top: 10px; color: #ccc; font-size: 1.1rem;">Waiting for data...</div>
            </div>

            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 25px;">
                <div class="metric-box">
                    <div class="label">PRICE</div>
                    <div class="val" id="live-price" style="color:#fff;">---</div>
                </div>
                <div class="metric-box">
                    <div class="label">PERMISSION</div>
                    <div class="val" id="sb-perm">NONE</div>
                </div>
                <div class="metric-box">
                    <div class="label">ACCEPTANCE</div>
                    <div class="val" id="sb-accept">0/2</div>
                </div>
                <div class="metric-box">
                    <div class="label">LOCATION</div>
                    <div class="val" id="sb-loc" style="font-size:0.7rem;">--</div>
                </div>
            </div>

            <div id="sb-prepare-box" style="display: block; background: #112211; padding: 20px; border: 1px solid var(--primary); margin-bottom: 20px;">
                <div style="font-size: 0.9rem; color: var(--primary); font-weight: bold; margin-bottom: 15px; text-align: center;">
                    EXECUTION GATES (5M)
                    <span id="sb-gates-mode" style="display:block; font-size:0.7rem; color:#88aa88; margin-top:4px;">PREVIEW (FLOATING)</span>
                </div>
                <div style="display: flex; justify-content: space-between; font-family: monospace; font-size: 1.4rem;">
                    <div><span style="color:#ef4444; font-size:0.8rem;">FAILURE LINE</span><br><span id="sb-fail-line" style="color:#fff;">--</span></div>
                    <div style="text-align:right;"><span style="color:#00ff9d; font-size:0.8rem;">CONTINUATION</span><br><span id="sb-cont-line" style="color:#fff;">--</span></div>
                </div>
            </div>
            
            <div style="text-align: right; display:flex; gap:10px; justify-content:flex-end;">
                <button onclick="copyTraderBrief()" class="cyber-btn-sec">COPY BRIEF</button>
                <button onclick="copyBattleBox()" class="cyber-btn-primary">COPY FULL BATTLEBOX</button>
            </div>
        </div>
    </div>

    <div id="tactical-drawer" style="display: none; margin-top: 30px; border-top: 1px solid #333; padding-top: 20px;">
        <h3 style="color: #888; font-size: 1rem; margin-bottom: 20px;">TACTICAL INTELLIGENCE (OPTIONAL)</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
            <div class="cyber-card">
                <div class="card-header">CAMPAIGN (BIG TRADE)</div>
                <div id="wm-camp-status" style="font-size: 1.5rem; font-weight: bold; color: #666;">NOT ARMED</div>
                <div id="wm-camp-note" style="margin-top: 10px; color: #888;">--</div>
            </div>
            <div class="cyber-card">
                <div class="card-header">STRATEGY STATUS (OPTIONAL)</div>
                <div id="strat-list" style="font-size: 0.8rem; color: #ccc;">Loading...</div>
            </div>
        </div>
    </div>

</div>

<style>
:root { --bg: #0a0a0a; --card: #141414; --primary: #00ff9d; --bull: #00ff9d; --bear: #ff4444; }
body { background-color: var(--bg); font-family: 'Inter', sans-serif; }
.cyber-card { background: var(--card); border: 1px solid #222; padding: 20px; border-radius: 4px; }
.card-header { font-size: 0.8rem; letter-spacing: 1px; margin-bottom: 15px; border-bottom: 1px solid #222; padding-bottom: 10px; font-weight: bold; }
.metric-box { background: #111; border: 1px solid #333; padding: 10px; text-align: center; border-radius: 4px; }
.metric-box .label { font-size: 0.65rem; color: #666; margin-bottom: 3px; }
.metric-box .val { font-size: 1.1rem; font-weight: bold; color: #ccc; }
.level-row { display: flex; justify-content: space-between; font-size: 0.8rem; color: #888; border-bottom: 1px dashed #222; padding: 8px 0; }
.level-row .val { color: #fff; font-family: monospace; font-weight: bold; }
.live-toggle { display: flex; align-items: center; gap: 8px; background: #111; padding: 5px 12px; border: 1px solid #333; border-radius: 4px; }
.live-toggle label { font-size: 0.7rem; color: #888; font-weight: bold; cursor: pointer; }
#live-dot { width: 8px; height: 8px; background: #333; border-radius: 50%; transition: 0.3s; }
.cyber-btn-primary { background: var(--primary); color: #000; border: none; font-weight: 800; padding: 0 20px; cursor: pointer; }
.cyber-btn-sec { background: #222; color: #fff; border: 1px solid #444; padding: 10px 20px; cursor: pointer; font-weight: 600; }
.cyber-select { background: #000; color: #fff; border: 1px solid #333; padding: 10px; cursor: pointer; }
</style>

<script>
let lastPacket = null;
let autoRefreshTimer = null;

function toggleTactical() {
    const d = document.getElementById('tactical-drawer');
    d.style.display = d.style.display === 'none' ? 'block' : 'none';
}

function toggleManualSession() {
    const mode = document.getElementById('sessionMode').value;
    document.getElementById('manualSessionId').style.display = (mode === 'MANUAL') ? 'inline-block' : 'none';
}

function toggleAutoRefresh() {
    if(document.getElementById('autoRefreshToggle').checked) {
        document.getElementById('live-dot').style.background = "#00ff9d";
        document.getElementById('live-dot').style.boxShadow = "0 0 8px #00ff9d";
        runLivePulse(); autoRefreshTimer = setInterval(runLivePulse, 120000);
    } else {
        document.getElementById('live-dot').style.background = "#333";
        document.getElementById('live-dot').style.boxShadow = "none";
        clearInterval(autoRefreshTimer);
    }
}

async function runLivePulse() {
    const btn = document.querySelector('#main-action-btn');
    btn.innerText = "UPDATING...";
    try {
        const res = await fetch('/api/dmr/live', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ 
                symbol: "BTCUSDT", 
                session_mode: document.getElementById('sessionMode').value,
                manual_session_id: document.getElementById('manualSessionId').value 
            })
        });
        const data = await res.json();
        if(data.status === "ERROR") return;
        lastPacket = data.battlebox;
        
        // WAR MAP
        const wm = data.battlebox.war_map_context || {};
        document.getElementById('wm-lean').innerText = wm.lean || "--";
        document.getElementById('wm-lean').style.color = wm.lean === "BULLISH" ? "#00ff9d" : (wm.lean === "BEARISH" ? "#ef4444" : "#fff");
        document.getElementById('wm-phase').innerText = wm.phase || "--";
        document.getElementById('wm-note').innerText = wm.note || "--";
        
        const camp = data.battlebox.war_map_campaign || {};
        document.getElementById('wm-camp-status').innerText = camp.status || "NOT ARMED";
        document.getElementById('wm-camp-note').innerText = camp.note || "--";

        // SESSION BATTLE
        const sb = data.battlebox.session_battle || {};
        document.getElementById('session-name').innerText = data.battlebox.session?.name || "--";
        
        const action = sb.action || "HOLD FIRE";
        const elAction = document.getElementById('sb-action');
        elAction.innerText = action;
        
        if(action === "GREENLIGHT") elAction.style.color = "#00ff9d";
        else if(action === "PREPARE") elAction.style.color = "#ffcc00";
        else elAction.style.color = "#444";
        
        document.getElementById('sb-reason').innerText = sb.reason || "--";
        document.getElementById('live-price').innerText = data.price.toFixed(2);
        
        document.getElementById('sb-perm').innerText = sb.permission?.status || "NONE";
        document.getElementById('sb-perm').style.color = sb.permission?.status === "EARNED" ? "#00ff9d" : "#666";
        
        const acc = sb.acceptance_progress || {count:0};
        document.getElementById('sb-accept').innerText = `${acc.count || 0}/${acc.required || 2}`;
        
        const loc = sb.location || {};
        document.getElementById('sb-loc').innerText = `${loc.relative_to_triggers || '-'} | ${loc.relative_to_value || '-'}`;

        // EXECUTION GATES (LOCKED VS PREVIEW)
        const exec = sb.execution || {};
        const levels = exec.levels || {};
        const gatesMode = exec.gates_mode || "PREVIEW";
        const pauseState = exec.pause_state || "NONE";

        const structureText = pauseState === "CONFIRMED" ? "STRUCTURE CONFIRMED" : (pauseState === "FORMING" ? "STRUCTURE FORMING" : "NO STRUCTURE YET");
        document.getElementById('sb-gates-mode').innerText = (gatesMode === "LOCKED") ? `LOCKED • ${structureText}` : `PREVIEW (FLOATING) • ${structureText}`;

        const gateBox = document.getElementById('sb-prepare-box');
        if (gatesMode === "LOCKED") {
            gateBox.style.opacity = "1";
            gateBox.style.borderColor = "var(--primary)";
        } else {
            gateBox.style.opacity = "0.65";
            gateBox.style.borderColor = "#224422";
        }

        document.getElementById('sb-fail-line').innerText = (levels.failure ? levels.failure.toFixed(2) : "--");
        document.getElementById('sb-cont-line').innerText = (levels.continuation ? levels.continuation.toFixed(2) : "--");
        
        // LEVELS
        const l = data.battlebox.levels || {};
        document.getElementById('val-dr').innerText = l.daily_resistance?.toFixed(2) || "---";
        document.getElementById('val-bo').innerText = l.breakout_trigger?.toFixed(2) || "---";
        document.getElementById('val-bd').innerText = l.breakdown_trigger?.toFixed(2) || "---";
        document.getElementById('val-ds').innerText = l.daily_support?.toFixed(2) || "---";
        
        // STRATEGIES (Drawer)
        const strats = data.battlebox.strategies_summary || [];
        const stratList = document.getElementById('strat-list');
        if(strats.length > 0) {
            stratList.innerHTML = strats.map(s => `
                <div style="margin-bottom:8px; padding:8px; background:#111; border-left:3px solid #333;">
                    <div style="font-weight:bold; color:#fff; font-size:0.8rem;">${s.name}</div>
                    <div style="font-size:0.7rem; color:#888;">${s.status} - ${s.msg}</div>
                </div>
            `).join('');
        } else {
            stratList.innerHTML = "No strategies active.";
        }
        
    } catch(e) { console.error(e); } 
    finally { btn.innerText = "UPDATE INTEL"; }
}

function copyTraderBrief() {
    if(!lastPacket) return;
    const brief = {
        "context": lastPacket.war_map_context,
        "session": lastPacket.session_battle,
        "levels": lastPacket.levels
    };
    navigator.clipboard.writeText(JSON.stringify(brief, null, 2));
    alert("Trader Brief Copied.");
}

function copyBattleBox() {
    if(!lastPacket) return;
    navigator.clipboard.writeText(JSON.stringify(lastPacket, null, 2));
    alert("Full Packet Copied.");
}
</script>
{% endblock %}