{% extends "base.html" %}

{% block title %}Kabroda | Battle Control{% endblock %}

{% block content %}
<div class="app-container" style="max-width: 1400px; margin: 0 auto;">
    
    <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 30px; border-bottom: 1px solid #222; padding-bottom: 20px;">
        <div>
            <h1 style="font-size: 1.8rem; margin: 0; color: #fff; letter-spacing: -1px;">BATTLE CONTROL</h1>
            <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">War Map Context & Session Execution</div>
        </div>
        <div style="display: flex; gap: 15px; align-items: center;">
            <div style="display: flex; align-items: center; gap: 8px; margin-right: 15px; background: #111; padding: 5px 10px; border: 1px solid #333; border-radius: 4px;">
                <input type="checkbox" id="autoRefreshToggle" onchange="toggleAutoRefresh()" style="cursor: pointer;">
                <label for="autoRefreshToggle" style="font-size: 0.7rem; color: #888; cursor: pointer; font-weight: bold;">LIVE LINK (2m)</label>
                <div id="live-dot" style="width: 8px; height: 8px; background: #333; border-radius: 50%;"></div>
            </div>
            
            <div class="input-group" style="margin:0;">
                <select id="sessionMode" onchange="toggleManualSession()" class="cyber-select">
                    <option value="AUTO">AUTO (Dominant)</option>
                    <option value="MANUAL">MANUAL OVERRIDE</option>
                </select>
                <select id="manualSessionId" class="cyber-select" style="display:none; margin-left:5px;">
                    <option value="us_ny_futures">NY Futures</option>
                    <option value="eu_london">London</option>
                    <option value="asia_tokyo">Tokyo</option>
                </select>
            </div>
            <button onclick="runLivePulse()" class="cyber-btn-primary" id="main-action-btn" style="height: 42px; align-self: flex-end;">UPDATE INTEL</button>
        </div>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
        
        <div class="cyber-card" style="border-left: 4px solid #8b5cf6;"> <div class="card-header" style="color:#a78bfa;">WAR MAP (GLOBAL CONTEXT)</div>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                <div>
                    <div style="font-size: 0.8rem; color: #888;">LEAN</div>
                    <div id="wm-lean" style="font-size: 2rem; font-weight: 900; color: #fff;">--</div>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 0.8rem; color: #888;">PHASE</div>
                    <div id="wm-phase" style="font-size: 2rem; font-weight: 900; color: #fff;">--</div>
                </div>
            </div>
            
            <div id="wm-note" style="font-size: 0.9rem; color: #ccc; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #333;">--</div>
            
            <div style="background: #1a1a1a; padding: 15px; border-radius: 4px;">
                <div style="font-size: 0.7rem; color: #888; letter-spacing: 1px;">CAMPAIGN (BIG TRADE)</div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 5px;">
                    <div id="wm-camp-status" style="font-size: 1.2rem; font-weight: bold; color: #666;">NOT ARMED</div>
                    <div id="wm-camp-note" style="font-size: 0.8rem; color: #666;">--</div>
                </div>
            </div>
        </div>

        <div class="cyber-card" style="border-left: 4px solid #3b82f6;"> <div class="card-header" style="color:#60a5fa;">SESSION BATTLE (EXECUTION)</div>
            
            <div style="text-align: center; padding: 20px; background: #000; border: 1px solid #333; border-radius: 4px; margin-bottom: 20px;">
                <div style="font-size: 0.8rem; color: #888;">CURRENT ACTION</div>
                <div id="sb-action" style="font-size: 3rem; font-weight: 900; color: #444;">HOLD FIRE</div>
            </div>
            
            <div id="sb-reason" style="text-align: center; color: #ccc; margin-bottom: 20px; font-size: 1rem;">Waiting for data...</div>

            <div id="sb-prepare-box" style="display: none; background: #111; padding: 15px; border: 1px solid #333;">
                <div style="font-size: 0.7rem; color: #888; margin-bottom: 10px; text-align: center;">PAUSE LEVELS</div>
                <div style="display: flex; justify-content: space-between;">
                    <div style="text-align: left;">
                        <div style="font-size: 0.7rem; color: #ef4444;">FAILURE LINE</div>
                        <div id="sb-fail-line" style="font-family: monospace; font-size: 1.2rem; color: #fff;">--</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 0.7rem; color: #00ff9d;">CONTINUATION</div>
                        <div id="sb-cont-line" style="font-family: monospace; font-size: 1.2rem; color: #fff;">--</div>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #222; display: flex; justify-content: space-between; font-size: 0.8rem;">
                <span style="color: #666;">PERMISSION:</span>
                <span id="sb-perm" style="color: #fff; font-weight: bold;">--</span>
            </div>
        </div>

    </div>
    
    <div style="margin-top: 30px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
        <div class="struct-card"><span>Daily Res</span><span id="val-dr" class="val">---</span></div>
        <div class="struct-card"><span style="color:#00ff9d;">Breakout</span><span id="val-bo" class="val">---</span></div>
        <div class="struct-card"><span style="color:#ef4444;">Breakdown</span><span id="val-bd" class="val">---</span></div>
        <div class="struct-card"><span>Daily Sup</span><span id="val-ds" class="val">---</span></div>
    </div>
    
    <div style="margin-top: 20px; text-align: center;">
        <button onclick="copyBattleBox()" class="cyber-btn-sec" style="padding: 15px 30px;">COPY FULL INTEL PACKET</button>
    </div>

</div>

<style>
:root { --bg: #0a0a0a; --card: #111; }
body { background-color: var(--bg); font-family: 'Inter', sans-serif; }
.cyber-card { background: var(--card); border: 1px solid #222; padding: 20px; border-radius: 4px; }
.card-header { font-size: 0.8rem; letter-spacing: 1px; margin-bottom: 20px; font-weight: bold; }
.struct-card { background: #111; border: 1px solid #333; padding: 10px; display: flex; justify-content: space-between; font-size: 0.8rem; color: #888; }
.struct-card .val { color: #fff; font-family: monospace; font-weight: bold; }
.cyber-btn-primary { background: #00ff9d; color: #000; border: none; font-weight: 800; letter-spacing: 1px; cursor: pointer; padding: 0 20px; }
.cyber-btn-sec { background: #222; color: #fff; border: 1px solid #444; font-weight: 600; cursor: pointer; }
.cyber-select { background: #000; color: #fff; border: 1px solid #333; padding: 10px; font-family: monospace; cursor: pointer; }
</style>

<script>
let lastPacket = null;
let autoRefreshTimer = null;

function toggleAutoRefresh() {
    const isActive = document.getElementById('autoRefreshToggle').checked;
    const dot = document.getElementById('live-dot');
    if(isActive) {
        dot.style.background = "#00ff9d"; dot.style.boxShadow = "0 0 8px #00ff9d";
        runLivePulse(); autoRefreshTimer = setInterval(runLivePulse, 120000);
    } else {
        dot.style.background = "#333"; dot.style.boxShadow = "none";
        clearInterval(autoRefreshTimer);
    }
}

function toggleManualSession() {
    const mode = document.getElementById('sessionMode').value;
    document.getElementById('manualSessionId').style.display = (mode === 'MANUAL') ? 'inline-block' : 'none';
}

async function runLivePulse() {
    const btn = document.querySelector('#main-action-btn');
    btn.innerText = "UPDATING...";
    
    try {
        const res = await fetch('/api/dmr/live', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ 
                symbol: "BTCUSDT", 
                session_mode: document.getElementById('sessionMode').value,
                manual_session_id: document.getElementById('manualSessionId').value 
            })
        });
        const data = await res.json();
        if(data.status === "ERROR") return;
        lastPacket = data.battlebox;
        
        // WAR MAP
        const wm = data.battlebox.war_map || {};
        document.getElementById('wm-lean').innerText = wm.lean || "--";
        document.getElementById('wm-lean').style.color = wm.lean === "BULLISH" ? "#00ff9d" : (wm.lean === "BEARISH" ? "#ef4444" : "#fff");
        document.getElementById('wm-phase').innerText = wm.phase || "--";
        document.getElementById('wm-note').innerText = wm.note || "--";
        
        if(wm.campaign && wm.campaign.status === "ARMING") {
            document.getElementById('wm-camp-status').innerText = "ARMING";
            document.getElementById('wm-camp-status').style.color = "#ffcc00";
            document.getElementById('wm-camp-note').innerText = wm.campaign.note;
        } else {
            document.getElementById('wm-camp-status').innerText = "NOT ARMED";
            document.getElementById('wm-camp-status').style.color = "#666";
            document.getElementById('wm-camp-note').innerText = "";
        }

        // SESSION BATTLE
        const sb = data.battlebox.session_battle || {};
        const action = sb.action || "HOLD FIRE";
        const elAction = document.getElementById('sb-action');
        elAction.innerText = action;
        
        if(action === "GREENLIGHT") elAction.style.color = "#00ff9d";
        else if(action === "PREPARE") elAction.style.color = "#ffcc00";
        else elAction.style.color = "#444";
        
        document.getElementById('sb-reason').innerText = sb.reason || "--";
        document.getElementById('sb-perm').innerText = sb.permission ? `${sb.permission.status} (${sb.permission.side})` : "--";
        
        // PREPARE LEVELS
        if(action === "PREPARE" && sb.execution && sb.execution.levels) {
            document.getElementById('sb-prepare-box').style.display = "block";
            document.getElementById('sb-fail-line').innerText = sb.execution.levels.failure.toFixed(2);
            document.getElementById('sb-cont-line').innerText = sb.execution.levels.continuation.toFixed(2);
        } else {
            document.getElementById('sb-prepare-box').style.display = "none";
        }
        
        // STRUCTURE
        const l = data.levels || {};
        document.getElementById('val-dr').innerText = l.daily_resistance?.toFixed(2) || "---";
        document.getElementById('val-bo').innerText = l.breakout_trigger?.toFixed(2) || "---";
        document.getElementById('val-bd').innerText = l.breakdown_trigger?.toFixed(2) || "---";
        document.getElementById('val-ds').innerText = l.daily_support?.toFixed(2) || "---";
        
    } catch(e) { console.error(e); } 
    finally { btn.innerText = "UPDATE INTEL"; }
}

function copyBattleBox() {
    if(!lastPacket) return;
    navigator.clipboard.writeText(JSON.stringify(lastPacket, null, 2));
    alert("Full Intel Packet Copied.");
}
</script>
{% endblock %}