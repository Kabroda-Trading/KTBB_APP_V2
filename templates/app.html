{% extends "base.html" %}
{% block content %}

<div class="shell" style="padding-top:20px; padding-bottom:40px;">

  <div class="text-center" style="margin-bottom:28px;">
    <h1>BattleBox Suite</h1>
    <p class="muted">
      Logged in as <strong style="color:var(--accent-primary)">{{ user.email }}</strong>
      • {{ user.plan_label }}
    </p>
  </div>

  <!-- Step 1 -->
  <div class="card" style="margin-bottom:18px;">
    <h3>1) Calibrate Levels</h3>
    <p class="muted" style="margin-bottom:18px; max-width:760px;">
      Generate today’s battlefield levels. Then copy levels into TradingView, or copy the BattleBox payload to the GPT.
    </p>

    <div class="row" style="align-items: flex-end; gap: 16px;">
      <div style="flex: 1; max-width: 320px;">
        <label class="label" style="margin-bottom:8px; display:block;">Target Asset</label>
        <select id="symbol" class="input" style="cursor:pointer;">
          <option value="BTCUSDT">BTC (Bitcoin)</option>
          <option value="ETHUSDT">ETH (Ethereum)</option>
          <option value="SOLUSDT">SOL (Solana)</option>
        </select>
      </div>

      <div style="flex: 0 0 auto;">
        <button id="levelsBtn" class="btn primary" onclick="calibrateBattlefield()" style="min-width:190px;">
          Calibrate Levels
        </button>
      </div>
    </div>

    <div id="status" class="muted" style="margin-top:14px; font-size:13px; border-top:1px solid rgba(255,255,255,0.05); padding-top:12px;">
      <span style="color:var(--accent-primary)">●</span> System Ready. Awaiting command.
    </div>
  </div>

  <!-- Step 2 -->
  <div class="card" style="margin-bottom:18px;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:14px;">
      <h3>Battlefield Levels</h3>
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button id="tvCopyBtn" class="btn" onclick="copyForTV()" style="display:none; font-size:13px; padding:8px 14px; border-color:var(--accent-primary);">
          Copy for TradingView
        </button>
        <button id="copyGptBtn" class="btn" onclick="copyForGPT()" style="display:none; font-size:13px; padding:8px 14px;">
          Copy for BattleBox GPT
        </button>
        <a id="openGptLink" class="btn" style="display:none; font-size:13px; padding:8px 14px;" href="#" target="_blank" rel="noopener">
          Open BattleBox GPT
        </a>
      </div>
    </div>

    <div style="display:flex; flex-direction:column; gap: 14px;">

      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
        <div style="background:rgba(239, 68, 68, 0.10); border:1px solid rgba(239, 68, 68, 0.20); padding:14px; border-radius:12px; text-align:center;">
          <div class="label" style="color:#f87171; font-size:12px; text-transform:uppercase;">Daily Resistance</div>
          <div id="lv_dr" style="font-size:22px; font-weight:800; color:#fff;">—</div>
        </div>
        <div style="background:rgba(16, 185, 129, 0.10); border:1px solid rgba(16, 185, 129, 0.20); padding:14px; border-radius:12px; text-align:center;">
          <div class="label" style="color:#34d399; font-size:12px; text-transform:uppercase;">Breakout Trigger</div>
          <div id="lv_bo" style="font-size:22px; font-weight:800; color:#fff;">—</div>
        </div>
      </div>

      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
        <div style="background:rgba(168, 85, 247, 0.10); border:1px solid rgba(168, 85, 247, 0.20); padding:14px; border-radius:12px; text-align:center;">
          <div class="label" style="color:#c084fc; font-size:12px; text-transform:uppercase;">Breakdown Trigger</div>
          <div id="lv_bd" style="font-size:22px; font-weight:800; color:#fff;">—</div>
        </div>
        <div style="background:rgba(59, 130, 246, 0.10); border:1px solid rgba(59, 130, 246, 0.20); padding:14px; border-radius:12px; text-align:center;">
          <div class="label" style="color:#60a5fa; font-size:12px; text-transform:uppercase;">Daily Support</div>
          <div id="lv_ds" style="font-size:22px; font-weight:800; color:#fff;">—</div>
        </div>
      </div>

      <div style="display:flex; justify-content:space-between; gap: 12px; background:rgba(255,255,255,0.03); padding:12px 18px; border-radius:12px; border:1px solid rgba(255,255,255,0.05); flex-wrap:wrap;">
        <span class="muted" style="font-size:13px;">30m High: <strong id="lv_30h" style="color:#e2e8f0; margin-left:6px;">—</strong></span>
        <span class="muted" style="font-size:13px;">30m Low: <strong id="lv_30l" style="color:#e2e8f0; margin-left:6px;">—</strong></span>
      </div>

      <div class="muted" style="font-size:13px; margin-top:4px;">
        <strong style="color:#e5e7eb;">Workflow:</strong>
        1) Calibrate → 2) Copy for TradingView → 3) Copy for GPT → 4) Open GPT → Paste → Execute.
      </div>

    </div>
  </div>

</div>

<script>
  const USER_SESSION_TZ = {{ (user.session_tz or "UTC")|tojson }};
  const BATTLEBOX_GPT_URL = "https://chatgpt.com/g/g-6949c388d8c48191833b3c35af02d809-kabroda-trading-battlebox";

  let _lastDmrPayload = null;

  function fmt(x){
    if (x === null || x === undefined) return "—";
    const n = parseFloat(x);
    if (isNaN(n)) return String(x);
    return n.toLocaleString(undefined, {minimumFractionDigits: 1, maximumFractionDigits: 2});
  }

  async function fetchJsonSafe(url, options){
    const r = await fetch(url, options);
    const text = await r.text();
    let data = {};
    try { data = text ? JSON.parse(text) : {}; }
    catch { data = { detail: text || "Non-JSON response from server." }; }
    return { r, data };
  }

  function renderLevelsOnly(payload){
    _lastDmrPayload = payload;

    const levels = payload.levels || {};
    const r30 = payload.range_30m || {};

    document.getElementById("lv_ds").textContent  = fmt(levels.daily_support);
    document.getElementById("lv_dr").textContent  = fmt(levels.daily_resistance);
    document.getElementById("lv_bo").textContent  = fmt(levels.breakout_trigger);
    document.getElementById("lv_bd").textContent  = fmt(levels.breakdown_trigger);
    document.getElementById("lv_30h").textContent = fmt(r30.high);
    document.getElementById("lv_30l").textContent = fmt(r30.low);

    document.getElementById("tvCopyBtn").style.display = "inline-flex";
    document.getElementById("copyGptBtn").style.display = "inline-flex";

    const glink = document.getElementById("openGptLink");
    glink.style.display = "inline-flex";
    glink.href = BATTLEBOX_GPT_URL;
  }

  async function calibrateBattlefield(){
    const symEl = document.getElementById("symbol");
    const status = document.getElementById("status");
    const levelsBtn = document.getElementById("levelsBtn");

    const sym = symEl ? symEl.value : "BTCUSDT";

    status.textContent = "Calibrating levels…";
    levelsBtn.disabled = true;

    try{
      const { r, data } = await fetchJsonSafe("/api/dmr/run-raw", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ symbol: sym }),
        credentials: "same-origin"
      });

      if (!r.ok){
        const msg = data.detail || data.error || `Failed (${r.status})`;
        status.textContent = "Calibration Failed: " + msg;
        alert(msg);
        return;
      }

      renderLevelsOnly(data);
      status.textContent = "Battlefield calibrated ✅ (Levels Ready)";
    }catch(e){
      status.textContent = "System Error";
      alert(e && e.message ? e.message : String(e));
    }finally{
      levelsBtn.disabled = false;
    }
  }

  async function copyForTV(){
    if (!_lastDmrPayload || !_lastDmrPayload.levels) return;

    const l = _lastDmrPayload.levels;
    const r = _lastDmrPayload.range_30m || {};

    // BO, BD, R, S, 30H, 30L
    const text =
      `${parseFloat(l.breakout_trigger).toFixed(2)},` +
      `${parseFloat(l.breakdown_trigger).toFixed(2)},` +
      `${parseFloat(l.daily_resistance).toFixed(2)},` +
      `${parseFloat(l.daily_support).toFixed(2)},` +
      `${parseFloat(r.high).toFixed(2)},` +
      `${parseFloat(r.low).toFixed(2)}`;

    try {
      await navigator.clipboard.writeText(text);
      const btn = document.getElementById("tvCopyBtn");
      const originalText = btn.textContent;
      btn.textContent = "Copied! ✅";
      setTimeout(() => btn.textContent = originalText, 1600);
    } catch (err) {
      alert("Could not copy: " + err);
    }
  }

  function buildGptContractV1(raw){
    const levels = raw.levels || {};
    const r30 = raw.range_30m || {};

    return {
      contract_version: "1.0",
      generated_at: new Date().toISOString(),

      date: raw.date || null,
      symbol: raw.symbol || "BTCUSDT",
      session_tz: raw.session_tz || USER_SESSION_TZ || "UTC",
      last_price: raw.last_price ?? null,

      levels: {
        daily_support: levels.daily_support ?? null,
        daily_resistance: levels.daily_resistance ?? null,
        breakout_trigger: levels.breakout_trigger ?? null,
        breakdown_trigger: levels.breakdown_trigger ?? null
      },

      range_30m: {
        high: r30.high ?? null,
        low:  r30.low  ?? null
      },

      profiles: raw.profiles || {},
      htf_shelves: raw.htf_shelves || { resistance: [], support: [] },
      intraday_shelves: raw.intraday_shelves || { breakout_side: [], breakdown_side: [] },
      trade_logic: raw.trade_logic || null,

      events: raw.events || [],
      news: raw.news || [],
      sentiment: raw.sentiment ?? null,

      source: raw.source || { app: "kabroda_site", endpoint: "/api/dmr/run-raw" }
    };
  }

  async function copyForGPT(){
    if (!_lastDmrPayload) return;

    const obj = buildGptContractV1(_lastDmrPayload);
    const text = JSON.stringify(obj, null, 2);

    try {
      await navigator.clipboard.writeText(text);
      const btn = document.getElementById("copyGptBtn");
      const orig = btn.textContent;
      btn.textContent = "Copied! ✅";
      setTimeout(()=>btn.textContent = orig, 1600);
    } catch (err) {
      alert("Could not copy: " + err);
    }
  }
</script>

{% endblock %}
