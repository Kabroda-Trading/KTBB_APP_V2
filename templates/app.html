{% extends "base.html" %}
{% block content %}

<h1>Kabroda BattleBox Suite</h1>
<p class="muted">Logged in as {{ user.email }} • {{ tier_label }}</p>

<div class="card">
  <h3>Run Daily Market Review</h3>
  <p class="muted" style="margin-top:6px;">
    Generate today’s structure levels, opening range, HTF shelves, and a clean narrative.
  </p>

  <div class="row" style="gap:10px; align-items:center;">
    <select id="symbol" style="flex:1;">
      <option value="BTC">BTC</option>
      <option value="ETH">ETH</option>
    </select>

    <button class="btn primary" id="runBtn" onclick="runDMR()">Generate Review</button>
    <a class="btn" href="/account">Account</a>
  </div>

  <div id="status" class="muted" style="margin-top:10px;">Idle</div>
</div>

<div id="reportWrap" style="display:none; margin-top:16px;">
  <div class="grid">
    <div class="card">
      <h3>Key Levels</h3>
      <ul id="levelsList"></ul>
    </div>

    <div class="card">
      <h3>30m Opening Range</h3>
      <div id="orBox" class="lead"></div>
      <div class="muted" id="orMeta" style="margin-top:6px;"></div>
    </div>

    <div class="card">
      <h3>HTF Shelves</h3>
      <div id="htfBox"></div>
    </div>
  </div>

  <div class="card" style="margin-top:16px;">
    <div class="row" style="justify-content:space-between; align-items:center;">
      <h3 style="margin:0;">Daily Market Review</h3>
      <div class="muted" id="dmrMeta"></div>
    </div>

    <div id="dmrNarrative" class="dmr-box"></div>

    <div class="row" style="margin-top:12px; gap:10px;">
      <button class="btn primary" id="toggleYamlBtn" onclick="toggleYaml()" style="display:none;">Show YAML</button>
      <button class="btn" id="copyYamlBtn" onclick="copyYaml()" style="display:none;">Copy YAML</button>
      <div class="muted" id="copyStatus" style="margin-left:auto;"></div>
    </div>

    <pre id="dmrYaml" class="pre" style="white-space:pre-wrap; display:none; margin-top:10px;"></pre>
  </div>

  <div class="card" style="margin-top:16px;">
    <h3>Kabroda AI Coach</h3>

    {% if is_elite %}
      <div class="muted" style="margin-top:6px;">
        Ask questions anchored to today’s levels (Elite only).
      </div>

      <div id="chat" class="chat-shell">
        <div id="chatLog" class="chat-log">
          <div class="chat-msg chat-assistant">
            <div class="chat-bubble">
              Start with: “What’s the primary plan if we break the breakout trigger?”
            </div>
          </div>
        </div>

        <div class="row" style="gap:10px; margin-top:10px;">
          <input id="chatInput" placeholder="Ask Kabroda…" style="flex:1;" onkeydown="if(event.key==='Enter'){ sendChat(); }" />
          <button class="btn primary" id="sendBtn" onclick="sendChat()">Send</button>
        </div>

        <div class="muted" id="chatHint" style="margin-top:8px;"></div>
      </div>
    {% else %}
      <div class="muted" style="margin-top:8px;">
        Upgrade to Elite to unlock the AI Coach chat.
        <div style="margin-top:10px;">
          <a class="btn primary" href="/pricing">See Pricing</a>
        </div>
      </div>
    {% endif %}
  </div>
</div>

<style>
  .btn { background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.12); }
  .btn:hover { background: rgba(255,255,255,.10); }
  .btn.primary { background: #60a5fa; border-color: rgba(96,165,250,.45); color:#0b1220; font-weight: 700; }
  .btn.primary:hover { filter: brightness(1.05); }

  .dmr-box{
    margin-top:12px;
    padding:14px;
    border-radius:16px;
    background: rgba(0,0,0,.28);
    border: 1px solid rgba(255,255,255,.08);
    color: rgba(255,255,255,.92);
    line-height: 1.55;
    white-space: pre-line;
    font-size: 15px;
  }

  .chat-log{
    max-height: 320px;
    overflow:auto;
    padding: 10px;
    border-radius: 16px;
    background: rgba(0,0,0,.25);
    border: 1px solid rgba(255,255,255,.08);
  }
  .chat-msg{ display:flex; margin: 10px 0; }
  .chat-user{ justify-content:flex-end; }
  .chat-assistant{ justify-content:flex-start; }
  .chat-bubble{
    max-width: 78%;
    padding: 10px 12px;
    border-radius: 16px;
    border: 1px solid rgba(255,255,255,.10);
    background: rgba(255,255,255,.06);
    white-space: pre-wrap;
  }
  .chat-user .chat-bubble{
    background: rgba(96, 165, 250, .18);
    border-color: rgba(96,165,250,.35);
  }
</style>

<script>
const IS_ELITE = {{ "true" if is_elite else "false" }};
const USER_SESSION_TZ = {{ (user.session_tz or "UTC")|tojson }};

let _lastYaml = "";
let _lastDMR = null; // ✅ store the most recent DMR payload for Elite chat context

// Auto-set timezone once if still UTC
async function ensureUserTimezone(){
  try{
    const guessed = Intl.DateTimeFormat().resolvedOptions().timeZone;
    if (!guessed) return;
    const current = (USER_SESSION_TZ || "").trim();
    const isUnset = (!current || current.toUpperCase() === "UTC");
    if (!isUnset) return;
    if (guessed === "UTC") return;

    const body = new URLSearchParams();
    body.set("tz", guessed);

    await fetch("/account/session-timezone", {
      method: "POST",
      headers: {"Content-Type":"application/x-www-form-urlencoded"},
      body: body.toString(),
      credentials: "same-origin",
      redirect: "follow"
    });
  }catch(e){}
}
document.addEventListener("DOMContentLoaded", ensureUserTimezone);

function fmt(x){
  if (x === null || x === undefined) return "—";
  if (typeof x === "number") return x.toLocaleString(undefined, {maximumFractionDigits: 1});
  return String(x);
}

function normalizeReportText(data){
  const reportVal = (data.report_text !== undefined) ? data.report_text : data.report;
  if (typeof reportVal === "string") return reportVal;
  if (reportVal && typeof reportVal.full_text === "string") return reportVal.full_text;
  if (reportVal && typeof reportVal.text === "string") return reportVal.text;
  return JSON.stringify(reportVal ?? "(No report returned.)", null, 2);
}

function splitNarrativeAndYaml(reportText){
  const idx = reportText.indexOf("```yaml");
  if (idx !== -1){
    return {
      narrative: reportText.slice(0, idx).trim(),
      yaml: reportText.slice(idx).trim()
    };
  }
  return { narrative: reportText.trim(), yaml: "" };
}

function setChatHint(msg){
  const el = document.getElementById("chatHint");
  if (!el) return;
  el.textContent = msg || "";
}

async function runDMR(){
  const sym = document.getElementById("symbol").value;
  const status = document.getElementById("status");
  const btn = document.getElementById("runBtn");

  status.textContent = "Running…";
  btn.disabled = true;

  try{
    const r = await fetch("/api/dmr/run-auto-ai", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({symbol: sym}),
      credentials: "same-origin"
    });

    const data = await r.json();

    if (!r.ok){
      const msg = data.detail || data.error || "Request failed";
      status.textContent = "Error";
      alert(msg);
      return;
    }

    _lastDMR = data;              // ✅ critical: keep the DMR payload for chat anchoring
    renderDMR(data);
    setChatHint("");              // clear any “run DMR first” warning
    status.textContent = "Done ✅";
  }catch(err){
    status.textContent = "Request failed";
    alert(String(err));
  }finally{
    btn.disabled = false;
  }
}

function renderDMR(data){
  document.getElementById("reportWrap").style.display = "block";
  document.getElementById("copyStatus").textContent = "";

  const levels = data.levels || {};
  const ul = document.getElementById("levelsList");
  ul.innerHTML = "";
  ul.innerHTML += `<li><strong>Daily Resistance:</strong> ${fmt(levels.daily_resistance)}</li>`;
  ul.innerHTML += `<li><strong>Daily Support:</strong> ${fmt(levels.daily_support)}</li>`;
  ul.innerHTML += `<li><strong>Breakout Trigger:</strong> ${fmt(levels.breakout_trigger)}</li>`;
  ul.innerHTML += `<li><strong>Breakdown Trigger:</strong> ${fmt(levels.breakdown_trigger)}</li>`;

  const r30 = data.range_30m || {};
  document.getElementById("orBox").innerHTML = `
    High: <strong>${fmt(r30.high)}</strong><br>
    Low: <strong>${fmt(r30.low)}</strong>
  `;
  document.getElementById("orMeta").textContent =
    (typeof r30.high === "number" && typeof r30.low === "number") ? `Range: ${fmt(r30.high - r30.low)}` : "";

  const htf = data.htf_shelves || {};
  const res = (htf.resistance || []).map(x => `• ${x.tf}: ${fmt(x.level)}${x.primary ? " (primary)" : ""}`).join("\n");
  const sup = (htf.support || []).map(x => `• ${x.tf}: ${fmt(x.level)}${x.primary ? " (primary)" : ""}`).join("\n");
  document.getElementById("htfBox").innerHTML = `
    <div><strong>Resistance</strong><pre class="pre" style="white-space:pre-wrap;">${res || "—"}</pre></div>
    <div><strong>Support</strong><pre class="pre" style="white-space:pre-wrap;">${sup || "—"}</pre></div>
  `;

  const meta = [];
  if (data.symbol) meta.push(data.symbol);
  if (data.date) meta.push(data.date);
  document.getElementById("dmrMeta").textContent = meta.join(" • ");

  const reportText = normalizeReportText(data);
  const parts = splitNarrativeAndYaml(reportText);
  document.getElementById("dmrNarrative").textContent = parts.narrative || "(No narrative returned.)";

  _lastYaml = parts.yaml || "";
  const toggleBtn = document.getElementById("toggleYamlBtn");
  const copyBtn = document.getElementById("copyYamlBtn");
  const yamlPre = document.getElementById("dmrYaml");

  if (_lastYaml){
    toggleBtn.style.display = "inline-block";
    copyBtn.style.display = "inline-block";
    yamlPre.textContent = _lastYaml;
    yamlPre.style.display = "none";
    toggleBtn.textContent = "Show YAML";
  } else {
    toggleBtn.style.display = "none";
    copyBtn.style.display = "none";
    yamlPre.style.display = "none";
    yamlPre.textContent = "";
  }
}

function toggleYaml(){
  const yamlPre = document.getElementById("dmrYaml");
  const btn = document.getElementById("toggleYamlBtn");
  if (yamlPre.style.display === "none"){
    yamlPre.style.display = "block";
    btn.textContent = "Hide YAML";
  } else {
    yamlPre.style.display = "none";
    btn.textContent = "Show YAML";
  }
}

async function copyYaml(){
  try{
    await navigator.clipboard.writeText(_lastYaml || "");
    document.getElementById("copyStatus").textContent = "Copied ✅";
    setTimeout(()=>document.getElementById("copyStatus").textContent="", 1400);
  }catch(e){
    document.getElementById("copyStatus").textContent = "Copy failed";
  }
}

/* Elite chat */
function addChat(role, text){
  const log = document.getElementById("chatLog");
  const row = document.createElement("div");
  row.className = "chat-msg " + (role === "user" ? "chat-user" : "chat-assistant");
  const bub = document.createElement("div");
  bub.className = "chat-bubble";
  bub.textContent = text;
  row.appendChild(bub);
  log.appendChild(row);
  log.scrollTop = log.scrollHeight;
}

async function sendChat(){
  if (!IS_ELITE) return;
  const sym = document.getElementById("symbol").value;
  const input = document.getElementById("chatInput");
  const btn = document.getElementById("sendBtn");
  const q = (input.value || "").trim();
  if (!q) return;

  // ✅ Hard guard: require a DMR run first so the assistant is anchored
  if (!_lastDMR){
    setChatHint("Run “Generate Review” first so Kabroda can anchor to today’s levels.");
    addChat("assistant", "Please run “Generate Review” first so I can anchor my answer to today’s computed levels.");
    return;
  }

  input.value = "";
  addChat("user", q);
  btn.disabled = true;

  try{
    const r = await fetch("/api/assistant/chat", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      // ✅ this is the critical contract fix:
      // backend needs DMR context to answer anchored (and our new main.py requires it)
      body: JSON.stringify({symbol: sym, question: q, dmr: _lastDMR}),
      credentials: "same-origin"
    });
    const data = await r.json();
    if (!r.ok) throw new Error(data.detail || "Chat failed");
    addChat("assistant", data.answer || "(No answer)");
  }catch(e){
    addChat("assistant", "Error: " + (e && e.message ? e.message : String(e)));
  }finally{
    btn.disabled = false;
  }
}
</script>

{% endblock %}
