{% extends "base.html" %}
{% block content %}

<div class="container">
  <div class="hero">
    <h1>Kabroda BattleBox Suite</h1>
    <p class="muted">Generate today’s structure levels, opening range, HTF shelves, and a clean narrative.</p>
    <p class="muted">Logged in as {{ user.email }} • {{ user.plan_label }}</p>
  </div>

  <div class="card">
    <h3>Run Daily Market Review</h3>
    <p class="muted">Step 1 calibrates today’s levels. Step 2 deploys the narrative (optional).</p>

    <div class="row">
      <select id="symbol" class="input" style="flex:1;">
        <option value="BTCUSDT">BTC</option>
        <option value="ETHUSDT">ETH</option>
      </select>

      <button id="levelsBtn" class="btn primary" onclick="calibrateBattlefield()">Calibrate the Battlefield</button>
      <button id="reviewBtn" class="btn" onclick="deployDailyReview()" disabled>Deploy the Daily Review</button>

      <a class="btn" href="/account">Account</a>
    </div>

    <div id="status" class="muted" style="margin-top:10px;">Ready — calibrate levels to begin.</div>
  </div>

  <div class="card" style="margin-top:14px;">
    <h3>Daily Market Review</h3>

    <div class="grid" style="margin-top:10px;">
      <div class="pill"><span class="muted">Daily Support</span><div id="lv_ds">—</div></div>
      <div class="pill"><span class="muted">Daily Resistance</span><div id="lv_dr">—</div></div>
      <div class="pill"><span class="muted">Breakout Trigger</span><div id="lv_bo">—</div></div>
      <div class="pill"><span class="muted">Breakdown Trigger</span><div id="lv_bd">—</div></div>
      <div class="pill"><span class="muted">30m High</span><div id="lv_30h">—</div></div>
      <div class="pill"><span class="muted">30m Low</span><div id="lv_30l">—</div></div>
    </div>

    <pre id="dmrText" class="report" style="margin-top:12px; white-space:pre-wrap;">(Calibrate the Battlefield to load levels. Deploy the Daily Review when you want the narrative.)</pre>

    <div class="row" style="margin-top:10px;">
      <button id="tvCopyBtn" class="btn" onclick="copyForTV()" style="display:none;">Copy for TradingView</button>
      <button id="toggleYamlBtn" class="btn" style="display:none;" onclick="toggleYaml()">Show YAML</button>
      <button id="copyYamlBtn" class="btn" style="display:none;" onclick="copyYaml()">Copy YAML</button>
      <div id="copyStatus" class="muted" style="margin-left:10px;"></div>
    </div>

    <pre id="dmrYaml" class="report" style="display:none; margin-top:10px;"></pre>
  </div>

  {% if is_elite %}
  <div class="card" style="margin-top:14px;">
    <h3>Kabroda AI Coach</h3>
    <p class="muted">Ask questions anchored to today’s levels (Elite only).</p>

    <div id="chatLog" class="chat-log"></div>

    <div class="row" style="margin-top:10px;">
      <input id="chatInput" class="input" style="flex:1;"
             placeholder="Ask Kabroda..."
             onkeydown="if(event.key==='Enter'){sendChat()}"/>
      <button id="sendBtn" class="btn primary" onclick="sendChat()">Send</button>
    </div>
  </div>
  {% endif %}
</div>

<style>
  .container{max-width:1000px;margin:0 auto;padding:22px;}
  .hero{margin-bottom:14px;}
  .card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.10);border-radius:18px;padding:16px;}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
  .input{padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.25);color:#fff;min-width:160px;}
  .btn{padding:10px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);color:#fff;text-decoration:none;cursor:pointer;}
  .btn.primary{background:rgba(96,165,250,.25);border-color:rgba(96,165,250,.4);}
  .btn:disabled{opacity:.5;cursor:not-allowed;}
  .muted{opacity:.75;}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;}
  .pill{padding:10px;border-radius:14px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.22);}
  .report{border-radius:16px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.25);padding:12px;}
  .chat-log{max-height:320px;overflow:auto;border:1px solid rgba(255,255,255,.10);border-radius:16px;padding:10px;background:rgba(0,0,0,.18);}
  .chat-msg{display:flex;margin:8px 0;}
  .chat-user{justify-content:flex-end;}
  .chat-assistant{justify-content:flex-start;}
  .chat-bubble{max-width:80%;padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.06);white-space:pre-wrap;}
  .chat-user .chat-bubble{background:rgba(96,165,250,.18);border-color:rgba(96,165,250,.35);}
</style>

<script>
  const IS_ELITE = {{ "true" if is_elite else "false" }};
  const USER_SESSION_TZ = {{ (user.session_tz or "UTC")|tojson }};
  let _lastYaml = "";
  let _lastDmrPayload = null;

  function fmt(x){
    if (x === null || x === undefined) return "—";
    if (typeof x === "number") return x.toLocaleString(undefined, {maximumFractionDigits: 1});
    return String(x);
  }

  async function fetchJsonSafe(url, options){
    const r = await fetch(url, options);
    const text = await r.text();
    let data = {};
    try { data = text ? JSON.parse(text) : {}; }
    catch { data = { detail: text || "Non-JSON response from server." }; }
    return { r, data };
  }

  // Auto-set timezone once if still UTC
  async function ensureUserTimezone(){
    try{
      const guessed = Intl.DateTimeFormat().resolvedOptions().timeZone;
      if (!guessed) return;

      const current = (USER_SESSION_TZ || "").trim();
      const isUnset = (!current || current.toUpperCase() === "UTC");
      if (!isUnset) return;
      if (guessed === "UTC") return;

      await fetchJsonSafe("/account/session-timezone", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ timezone: guessed }),
        credentials: "same-origin",
      });
    }catch(e){}
  }
  document.addEventListener("DOMContentLoaded", ensureUserTimezone);

  function splitNarrativeAndYaml(reportText){
    const idx = reportText.indexOf("```yaml");
    if (idx !== -1){
      return { narrative: reportText.slice(0, idx).trim(), yaml: reportText.slice(idx).trim() };
    }
    return { narrative: reportText.trim(), yaml: "" };
  }

  function renderLevelsOnly(payload){
    _lastDmrPayload = payload;

    const levels = payload.levels || {};
    const r30 = payload.range_30m || {};

    document.getElementById("lv_ds").textContent  = fmt(levels.daily_support);
    document.getElementById("lv_dr").textContent  = fmt(levels.daily_resistance);
    document.getElementById("lv_bo").textContent  = fmt(levels.breakout_trigger);
    document.getElementById("lv_bd").textContent  = fmt(levels.breakdown_trigger);
    document.getElementById("lv_30h").textContent = fmt(r30.high);
    document.getElementById("lv_30l").textContent = fmt(r30.low);
  }

  function setNarrativeText(reportText){
    const parts = splitNarrativeAndYaml(reportText || "");
    document.getElementById("dmrText").textContent = parts.narrative || "(No narrative returned.)";

    _lastYaml = parts.yaml || "";
    const toggleBtn = document.getElementById("toggleYamlBtn");
    const copyBtn = document.getElementById("copyYamlBtn");
    const yamlPre = document.getElementById("dmrYaml");

    if (_lastYaml){
      toggleBtn.style.display = "inline-block";
      copyBtn.style.display = "inline-block";
      yamlPre.textContent = _lastYaml;
      yamlPre.style.display = "none";
      toggleBtn.textContent = "Show YAML";
    } else {
      toggleBtn.style.display = "none";
      copyBtn.style.display = "none";
      yamlPre.style.display = "none";
      yamlPre.textContent = "";
    }
  }

  function toggleYaml(){
    const yamlPre = document.getElementById("dmrYaml");
    const btn = document.getElementById("toggleYamlBtn");
    if (yamlPre.style.display === "none"){
      yamlPre.style.display = "block";
      btn.textContent = "Hide YAML";
    } else {
      yamlPre.style.display = "none";
      btn.textContent = "Show YAML";
    }
  }

  async function copyYaml(){
    try{
      await navigator.clipboard.writeText(_lastYaml || "");
      document.getElementById("copyStatus").textContent = "Copied ✅";
      setTimeout(()=>document.getElementById("copyStatus").textContent="", 1400);
    }catch(e){
      document.getElementById("copyStatus").textContent = "Copy failed";
    }
  }

  async function calibrateBattlefield(){
    const sym = document.getElementById("symbol").value;
    const status = document.getElementById("status");
    const levelsBtn = document.getElementById("levelsBtn");
    const reviewBtn = document.getElementById("reviewBtn");

    status.textContent = "Calibrating the battlefield…";
    levelsBtn.disabled = true;
    reviewBtn.disabled = true;

    // Clear narrative area, keep UI honest
    document.getElementById("dmrText").textContent = "(Generating levels…)";
    setNarrativeText(""); // hides YAML controls

    try{
      const { r, data } = await fetchJsonSafe("/api/dmr/run-raw", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ symbol: sym }),
        credentials: "same-origin"
      });

      if (!r.ok){
        const msg = data.detail || data.error || `Levels failed (${r.status})`;
        status.textContent = "Error";
        alert(msg);
        return;
      }

      renderLevelsOnly(data);
      status.textContent = "Battlefield calibrated ✅ (levels ready)";
      reviewBtn.disabled = false; // now allow AI
      document.getElementById("dmrText").textContent = "(Levels ready. Deploy the Daily Review when you want the narrative.)";
    }catch(e){
      status.textContent = "Request failed";
      alert(e && e.message ? e.message : String(e));
    }finally{
      levelsBtn.disabled = false;
    }
  }

  async function deployDailyReview(){
    const status = document.getElementById("status");
    const reviewBtn = document.getElementById("reviewBtn");
    const levelsBtn = document.getElementById("levelsBtn");

    if (!_lastDmrPayload){
      alert("Run 'Calibrate the Battlefield' first to generate today's levels.");
      return;
    }

    status.textContent = "Deploying the Daily Review…";
    reviewBtn.disabled = true;
    levelsBtn.disabled = true;

    const t0 = performance.now();
    const tick = setInterval(() => {
      const secs = ((performance.now() - t0) / 1000).toFixed(1);
      status.textContent = `Deploying daily review… (${secs}s)`;
    }, 250);

    try{
      const { r, data } = await fetchJsonSafe("/api/dmr/generate-ai", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        // ✅ Send raw payload back to server (no session-cookie dependence)
        body: JSON.stringify({ dmr_raw: _lastDmrPayload }),
        credentials: "same-origin"
      });

      if (!r.ok){
        const msg = data.detail || data.error || `AI failed (${r.status})`;
        status.textContent = "Error";
        alert(msg);
        return;
      }

      setNarrativeText(data.report_text || "");
      status.textContent = "Daily Review deployed ✅";
    }catch(e){
      status.textContent = "Request failed";
      alert(e && e.message ? e.message : String(e));
    }finally{
      clearInterval(tick);
      reviewBtn.disabled = false;
      levelsBtn.disabled = false;
    }
  }

  // Elite chat
  function addChat(role, text){
    const log = document.getElementById("chatLog");
    if (!log) return;
    const row = document.createElement("div");
    row.className = "chat-msg " + (role === "user" ? "chat-user" : "chat-assistant");
    const bub = document.createElement("div");
    bub.className = "chat-bubble";
    bub.textContent = text;
    row.appendChild(bub);
    log.appendChild(row);
    log.scrollTop = log.scrollHeight;
  }

  async function sendChat(){
    if (!IS_ELITE) return;

    if (!_lastDmrPayload){
      addChat("assistant", "Run 'Calibrate the Battlefield' first so I have today’s levels.");
      return;
    }

    const input = document.getElementById("chatInput");
    const btn = document.getElementById("sendBtn");
    const q = (input.value || "").trim();
    if (!q) return;

    input.value = "";
    addChat("user", q);
    btn.disabled = true;

    try{
      const { r, data } = await fetchJsonSafe("/api/ai_coach", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ message: q, dmr: _lastDmrPayload }),
        credentials: "same-origin"
      });

      if (!r.ok) throw new Error(data.detail || "Chat failed");
      addChat("assistant", data.reply || "(No answer)");
    }catch(e){
      addChat("assistant", "Error: " + (e && e.message ? e.message : String(e)));
    }finally{
      btn.disabled = false;
    }
  }
  // Add this to the <script> block in app.html

async function copyForTV(){
  if (!_lastDmrPayload || !_lastDmrPayload.levels) return;
  
  const l = _lastDmrPayload.levels;
  
  // Format: "BO: 67000 | BD: 66000 | R: 68000 | S: 65000"
  // This is clean and easy to read while pasting.
  const text = `BO: ${l.breakout_trigger} | BD: ${l.breakdown_trigger} | R: ${l.daily_resistance} | S: ${l.daily_support}`;
  
  try {
    await navigator.clipboard.writeText(text);
    const btn = document.getElementById("tvCopyBtn");
    const originalText = btn.textContent;
    btn.textContent = "Copied! ✅";
    setTimeout(() => btn.textContent = originalText, 2000);
  } catch (err) {
    alert("Could not copy: " + err);
  }
}

// UPDATE existing renderLevelsOnly function to show the button
function renderLevelsOnly(payload){
    _lastDmrPayload = payload;
    // ... (existing code setting textContent for lv_ds, lv_dr, etc.) ...
    
    // Add this line at the end:
    document.getElementById("tvCopyBtn").style.display = "inline-flex"; 
}
</script>

{% endblock %}
