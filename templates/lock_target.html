<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Kabroda | Target Lock v3.2</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&family=Rajdhani:wght@600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { 
            --bg: #020617; --panel: #1e293b; --border: #334155; 
            --cyan: #22d3ee; --green: #10b981; --red: #ef4444; --gold: #facc15; --white: #f8fafc;
            --gray: #94a3b8; --dark-gray: #475569;
        }
        body { 
            background: var(--bg); color: var(--white); font-family: 'JetBrains Mono', monospace; 
            margin: 0; padding: 15px; min-height: 100vh; box-sizing: border-box; 
        }

        /* RESPONSIVE GRID */
        .cockpit { 
            display: grid; gap: 15px; min-height: 850px;
            grid-template-columns: 320px 1fr 360px;
            grid-template-rows: auto 1fr auto; 
            grid-template-areas: "header header header" "left center right" "footer footer footer";
        }
        
        @media (max-width: 1200px) {
            .cockpit { display: flex; flex-direction: column; min-height: auto; }
        }

        .header { grid-area: header; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--border); padding-bottom: 5px; margin-bottom: 10px; }
        .panel-left { grid-area: left; }
        .panel-center { grid-area: center; background: #0b1121; }
        .panel-right { grid-area: right; }
        .footer-section { grid-area: footer; }

        .panel { background: var(--panel); border: 1px solid var(--border); border-radius: 8px; padding: 25px; display: flex; flex-direction: column; }
        .h-title { font-family: 'Rajdhani', sans-serif; font-weight: 800; font-size: 32px; color: var(--cyan); letter-spacing: 1.5px; margin: 0; text-shadow: 0 0 10px rgba(34, 211, 238, 0.2); }
        .panel-head { font-family: 'Rajdhani', sans-serif; font-weight: 800; font-size: 20px; color: var(--cyan); letter-spacing: 1px; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 5px; text-transform: uppercase; }
        .back-link { display: block; font-size: 11px; font-weight: 800; color: var(--gray); text-decoration: none; margin-bottom: 5px; letter-spacing: 1px; transition: 0.2s; }
        .back-link:hover { color: var(--white); }

        .lbl { font-size: 12px; color: #cbd5e1; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; display:block; }
        .val { font-size: 18px; font-weight: 800; color: #fff; font-family: 'JetBrains Mono'; }
        .big-price { font-size: 42px; font-weight: 800; color: #fff; font-family: 'Rajdhani'; }

        /* WIDGETS */
        .verdict-banner { background: rgba(15, 23, 42, 0.8); border: 1px solid var(--border); border-left: 6px solid var(--gray); padding: 20px; border-radius: 6px; margin-bottom: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .verdict-score { font-size: 56px; font-weight: 800; font-family: 'Rajdhani'; line-height: 1; color: #fff; }
        .verdict-status { font-size: 32px; font-weight: 800; font-family: 'Rajdhani'; text-transform: uppercase; }
        
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; flex-grow: 1; }
        .dash-card { background: #0f172a; padding: 15px; border-radius: 6px; border: 1px solid var(--border); text-align: center; display: flex; flex-direction: column; justify-content: center; }
        .gauge-bar-bg { height: 8px; background: #1e293b; position: relative; border-radius: 4px; overflow: hidden; margin-top: 8px; width: 100%; }
        .gauge-fill { height: 100%; background: var(--cyan); width: 0%; transition: width 1s; }
        
        .dash-status { font-size: 13px; font-weight: 800; padding: 4px 10px; border-radius: 4px; display: inline-block; margin-top: 5px; text-transform: uppercase; }
        .status-green { color: #fff; background: #10b981; } .status-red { color: #fff; background: #ef4444; } .status-yellow { color: #000; background: #facc15; } .status-gray { color: #cbd5e1; background: #334155; }

        .data-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px dashed var(--dark-gray); padding-bottom: 8px; }
        .btn-cp { background: var(--border); border: none; color: var(--white); padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 11px; font-weight: 700; margin-left: 8px; }
        .btn-cp:hover { background: var(--cyan); color: #000; }
        
        .inp-risk { background: #020617; border: 1px solid var(--gray); color: #fff; padding: 10px; width: 100%; text-align: right; font-family: inherit; font-weight: 700; margin-bottom: 15px; font-size: 16px; }
        
        .footer-toggle { background: var(--panel); color: var(--gray); padding: 10px 20px; font-size: 13px; font-weight: 700; cursor: pointer; border: 1px solid var(--border); border-radius: 4px; display:flex; justify-content:space-between; margin-top:10px; }
        .footer-content { background: #020617; height: 0; overflow: hidden; transition: height 0.3s; }
        .footer-content.open { height: 150px; border: 1px solid var(--border); padding: 15px; overflow-y: auto; }
        .log-box { font-family: 'Courier New', monospace; font-size: 14px; color: #cbd5e1; }

        /* PHASE 3 BUTTONS & ADVISOR */
        .btn-tv-copy {
            width: 100%; background: var(--cyan); color: #000; 
            font-weight: 800; padding: 12px; border: none; border-radius: 4px; 
            cursor: pointer; font-family: 'Rajdhani'; font-size: 16px; letter-spacing: 1px;
            margin-bottom: 10px; text-transform: uppercase;
        }
        .btn-tv-copy:hover { background: #fff; }
        
        .btn-mission { background: var(--gold); color: #000; margin-bottom: 20px; } 
        .btn-mission:hover { background: #fff; }

        .advisor-box {
            margin-top: 20px; padding: 15px; border-radius: 4px; 
            background: rgba(255, 255, 255, 0.05); border: 1px solid var(--border);
        }
        .advisor-title { font-size: 11px; color: #94a3b8; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; }
        .advisor-rec { font-size: 16px; font-weight: 800; font-family: 'Rajdhani'; color: #fff; margin-bottom: 5px; }
        .advisor-reason { font-size: 11px; color: #cbd5e1; line-height: 1.4; }
    </style>
</head>
<body>

<div class="cockpit">
    <div class="header">
        <div>
            <a href="/suite/market-radar" class="back-link">‚Üê RETURN TO RADAR</a>
            <div>
                <span class="h-title" id="tSym">TARGET LOCK</span>
                <span class="dash-status status-gray" style="vertical-align: middle; margin-left: 15px;">OMEGA INTERFACE</span>
            </div>
        </div>
        <div style="display:flex; align-items:center; gap:30px;">
            <div id="biasBadge" class="dash-status status-gray" style="font-size: 16px; padding: 6px 15px;">BIAS: CALIBRATING</div>
            <div style="text-align:right;">
                <div id="livePrice" class="big-price">--</div>
                <div style="color:var(--cyan); font-weight:700; font-size:14px; letter-spacing:1px;">LOCKED TARGET</div>
            </div>
        </div>
    </div>

    <div class="panel panel-left">
        <div class="panel-head">RISK MANAGEMENT</div>
        <div class="lbl">ACCOUNT BALANCE ($)</div>
        <input type="number" id="inpBal" class="inp-risk" value="4000" oninput="render()">
        <div class="lbl">RISK PER TRADE (%)</div>
        <input type="number" id="inpRisk" class="inp-risk" value="10.0" step="0.1" oninput="render()">
        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px dotted var(--gray);">
            <div class="lbl">MAX ALLOWABLE LOSS</div>
            <div id="valRisk" style="color:var(--red); font-size: 28px; font-weight: 800; font-family: 'Rajdhani';">$400.00</div>
        </div>
    </div>

    <div class="panel panel-center">
        <div id="verdictBanner" class="verdict-banner">
            <div class="lbl" style="font-size:14px; margin-bottom:10px;">SESSION VIABILITY</div>
            <div class="verdict-score-row"><div id="dScore" class="verdict-score">--</div></div>
            <div id="dProtocol" class="verdict-status">OFFLINE</div>
        </div>

        <div class="dashboard-grid">
            <div class="dash-card"><div class="lbl">ENERGY</div><div id="dEnergyVal" class="val">--</div><div class="gauge-bar-bg"><div class="gauge-fill" id="barEnergy"></div></div></div>
            <div class="dash-card"><div class="lbl">SPACE</div><div id="dSpaceVal" class="val">--</div><div class="gauge-bar-bg"><div class="gauge-fill" id="barSpace"></div></div></div>
            <div class="dash-card"><div class="lbl">WIND</div><div id="dWindVal" class="val">--</div><div class="gauge-bar-bg"><div class="gauge-fill" id="barWind"></div></div></div>
            <div class="dash-card"><div class="lbl">STRUCTURE</div><div id="dHullVal" class="val">--</div><div class="gauge-bar-bg"><div class="gauge-fill" id="barHull"></div></div></div>
        </div>
    </div>

    <div class="panel panel-right">
        <div class="panel-head">FLIGHT PATH</div>
        
        <button class="btn-tv-copy" onclick="copyForTV()">üìã COPY INDICATOR DATA</button>
        <button class="btn-tv-copy btn-mission" onclick="copyKey()">üîë COPY MISSION KEY</button>

        <div class="data-row"><span class="lbl">ENTRY TRIGGER</span><div><span id="pEntry" class="val" style="color:var(--cyan)">--</span><button class="btn-cp" onclick="cp('pEntry')">CP</button></div></div>
        <div class="data-row"><span class="lbl">STOP LOSS</span><div><span id="pStop" class="val" style="color:var(--red)">--</span><button class="btn-cp" onclick="cp('pStop')">CP</button></div></div>
        <div class="data-row"><span class="lbl">POSITION SIZE</span><div><span id="pSize" class="val">--</span><button class="btn-cp" onclick="cp('pSize')">CP</button></div></div>
        <div style="margin: 20px 0; border-bottom: 2px solid var(--border);"></div>
        <div class="data-row"><span class="lbl" style="color:var(--gold)">TARGET 1</span><div><span id="pT1" class="val">--</span><button class="btn-cp" onclick="cp('pT1')">CP</button></div></div>
        <div class="data-row"><span class="lbl">TARGET 2</span><div><span id="pT2" class="val">--</span><button class="btn-cp" onclick="cp('pT2')">CP</button></div></div>
        <div class="data-row"><span class="lbl">TARGET 3</span><div><span id="pT3" class="val">--</span><button class="btn-cp" onclick="cp('pT3')">CP</button></div></div>

        <div id="advisorBox" class="advisor-box" style="display:none;">
            <div class="advisor-title">RECOMMENDED EXECUTION</div>
            <div id="advRec" class="advisor-rec">--</div>
            <div id="advReason" class="advisor-reason">--</div>
        </div>
    </div>

    <div class="footer-section">
        <div class="footer-toggle" onclick="toggleFooter()"><span>/// BLACK BOX RECORDER</span><span>[EXPAND]</span></div>
        <div id="footerContent" class="footer-content"><div id="logBox" class="log-box"></div></div>
    </div>
</div>

<input type="hidden" id="raw_bo"><input type="hidden" id="raw_bd"><input type="hidden" id="raw_dr">
<input type="hidden" id="raw_ds"><input type="hidden" id="raw_h30"><input type="hidden" id="raw_l30">
<input type="hidden" id="raw_mission_key">

<script>
    const urlParams = new URLSearchParams(window.location.search);
    const symbol = urlParams.get('symbol') || 'BTCUSDT';
    document.getElementById('tSym').innerText = symbol.replace('USDT', '') + " LOCK";

    let state = { data: null, footerOpen: false };

    // --- LOGIC: EXECUTION TACTICS ---
    function updateAdvisor(d) {
        if(!d || !d.metrics) return;
        
        const score = d.score; 
        const hull = d.metrics.hull ? d.metrics.hull.val : 0; 
        const energy = d.metrics.energy ? d.metrics.energy.val : 0; 
        
        let rec = "üõ°Ô∏è 5-MINUTE GUARD";
        let reason = "Standard Protocol. Wait for full 5m candle close to confirm direction.";
        let color = "#cbd5e1"; // Gray

        if (score >= 70 && hull >= 20) {
            rec = "üí£ TRIPWIRE (LIMIT ORDER)";
            reason = "Structure is Solid & Score is High. Place pending order at Entry Trigger. Let the market come to you.";
            color = "#facc15"; // Gold
        } 
        else if (score >= 60 && energy >= 20) {
            rec = "‚ö° 3-MINUTE SCALP";
            reason = "High Energy detected. 5m might be too slow. Enter on a confirmed 3m Close past the trigger.";
            color = "#22d3ee"; // Cyan
        }

        const box = document.getElementById('advisorBox');
        box.style.display = 'block';
        box.style.borderColor = color;
        document.getElementById('advRec').innerText = rec;
        document.getElementById('advRec').style.color = color;
        document.getElementById('advReason').innerText = reason;
    }

    // --- PRECISION FORMATTER ---
    function fmt(val) {
        if(!val && val !== 0) return "‚Äî";
        const f = parseFloat(val);
        if(isNaN(f)) return "‚Äî";
        if(symbol.includes("DOGE")) return f.toFixed(7);
        if(symbol.includes("TRX")) return f.toFixed(5);
        if(symbol.includes("XRP")) return f.toFixed(5);
        if(Math.abs(f) < 1.0 && Math.abs(f) > 0) return f.toFixed(6);
        return f.toFixed(2); 
    }

    function copyForTV() {
        if(!state.data) return;
        const bo = document.getElementById("raw_bo").value;
        const bd = document.getElementById("raw_bd").value;
        const dr = document.getElementById("raw_dr").value;
        const ds = document.getElementById("raw_ds").value;
        const h30 = document.getElementById("raw_h30").value;
        const l30 = document.getElementById("raw_l30").value;
        const payload = `${fmt(bo)},${fmt(bd)},${fmt(dr)},${fmt(ds)},${fmt(h30)},${fmt(l30)}`;
        
        navigator.clipboard.writeText(payload).then(() => {
            log("Indicator Data Copied");
            alert("Indicator Data Copied!");
        });
    }

    function copyKey() {
        const key = document.getElementById("raw_mission_key").value;
        if(!key) { alert("No Key Generated Yet"); return; }
        navigator.clipboard.writeText(key).then(() => {
            log("Mission Key Copied");
            const btn = document.querySelector('.btn-mission');
            const orig = btn.innerText;
            btn.innerText = "‚úì KEY COPIED";
            setTimeout(() => btn.innerText = orig, 2000);
        });
    }

    function toggleFooter() {
        state.footerOpen = !state.footerOpen;
        document.getElementById('footerContent').classList.toggle('open', state.footerOpen);
    }
    
    function log(msg) {
        const ts = new Date().toLocaleTimeString('en-US', {hour12:false});
        const box = document.getElementById('logBox');
        box.innerHTML += `<div>[${ts}] ${msg}</div>`;
        box.scrollTop = box.scrollHeight;
    }

    function cp(id) { navigator.clipboard.writeText(document.getElementById(id).innerText.replace(/,/g,'')); log("Copied value"); }

    function render() {
        if(!state.data) return;
        const d = state.data;
        const l = d.levels;
        
        document.getElementById('livePrice').innerText = d.price.toLocaleString();
        document.getElementById('dScore').innerText = d.score;
        document.getElementById('dProtocol').innerText = d.status;
        
        // Populate Hidden
        document.getElementById('raw_bo').value = l.breakout_trigger;
        document.getElementById('raw_bd').value = l.breakdown_trigger;
        document.getElementById('raw_dr').value = l.daily_resistance;
        document.getElementById('raw_ds').value = l.daily_support;
        document.getElementById('raw_h30').value = l.range30m_high;
        document.getElementById('raw_l30').value = l.range30m_low;
        
        // --- NEW: Populate Mission Key ---
        document.getElementById('raw_mission_key').value = d.mission_key || "";

        // Bias Colors
        const bias = d.bias;
        const bEl = document.getElementById('biasBadge');
        bEl.innerText = `BIAS: ${bias}`;
        let themeColor = "var(--gray)";
        if (bias === "LONG") { bEl.className="dash-status status-green"; themeColor="#10b981"; }
        else if (bias === "SHORT") { bEl.className="dash-status status-red"; themeColor="#ef4444"; }
        else { bEl.className="dash-status status-gray"; }
        
        document.getElementById('verdictBanner').style.borderLeftColor = themeColor;
        document.getElementById('dProtocol').style.color = themeColor;

        // Update Advisor
        updateAdvisor(d);

        // Metrics
        const m = d.metrics;
        const updateMetric = (id, obj) => {
            if(!obj) return;
            document.getElementById(id+'Val').innerText = obj.text.split(' ')[0];
            document.getElementById('bar'+id.substring(1)).style.width = obj.pct + "%";
            document.getElementById('bar'+id.substring(1)).style.background = (obj.color === 'CYAN' || obj.color === 'GREEN') ? '#10b981' : '#ef4444';
        };
        updateMetric('dEnergy', m.energy);
        updateMetric('dSpace', m.space);
        updateMetric('dWind', m.wind);
        updateMetric('dHull', m.hull);

        // Flight Plan
        const p = d.plans[bias] || {valid:false};
        if(p.valid) {
            document.getElementById('pEntry').innerText = fmt(p.entry);
            document.getElementById('pStop').innerText = fmt(p.stop);
            document.getElementById('pT1').innerText = fmt(p.targets[0]);
            document.getElementById('pT2').innerText = fmt(p.targets[1]);
            document.getElementById('pT3').innerText = fmt(p.targets[2]);
            
            const bal = parseFloat(document.getElementById('inpBal').value) || 0;
            const risk = parseFloat(document.getElementById('inpRisk').value) || 0;
            const riskAmt = bal * (risk/100);
            document.getElementById('valRisk').innerText = "$" + riskAmt.toFixed(2);
            
            const dist = Math.abs(p.entry - p.stop);
            const units = riskAmt / dist;
            const sizeUsd = units * p.entry;
            document.getElementById('pSize').innerText = Math.floor(sizeUsd).toLocaleString();
        } else {
            document.getElementById('pEntry').innerText = "BLOCKED";
            document.getElementById('pSize').innerText = "--";
        }
    }

    async function loadData() {
        try {
            const res = await fetch('/api/radar/target', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ symbol: symbol }) });
            const json = await res.json();
            if(json.ok) { state.data = json.result; render(); log("Target Data Locked."); }
        } catch(e) { console.error(e); }
    }
    loadData();
    setInterval(loadData, 5000); 
</script>
</body>
</html>