<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Kabroda | TARGET LOCK</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&family=Rajdhani:wght@600;700;800&display=swap" rel="stylesheet">
    <style>
        /* --- KABRODA MASTER THEME --- */
        :root { --bg-deep: #020617; --panel: #1e293b; --border: #334155; --cyan: #22d3ee; --green: #10b981; --red: #ef4444; --gold: #facc15; --white: #f8fafc; --gray: #94a3b8; }
        body { background: var(--bg-deep); color: var(--white); font-family: 'JetBrains Mono', monospace; margin: 0; padding: 15px; box-sizing: border-box; }

        /* GRID LAYOUT */
        .cockpit { 
            display: grid; gap: 15px; min-height: 850px;
            grid-template-columns: 320px 1fr 360px;
            grid-template-rows: auto 1fr auto; 
            grid-template-areas: "header header header" "left center right";
        }
        
        .header { grid-area: header; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--border); padding-bottom: 5px; margin-bottom: 10px; }
        .panel { background: var(--panel); border: 1px solid var(--border); border-radius: 8px; padding: 25px; display: flex; flex-direction: column; }
        .panel-center { grid-area: center; background: #0b1121; }

        /* TEXT STYLES */
        .h-title { font-family: 'Rajdhani'; font-weight: 800; font-size: 32px; color: var(--cyan); letter-spacing: 1.5px; margin: 0; }
        .panel-head { font-family: 'Rajdhani'; font-weight: 800; font-size: 20px; color: var(--cyan); border-bottom: 1px solid var(--border); padding-bottom: 10px; margin-bottom: 20px; letter-spacing: 1px; text-transform: uppercase; }
        .back-link { font-size: 12px; font-weight: 700; color: var(--gray); text-decoration: none; text-transform: uppercase; }
        .big-price { font-size: 42px; font-weight: 800; color: #fff; font-family: 'Rajdhani'; }

        /* HUD ELEMENTS */
        .mode-lbl { font-size: 14px; color: var(--gray); letter-spacing: 2px; font-weight: 700; margin-bottom: 10px; text-transform: uppercase; }
        .mode-display { font-family: 'Rajdhani'; font-size: 80px; font-weight: 900; line-height: 0.9; margin-bottom: 20px; text-transform: uppercase; }
        .score-box { margin-bottom: 30px; }
        .advice-banner { background: rgba(255,255,255,0.03); border: 1px solid var(--border); padding: 15px; border-radius: 4px; font-size: 16px; color: #fff; text-align: center; }

        /* GAUGES */
        .gauges-row { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; margin-top: auto; padding-top: 20px; border-top: 1px solid #334155; }
        .mini-gauge { background: rgba(0,0,0,0.2); padding: 10px; border-radius: 4px; text-align: center; }
        .gauge-lbl { font-size: 10px; color: var(--gray); font-weight: 700; margin-bottom: 4px; }
        .gauge-val { font-size: 16px; font-weight: 800; font-family: 'JetBrains Mono'; margin-bottom: 4px; }
        .gauge-bar-bg { height: 4px; background: #334155; border-radius: 2px; width: 100%; }
        .gauge-fill { height: 100%; width: 0%; transition: width 0.5s; }

        /* DATA ROWS */
        .lbl { font-size: 12px; color: #cbd5e1; font-weight: 700; text-transform: uppercase; margin-bottom: 6px; display:block; }
        .val { font-size: 18px; font-weight: 800; color: #fff; }
        .data-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px dashed var(--gray); padding-bottom: 8px; }
        .inp-risk { background: #020617; border: 1px solid var(--gray); color: #fff; padding: 10px; width: 100%; text-align: right; font-weight: 700; font-size: 16px; }

        /* BUTTONS */
        .btn-cp { background: var(--border); border: none; color: var(--white); padding: 2px 6px; border-radius: 3px; cursor: pointer; font-size: 10px; margin-left: 8px; }
        .btn-tv-copy { width: 100%; background: var(--cyan); color: #000; font-weight: 800; padding: 12px; border: none; border-radius: 4px; cursor: pointer; margin-bottom: 10px; font-family: 'Rajdhani'; font-size: 16px; text-transform: uppercase; }
        
        /* UTILS */
        .dash-status { font-size: 13px; font-weight: 800; padding: 4px 10px; border-radius: 4px; display: inline-block; }
        .c-CYAN { color: var(--cyan); text-shadow: 0 0 25px rgba(34,211,238,0.3); }
        .c-GOLD { color: var(--gold); text-shadow: 0 0 25px rgba(250,204,21,0.3); }
        .c-RED { color: var(--red); opacity: 0.8; }
        .t-CYAN { color: var(--cyan); } .t-RED { color: var(--red); } .t-GOLD { color: var(--gold); }
    </style>
</head>
<body>

<div class="cockpit">
    <div class="header" style="grid-area: header;">
        <div>
            <a href="/suite/market-radar" class="back-link">‚Üê RETURN TO RADAR</a>
            <h1 class="h-title" id="tSym">TARGET LOCK</h1>
        </div>
        <div style="text-align:right;">
            <div id="livePrice" class="big-price">--</div>
            <div style="color:#22d3ee; font-weight:700; font-size:11px; letter-spacing:1px;">LIVE MARKET FEED</div>
        </div>
    </div>

    <div class="panel" style="grid-area: left;">
        <div class="panel-head">RISK PROTOCOL</div>
        <div class="lbl">ACCOUNT BALANCE ($)</div>
        <input type="number" id="inpBal" class="inp-risk" value="4000" oninput="recalc()">
        <div class="lbl" style="margin-top:10px;">RISK PER TRADE (%)</div>
        <input type="number" id="inpRisk" class="inp-risk" value="10.0" step="0.1" oninput="recalc()">
        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px dotted #475569;">
            <div class="lbl">MAX LOSS</div>
            <div id="valLoss" style="color:#ef4444; font-size: 28px; font-weight: 800; font-family: 'Rajdhani';">$400.00</div>
        </div>
    </div>

    <div class="panel panel-center" style="grid-area: center;">
        <div class="vector-hud" style="text-align:center; flex-grow:1; display:flex; flex-direction:column; justify-content:center;">
            <div class="mode-lbl">CURRENT ATMOSPHERE</div>
            <div id="vMode" class="mode-display c-RED">CALIBRATING</div>
            
            <div class="score-box">
                <span id="vScore" style="font-size:32px; font-weight:800;">--</span>
                <span style="font-size:11px; color:#94a3b8; font-weight:700;"> KINETIC SCORE</span>
            </div>
            
            <div style="margin-bottom: 20px;">
                <span id="biasBadge" class="dash-status" style="background:#334155;">BIAS: --</span>
            </div>

            <div id="vAdvice" class="advice-banner">ESTABLISHING UPLINK...</div>
        </div>

        <div class="gauges-row">
            <div class="mini-gauge"><div class="gauge-lbl">ENERGY</div><div id="dEnergyVal" class="gauge-val">--</div><div class="gauge-bar-bg"><div class="gauge-fill" id="barEnergy"></div></div></div>
            <div class="mini-gauge"><div class="gauge-lbl">SPACE</div><div id="dSpaceVal" class="gauge-val">--</div><div class="gauge-bar-bg"><div class="gauge-fill" id="barSpace"></div></div></div>
            <div class="mini-gauge"><div class="gauge-lbl">WIND</div><div id="dWindVal" class="gauge-val">--</div><div class="gauge-bar-bg"><div class="gauge-fill" id="barWind"></div></div></div>
            <div class="mini-gauge"><div class="gauge-lbl">HULL</div><div id="dHullVal" class="gauge-val">--</div><div class="gauge-bar-bg"><div class="gauge-fill" id="barHull"></div></div></div>
        </div>
    </div>

    <div class="panel" style="grid-area: right;">
        <div class="panel-head">FLIGHT PATH</div>
        <button class="btn-tv-copy" onclick="copyIndicator()">üìã COPY INDICATOR DATA</button>
        <button class="btn-tv-copy" style="background:#facc15; color:#000; margin-top:5px;" onclick="copyKey()">üîë COPY TRADE KEY</button>
        
        <div style="height:20px;"></div>

        <div class="data-row"><span class="lbl">ENTRY TRIGGER</span><div><span id="pEntry" class="val t-CYAN">--</span><button class="btn-cp" onclick="cp('pEntry')">CP</button></div></div>
        <div class="data-row"><span class="lbl">STOP LOSS</span><div><span id="pStop" class="val t-RED">--</span><button class="btn-cp" onclick="cp('pStop')">CP</button></div></div>
        <div class="data-row"><span class="lbl">POS SIZE</span><div><span id="pSize" class="val">--</span><button class="btn-cp" onclick="cp('pSize')">CP</button></div></div>
        
        <div style="height:15px;"></div>
        
        <div class="data-row"><span class="lbl" style="color:#facc15">TARGET 1</span><div><span id="pT1" class="val t-GOLD">--</span><button class="btn-cp" onclick="cp('pT1')">CP</button></div></div>
        <div class="data-row"><span class="lbl">TARGET 2</span><div><span id="pT2" class="val">--</span><button class="btn-cp" onclick="cp('pT2')">CP</button></div></div>
        <div class="data-row"><span class="lbl">TARGET 3</span><div><span id="pT3" class="val">--</span><button class="btn-cp" onclick="cp('pT3')">CP</button></div></div>
    </div>
</div>

<input type="hidden" id="raw_key"><input type="hidden" id="raw_data">

<script>
    const urlParams = new URLSearchParams(window.location.search);
    const symbol = urlParams.get('symbol') || 'BTCUSDT';
    document.getElementById('tSym').innerText = symbol.replace('USDT', '') + " LOCK";
    
    // Global State
    let activeData = null;

    async function init() {
        try {
            const res = await fetch('/api/radar/target', { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify({ symbol: symbol }) 
            });
            const json = await res.json();
            
            // --- CRITICAL FIX: SMART UNWRAP LOGIC ---
            // Handles both {ok:true, result:{...}} AND {ok:true, result:{result:{...}}}
            if(json.ok) { 
                if (json.result && json.result.result) {
                    // Double nested structure (common in Python wrapper)
                    activeData = json.result.result;
                } else if (json.result) {
                    // Single nested structure
                    activeData = json.result;
                }
                
                // Only render if we actually found data
                if (activeData && activeData.symbol) {
                    render(activeData); 
                } else {
                    console.warn("Data structure incomplete:", json);
                    setStandby("NO SIGNAL");
                }
            } else {
                setStandby("CONNECTION ERR");
            }
        } catch(e) { 
            console.error("Fetch Error:", e);
            setStandby("OFFLINE"); 
        }
    }

    function setStandby(msg) {
        document.getElementById('vMode').innerText = msg;
        document.getElementById('vMode').className = "mode-display c-RED";
        document.getElementById('vAdvice').innerText = "SYSTEM WAITING FOR DATA STREAM...";
    }

    function render(d) {
        // --- 1. POPULATE RAW DATA ---
        if(d.mission_key) document.getElementById('raw_key').value = d.mission_key;
        if(d.indicator_string) document.getElementById('raw_data').value = d.indicator_string; 

        // Header Price (Safe Check)
        if(d.price) {
            document.getElementById('livePrice').innerText = d.price.toLocaleString(undefined, {minimumFractionDigits: 2});
        }

        // --- 2. KINETIC LOGIC ENGINE ---
        const score = d.score || 0;
        let modeText = "STAND DOWN";
        let modeColor = "RED";
        let adviceText = "MARKET WEAK. DO NOT ENGAGE.";

        if (score >= 70) {
            modeText = "BREACH";
            modeColor = "GOLD";
            adviceText = "SUPERSONIC ENERGY DETECTED. SINGLE LATCH ACTIVE: Trade on 15m Breakout immediately.";
        } 
        else if (score >= 50) {
            modeText = "ASSAULT";
            modeColor = "CYAN";
            adviceText = "STRONG TREND. DOUBLE LATCH: Confirm 15m Breakout AND Daily Trigger.";
        } 
        else if (score >= 35) {
            modeText = "AMBUSH";
            modeColor = "CYAN";
            adviceText = "CAUTION. STRICT DOUBLE LATCH REQUIRED. Take profits early (Target 1).";
        }

        // Override if backend Status says HOLD FIRE explicitly
        if (d.status === "HOLD FIRE") {
            modeText = "HOLD FIRE";
            modeColor = "RED";
            adviceText = d.advice || "CONFLICT DETECTED. HOLD POSITION.";
        }

        // --- 3. HUD UPDATES ---
        const modeEl = document.getElementById('vMode');
        modeEl.innerText = modeText;
        modeEl.className = `mode-display c-${modeColor}`;
        
        document.getElementById('vScore').innerText = score;
        document.getElementById('vAdvice').innerText = adviceText;

        const bEl = document.getElementById('biasBadge');
        bEl.innerText = `BIAS: ${d.bias}`;
        bEl.style.background = (d.bias === "BULLISH") ? "#10b981" : ((d.bias === "BEARISH") ? "#ef4444" : "#334155");

        // --- 4. GAUGES (FIXED DATA SOURCE) ---
        // These values come directly from market_radar.py logic (computed once)
        if(d.metrics) {
            setGauge('dEnergy', d.metrics.energy, 30); // Max 30
            setGauge('dSpace', d.metrics.space, 15);   // Max 15
            setGauge('dWind', d.metrics.wind, 25);     // Max 25
            setGauge('dHull', d.metrics.hull, 20);     // Max 20
        }

        // --- 5. FLIGHT PATH (Levels) ---
        if (modeText === "HOLD FIRE" || modeText === "STAND DOWN") {
            document.getElementById('pEntry').innerText = "BLOCKED";
            document.getElementById('pStop').innerText = "BLOCKED";
            document.getElementById('pSize').innerText = "--";
            document.getElementById('pT1').innerText = "--";
            document.getElementById('pT2').innerText = "--";
            document.getElementById('pT3').innerText = "--";
        } else if (d.plan) {
            const p = d.plan;
            document.getElementById('pEntry').innerText = p.entry ? p.entry.toLocaleString() : "--";
            document.getElementById('pStop').innerText = p.stop ? p.stop.toLocaleString() : "--";
            
            if(p.targets && p.targets.length === 3) {
                document.getElementById('pT1').innerText = p.targets[0].toLocaleString();
                document.getElementById('pT2').innerText = p.targets[1].toLocaleString();
                document.getElementById('pT3').innerText = p.targets[2].toLocaleString();
            }

            // Trigger Size Recalc
            recalc();
        }
    }

    // Recalculate Position Size locally so it updates when user types in box
    function recalc() {
        if(!activeData || !activeData.plan) return;
        
        const bal = parseFloat(document.getElementById('inpBal').value) || 0;
        const risk = parseFloat(document.getElementById('inpRisk').value) || 0;
        const riskAmt = bal * (risk/100);
        document.getElementById('valLoss').innerText = "$" + riskAmt.toFixed(2);

        const p = activeData.plan;
        const entry = p.entry || 0;
        const stop = p.stop || 0;
        
        if (entry > 0 && stop > 0) {
            const dist = Math.abs(entry - stop);
            // Protect against zero division
            if(dist > 0) {
                const units = riskAmt / dist;
                document.getElementById('pSize').innerText = units.toFixed(3);
            }
        }
    }

    // --- NEW GAUGE LOGIC ---
    // Takes raw value from backend and calculates visual % here
    function setGauge(id, value, max) {
        const elVal = document.getElementById(id+'Val');
        const elBar = document.getElementById('bar'+id.substring(1));
        
        // 1. Update Text
        if(elVal) elVal.innerText = Math.round(value || 0);

        // 2. Calculate Percentage
        const safeVal = value || 0;
        const pct = (safeVal / max) * 100;

        // 3. Update Bar & Color
        if(elBar) {
            elBar.style.width = pct + "%";
            
            let c = '#ef4444'; // Low = Red
            if (pct >= 80) c = '#22d3ee';      // Max/High = Cyan
            else if (pct >= 50) c = '#10b981'; // Mid/Good = Green
            else if (pct >= 25) c = '#facc15'; // Low/Ok = Yellow
            
            elBar.style.background = c;
        }
    }

    // --- CLIPBOARD UTILS ---
    function cp(id) { 
        const txt = document.getElementById(id).innerText;
        if(txt !== "--" && txt !== "BLOCKED") {
            navigator.clipboard.writeText(txt.replace(/,/g,'')); 
        }
    }
    function copyKey() { navigator.clipboard.writeText(document.getElementById('raw_key').value); alert("Mission Key Copied"); }
    function copyIndicator() { navigator.clipboard.writeText(document.getElementById('raw_data').value); alert("Indicator Data Copied!\n\nPaste into 'Kabroda Predator Command' on TradingView."); }

    // Start
    init();
    setInterval(init, 2000); 
</script>
</body>
</html>