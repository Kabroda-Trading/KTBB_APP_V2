<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Kabroda | TARGET LOCK</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&family=Rajdhani:wght@600;700;800&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root { 
            --bg-deep: #020617; --panel: #1e293b; --border: #334155; 
            --cyan: #22d3ee; --green: #10b981; --red: #ef4444; --gold: #facc15; --white: #f8fafc;
            --gray: #94a3b8; --dark-gray: #475569;
        }
        body { 
            background: var(--bg-deep); color: var(--white); font-family: 'JetBrains Mono', monospace; 
            margin: 0; padding: 15px; min-height: 100vh; box-sizing: border-box; 
        }

        /* LAYOUT */
        .cockpit { 
            display: grid; gap: 15px; min-height: 850px;
            grid-template-columns: 320px 1fr 360px;
            grid-template-rows: auto 1fr; 
            grid-template-areas: "header header header" "left center right";
        }
        
        .header { grid-area: header; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--border); padding-bottom: 5px; margin-bottom: 10px; }
        .panel { background: rgba(15, 23, 42, 0.6); border: 1px solid var(--border); border-radius: 8px; padding: 25px; display: flex; flex-direction: column; backdrop-filter: blur(10px); }
        .panel-center { grid-area: center; background: #0b1121; display:flex; flex-direction:column; justify-content: space-between; }

        /* TYPOGRAPHY */
        .h-title { font-family: 'Rajdhani', sans-serif; font-weight: 800; font-size: 32px; color: var(--cyan); letter-spacing: 1.5px; margin: 0; text-shadow: 0 0 10px rgba(34, 211, 238, 0.2); }
        .panel-head { font-family: 'Rajdhani', sans-serif; font-weight: 800; font-size: 20px; color: var(--cyan); letter-spacing: 1px; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 5px; text-transform: uppercase; }
        .back-link { display: block; font-size: 11px; font-weight: 800; color: var(--gray); text-decoration: none; margin-bottom: 5px; letter-spacing: 1px; transition: 0.2s; }
        .back-link:hover { color: var(--white); }

        .big-price { font-size: 42px; font-weight: 800; color: #fff; font-family: 'Rajdhani'; }
        .live-lbl { font-size: 11px; color: var(--cyan); font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }

        /* --- THE NEW VECTOR-STYLE HUD --- */
        .vector-hud { text-align: center; flex-grow: 1; display: flex; flex-direction: column; justify-content: center; margin-bottom: 30px; }
        .mode-lbl { font-size: 12px; color: var(--gray); letter-spacing: 3px; font-weight: 700; margin-bottom: 15px; text-transform: uppercase; }
        .mode-display { font-family: 'Rajdhani'; font-size: 90px; font-weight: 900; line-height: 0.9; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 2px; }
        
        .score-pill { 
            display: inline-flex; align-items: center; gap: 10px; 
            background: rgba(255,255,255,0.05); border: 1px solid var(--border); 
            padding: 8px 20px; border-radius: 50px; margin: 0 auto 25px auto;
        }
        .score-val { font-size: 24px; font-weight: 800; }
        .score-lbl { font-size: 11px; color: var(--gray); font-weight: 700; }

        .advice-banner { 
            background: rgba(30, 41, 59, 0.5); border: 1px solid var(--border); 
            padding: 15px; border-radius: 4px; color: #fff; font-weight: 500; font-size: 14px;
            max-width: 80%; margin: 0 auto; letter-spacing: 0.5px;
        }

        /* --- COMPACT GAUGES (BOTTOM) --- */
        .gauges-row { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; border-top: 1px solid var(--border); padding-top: 20px; }
        .mini-gauge { background: rgba(0,0,0,0.2); padding: 10px; border-radius: 4px; text-align: center; }
        .gauge-lbl { font-size: 10px; color: var(--gray); font-weight: 700; margin-bottom: 4px; }
        .gauge-val { font-size: 16px; font-weight: 800; font-family: 'JetBrains Mono'; margin-bottom: 4px; }
        .gauge-bar-bg { height: 4px; background: #334155; border-radius: 2px; overflow: hidden; width: 100%; }
        .gauge-fill { height: 100%; background: var(--cyan); width: 0%; transition: width 0.5s; }

        /* LEFT & RIGHT PANELS */
        .lbl { font-size: 11px; color: #cbd5e1; font-weight: 700; text-transform: uppercase; margin-bottom: 6px; display:block; }
        .val { font-size: 16px; font-weight: 700; color: #fff; }
        .data-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; border-bottom: 1px dashed var(--border); padding-bottom: 8px; }
        
        .btn-cp { background: var(--border); border: none; color: var(--white); padding: 2px 6px; border-radius: 3px; cursor: pointer; font-size: 10px; margin-left: 8px; }
        .btn-cp:hover { background: var(--cyan); color: #000; }
        
        .inp-risk { background: #020617; border: 1px solid var(--gray); color: #fff; padding: 10px; width: 100%; text-align: right; font-family: inherit; font-weight: 700; margin-bottom: 15px; font-size: 16px; border-radius: 4px; }

        /* BUTTONS */
        .btn-tv-copy { width: 100%; background: var(--cyan); color: #000; font-weight: 800; padding: 12px; border: none; border-radius: 4px; cursor: pointer; font-family: 'Rajdhani'; font-size: 16px; letter-spacing: 1px; margin-bottom: 10px; text-transform: uppercase; transition: 0.2s; }
        .btn-tv-copy:hover { background: #fff; }
        .btn-mission { background: var(--gold); color: #000; margin-bottom: 20px; } 

        .advisor-box { margin-top: 20px; padding: 15px; border-radius: 4px; background: rgba(255, 255, 255, 0.05); border: 1px solid var(--border); border-left-width: 4px; }
        .advisor-rec { font-size: 14px; font-weight: 800; font-family: 'Rajdhani'; color: #fff; margin-bottom: 4px; }
        .advisor-reason { font-size: 11px; color: #94a3b8; line-height: 1.4; }

        /* STATUS COLORS */
        .c-CYAN { color: var(--cyan); text-shadow: 0 0 25px rgba(34,211,238,0.3); }
        .c-GOLD { color: var(--gold); text-shadow: 0 0 25px rgba(250,204,21,0.3); }
        .c-AMBER { color: #fbbf24; }
        .c-RED { color: var(--red); opacity: 0.8; }
        .t-CYAN { color: var(--cyan); } .t-RED { color: var(--red); } .t-GOLD { color: var(--gold); }
        
        .dash-status { font-size: 13px; font-weight: 800; padding: 4px 10px; border-radius: 4px; display: inline-block; }
    </style>
</head>
<body>

<div class="cockpit">
    <div class="header">
        <div>
            <a href="/suite/market-radar" class="back-link">‚Üê RETURN TO RADAR</a>
            <div style="display:flex; align-items:center; gap:15px;">
                <span class="h-title" id="tSym">TARGET LOCK</span>
                <span class="dash-status" id="biasBadge" style="background:#334155;">BIAS: --</span>
            </div>
        </div>
        <div style="text-align:right;">
            <div id="livePrice" class="big-price">--</div>
            <div class="live-lbl">LIVE MARKET FEED</div>
        </div>
    </div>

    <div class="panel" style="grid-area: left;">
        <div class="panel-head">RISK PROTOCOL</div>
        <div class="lbl">ACCOUNT BALANCE ($)</div>
        <input type="number" id="inpBal" class="inp-risk" value="4000" oninput="render()">
        <div class="lbl">RISK PER TRADE (%)</div>
        <input type="number" id="inpRisk" class="inp-risk" value="10.0" step="0.1" oninput="render()">
        <div style="margin-top: 10px; padding-top: 15px; border-top: 1px dashed var(--border);">
            <div class="lbl">MAX ALLOWABLE LOSS</div>
            <div id="valLoss" style="color:var(--red); font-size: 28px; font-weight: 800; font-family: 'Rajdhani';">$400.00</div>
        </div>
    </div>

    <div class="panel panel-center">
        <div class="vector-hud">
            <div class="mode-lbl">CURRENT ATMOSPHERE</div>
            <div id="vMode" class="mode-display c-RED">CALIBRATING</div>
            
            <div class="score-pill">
                <span class="score-val" id="vScore">--</span>
                <span class="score-lbl">KINETIC SCORE</span>
            </div>

            <div id="vAdvice" class="advice-banner">ESTABLISHING UPLINK...</div>
        </div>

        <div class="gauges-row">
            <div class="mini-gauge">
                <div class="gauge-lbl">ENERGY</div><div id="dEnergyVal" class="gauge-val">--</div>
                <div class="gauge-bar-bg"><div class="gauge-fill" id="barEnergy"></div></div>
            </div>
            <div class="mini-gauge">
                <div class="gauge-lbl">SPACE</div><div id="dSpaceVal" class="gauge-val">--</div>
                <div class="gauge-bar-bg"><div class="gauge-fill" id="barSpace"></div></div>
            </div>
            <div class="mini-gauge">
                <div class="gauge-lbl">WIND</div><div id="dWindVal" class="gauge-val">--</div>
                <div class="gauge-bar-bg"><div class="gauge-fill" id="barWind"></div></div>
            </div>
            <div class="mini-gauge">
                <div class="gauge-lbl">HULL</div><div id="dHullVal" class="gauge-val">--</div>
                <div class="gauge-bar-bg"><div class="gauge-fill" id="barHull"></div></div>
            </div>
        </div>
    </div>

    <div class="panel" style="grid-area: right;">
        <div class="panel-head">FLIGHT PATH</div>
        <div class="action-row">
            <button class="btn-tv-copy" onclick="copyIndicator()">üìã COPY DATA</button>
            <button class="btn-tv-copy btn-mission" onclick="copyKey()">üîë COPY KEY</button>
        </div>

        <div style="margin-bottom:20px;">
            <div class="data-row"><span class="lbl">ENTRY</span><div><span id="pEntry" class="val t-CYAN">--</span><button class="btn-mini-cp" onclick="cp('pEntry')">CP</button></div></div>
            <div class="data-row"><span class="lbl">STOP</span><div><span id="pStop" class="val t-RED">--</span><button class="btn-mini-cp" onclick="cp('pStop')">CP</button></div></div>
            <div class="data-row"><span class="lbl">SIZE</span><div><span id="pSize" class="val">--</span><button class="btn-mini-cp" onclick="cp('pSize')">CP</button></div></div>
            <div style="height:10px;"></div>
            <div class="data-row"><span class="lbl t-GOLD">TARGET 1</span><div><span id="pT1" class="val t-GOLD">--</span><button class="btn-mini-cp" onclick="cp('pT1')">CP</button></div></div>
            <div class="data-row"><span class="lbl">TARGET 2</span><div><span id="pT2" class="val">--</span><button class="btn-mini-cp" onclick="cp('pT2')">CP</button></div></div>
            <div class="data-row"><span class="lbl">TARGET 3</span><div><span id="pT3" class="val">--</span><button class="btn-mini-cp" onclick="cp('pT3')">CP</button></div></div>
        </div>

        <div id="advisorBox" class="advisor-box" style="display:none;">
            <div class="advisor-title">RECOMMENDED EXECUTION</div>
            <div id="advRec" class="advisor-rec">--</div>
            <div id="advDesc" class="advisor-reason">--</div>
        </div>
    </div>
</div>

<input type="hidden" id="raw_key"><input type="hidden" id="raw_data">

<script>
    const urlParams = new URLSearchParams(window.location.search);
    const symbol = urlParams.get('symbol') || 'BTCUSDT';
    document.getElementById('tSym').innerText = symbol.replace('USDT', '') + " LOCK";

    function cp(id) { navigator.clipboard.writeText(document.getElementById(id).innerText.replace(/,/g,'')); }
    function copyKey() { navigator.clipboard.writeText(document.getElementById('raw_key').value); alert("Mission Key Copied"); }
    function copyIndicator() { navigator.clipboard.writeText(document.getElementById('raw_data').value); alert("Indicator Data Copied"); }

    async function scan() {
        try {
            // CALLING RADAR API (MARKET_RADAR.PY)
            const res = await fetch('/api/radar/target', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ symbol: symbol }) });
            const json = await res.json();
            if(!json.ok) return;
            
            const d = json.result; const p = d.plan; const l = d.levels;
            
            document.getElementById('livePrice').innerText = d.price.toLocaleString(undefined, {minimumFractionDigits: 2});
            
            // 1. Center HUD
            const modeEl = document.getElementById('vMode');
            modeEl.innerText = d.status;
            modeEl.className = `mode-display c-${d.color}`; 
            document.getElementById('vAdvice').innerText = d.advice;
            
            const scoreEl = document.getElementById('vScore');
            scoreEl.innerText = d.score;
            scoreEl.style.color = (d.score >= 50) ? '#fff' : '#ef4444';

            // 2. Bias Badge
            const bEl = document.getElementById('biasBadge');
            bEl.innerText = `BIAS: ${d.bias}`;
            bEl.style.background = (d.bias === "BULLISH") ? "#10b981" : ((d.bias === "BEARISH") ? "#ef4444" : "#334155");

            // 3. Compact Gauges
            const updateGauge = (id, obj) => {
                if(!obj) return;
                document.getElementById(id+'Val').innerText = Math.round(obj.val);
                document.getElementById('bar'+id.substring(1)).style.width = obj.pct + "%";
                document.getElementById('bar'+id.substring(1)).style.background = (obj.color === 'CYAN') ? '#22d3ee' : ((obj.color === 'GREEN') ? '#10b981' : '#ef4444');
            };
            updateGauge('dEnergy', d.metrics.energy);
            updateGauge('dSpace', d.metrics.space);
            updateGauge('dWind', d.metrics.wind);
            updateGauge('dHull', d.metrics.hull);

            // 4. Hidden Data
            document.getElementById('raw_key').value = d.mission_key;
            document.getElementById('raw_data').value = `${l.breakout_trigger},${l.breakdown_trigger},${l.daily_resistance},${l.daily_support},${l.range30m_high},${l.range30m_low}`;

            // 5. Flight Path
            if (p.valid) {
                document.getElementById('pEntry').innerText = p.entry.toLocaleString(undefined, {minimumFractionDigits: 2});
                document.getElementById('pStop').innerText = p.stop.toLocaleString(undefined, {minimumFractionDigits: 2});
                document.getElementById('pT1').innerText = p.targets[0].toLocaleString(undefined, {minimumFractionDigits: 2});
                document.getElementById('pT2').innerText = p.targets[1].toLocaleString(undefined, {minimumFractionDigits: 2});
                document.getElementById('pT3').innerText = p.targets[2].toLocaleString(undefined, {minimumFractionDigits: 2});
                
                const bal = parseFloat(document.getElementById('inpBal').value) || 0;
                const riskPct = parseFloat(document.getElementById('inpRisk').value) || 0;
                const riskAmt = bal * (riskPct / 100);
                document.getElementById('valLoss').innerText = "$" + riskAmt.toFixed(2);
                
                const dist = Math.abs(p.entry - p.stop);
                if(dist > 0) {
                    const units = riskAmt / dist;
                    const sizeUsd = units * p.entry;
                    document.getElementById('pSize').innerText = Math.floor(sizeUsd).toLocaleString();
                }

                const advBox = document.getElementById('advisorBox');
                advBox.style.display = 'block';
                advBox.style.borderColor = (d.color === 'GOLD') ? '#facc15' : ((d.color === 'CYAN') ? '#22d3ee' : '#94a3b8');
                document.getElementById('advRec').innerText = (d.status === 'BREACH') ? 'VOLATILITY ALERT' : 'STANDARD PROTOCOL';
                document.getElementById('advRec').style.color = advBox.style.borderColor;
                document.getElementById('advDesc').innerText = d.advice;
            } else {
                document.getElementById('pEntry').innerText = "BLOCKED";
                document.getElementById('pSize').innerText = "--";
                document.getElementById('advisorBox').style.display = 'none';
            }
        } catch(e) { console.error(e); }
    }
    
    function render() { scan(); }
    scan(); setInterval(scan, 5000);
</script>
</body>
</html>