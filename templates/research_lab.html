<script>
    // ... (upd, onload functions same as before) ...

    async function runAnalysis() {
        document.getElementById('runBtn').disabled = true;
        document.getElementById('loader').style.display = 'block';
        document.getElementById('results').style.display = 'none';

        // Gather Inputs (Same as before)
        // ...

        try {
            const res = await fetch('/api/research/run', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            
            if(!data.ok) throw new Error(data.error);

            // Stats
            document.getElementById('rTotal').innerText = data.total_sessions;
            document.getElementById('rSignals').innerText = data.trade_signals;
            document.getElementById('rKinetic').innerText = data.kinetic_passes;
            document.getElementById('rPrime').innerText = data.prime_setups;
            document.getElementById('lblMinScore').innerText = payload.min_score;
            document.getElementById('rawJson').innerText = JSON.stringify(data.results, null, 2); // <--- FULL JSON IS BACK

            // Visual Log
            let html = "";
            const minS = payload.min_score;
            
            data.results.forEach(r => {
                const hasTrade = r.trade_signal;
                const hasKinetic = r.kinetic_score >= minS;
                
                // Color Logic
                let bg = "rgba(255,255,255,0.02)";
                let bord = "transparent";
                if(hasTrade && hasKinetic) { bg = "rgba(6,182,212,0.1)"; bord = "#06b6d4"; } // Prime
                else if(hasTrade) { bg = "rgba(16,185,129,0.1)"; bord = "#10b981"; } // Signal only
                else if(hasKinetic) { bord = "#fbbf24"; } // Kinetic only

                // Trade Details (The "Data" you missed)
                let tradeInfo = "";
                if(hasTrade) {
                    const sim = r.simulation || {};
                    const outcomeColor = sim.r_realized > 0 ? "#10b981" : (sim.r_realized < 0 ? "#ef4444" : "#94a3b8");
                    tradeInfo = `
                        <div style="margin-top:8px; padding-top:8px; border-top:1px solid rgba(255,255,255,0.1); font-size:11px; display:flex; justify-content:space-between;">
                            <span>ENTRY: ${sim.entry_price}</span>
                            <span style="color:${outcomeColor}; font-weight:700;">PnL: ${sim.r_realized}R (${sim.outcome})</span>
                        </div>
                    `;
                }

                html += `
                    <div class="log-row" style="background:${bg}; border-left:3px solid ${bord}; margin-bottom:5px; padding:10px;">
                        <div style="display:flex; justify-content:space-between;">
                            <div>
                                <div style="color:#fff; font-weight:700; font-size:12px;">${r.date}</div>
                                <div style="color:#94a3b8; font-size:10px;">${r.protocol}</div>
                            </div>
                            <div style="text-align:right;">
                                ${hasTrade ? '<span class="tag tag-go">GO SIGNAL</span>' : '<span class="tag tag-wait">WAIT</span>'}
                                <div style="color:${hasKinetic ? '#facc15' : '#64748b'}; font-weight:700; font-size:11px;">K-SCORE: ${r.kinetic_score}</div>
                            </div>
                        </div>
                        ${tradeInfo}
                    </div>
                `;
            });
            document.getElementById('logArea').innerHTML = html;
            document.getElementById('results').style.display = 'block';

        } catch(e) {
            alert("Error: " + e.message);
        } finally {
            document.getElementById('loader').style.display = 'none';
            document.getElementById('runBtn').disabled = false;
        }
    }
</script>