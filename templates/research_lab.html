<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Kabroda Research Lab</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:#0b1220; color:#e5e7eb; margin:0; }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 18px; }
    .card { background:#0f1b33; border:1px solid #1f2a44; border-radius: 14px; padding: 14px; margin-bottom: 14px; }
    .row { display:flex; flex-wrap:wrap; gap:10px; align-items:flex-end; }
    label { display:block; font-size:12px; opacity:.85; margin-bottom:6px; }
    input, select, button, textarea {
      background:#0b1220; color:#e5e7eb; border:1px solid #26324f; border-radius:10px;
      padding:10px 12px; font-size:14px;
    }
    select[multiple] { height: 160px; }
    button { cursor:pointer; background:#2563eb; border-color:#2563eb; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    table { width:100%; border-collapse: collapse; }
    th, td { border-bottom:1px solid #1f2a44; padding:10px; text-align:left; font-size:13px; }
    .muted { opacity:.7; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid #26324f; }
    .ok { background: rgba(16,185,129,.15); border-color: rgba(16,185,129,.35); }
    .bad { background: rgba(239,68,68,.15); border-color: rgba(239,68,68,.35); }
    pre { white-space: pre-wrap; word-break: break-word; background:#0b1220; border:1px solid #26324f; border-radius:12px; padding:12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h2 style="margin:0 0 8px 0;">Research Lab</h2>
      <div class="muted">Measures: acceptance frequency, alignment frequency (“trade opportunities”), and no-trade sessions.</div>
    </div>

    <div class="card">
      <div class="row">
        <div style="min-width:180px;">
          <label>Symbol</label>
          <input id="symbol" value="BTCUSDT"/>
        </div>

        <div style="min-width:180px;">
          <label>Start date (UTC)</label>
          <input id="start" type="date"/>
        </div>

        <div style="min-width:180px;">
          <label>End date (UTC)</label>
          <input id="end" type="date"/>
        </div>

        <div style="min-width:260px; flex:1;">
          <label>Sessions</label>
          <select id="sessions" multiple>
            <option value="us_ny_futures" selected>NY Futures</option>
            <option value="us_ny_equity">NY Equity</option>
            <option value="eu_london" selected>London</option>
            <option value="asia_tokyo">Tokyo</option>
            <option value="au_sydney">Sydney</option>
          </select>
        </div>

        <div>
          <button id="runBtn">Run</button>
        </div>
      </div>
    </div>

    <div class="card">
      <h3 style="margin-top:0;">Summary</h3>
      <pre id="summary">Run a test to see results.</pre>
    </div>

    <div class="card">
      <h3 style="margin-top:0;">Sessions</h3>
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Session</th>
            <th>Acceptance</th>
            <th>Alignment (Trade)</th>
            <th>Side</th>
            <th>Notes</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
  </div>
<script>
(function(){
  const $ = (id)=>document.getElementById(id);

  // default dates: last 7 days
  const today = new Date();
  const end = new Date(today);
  const start = new Date(today);
  start.setUTCDate(start.getUTCDate() - 7);

  const fmt = (d)=> d.toISOString().slice(0,10);
  $("start").value = fmt(start);
  $("end").value = fmt(end);

  async function run(){
    $("runBtn").disabled = true;
    $("summary").textContent = "Running...";
    $("rows").innerHTML = "";

    const symbol = $("symbol").value.trim().toUpperCase();
    const startDate = $("start").value;
    const endDate = $("end").value;

    const sel = Array.from($("sessions").selectedOptions).map(o=>o.value);

    const payload = {
      symbol,
      start_date_utc: startDate,
      end_date_utc: endDate,
      session_ids: sel
    };

    try{
      const res = await fetch("/api/research/run", {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(payload)
      });
      const data = await res.json();

      $("summary").textContent = JSON.stringify({
        ok: data.ok,
        symbol: data.symbol,
        range: data.range,
        stats: data.stats
      }, null, 2);

      if(!data.ok){
        return;
      }

      const rows = data.sessions || [];
      for(const r of rows){
        const ok = !!r.ok;
        const hadAcc = ok && r.counts?.had_acceptance;
        const hadAln = ok && r.counts?.had_alignment;
        const side = ok ? (r.events?.acceptance_side || "NONE") : "NONE";

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.date || ""}</td>
          <td>${r.session_name || r.session_id || ""}</td>
          <td><span class="pill ${hadAcc ? "ok":"bad"}">${hadAcc ? "YES":"NO"}</span></td>
          <td><span class="pill ${hadAln ? "ok":"bad"}">${hadAln ? "YES":"NO"}</span></td>
          <td>${side}</td>
          <td class="muted">${ok ? "" : (r.error || "Error")}</td>
        `;
        $("rows").appendChild(tr);
      }

    } catch(e){
      $("summary").textContent = "Error: " + (e?.message || String(e));
    } finally {
      $("runBtn").disabled = false;
    }
  }

  $("runBtn").addEventListener("click", run);
})();
</script>
</body>
</html>