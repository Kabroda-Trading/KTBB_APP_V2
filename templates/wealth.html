{% extends "base.html" %}
{% block content %}
<script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>

<div class="text-center" style="margin-bottom: 40px;">
  <div class="pill">INSTITUTIONAL GRADE</div>
  <h1 class="display-title">Wealth <span class="gradient-text">OS</span></h1>
  <p class="lead-text" style="max-width: 600px; margin: 10px auto;">
    Macro Cycle Alignment + Micro Trend Execution.
  </p>
</div>

<div class="bento-grid">
  
  <div class="bento-card">
    <div style="margin-bottom: 20px;">
      <h3 style="color: #fff; margin-bottom: 4px;"><span class="gradient-text">Step 1:</span> Configuration</h3>
      <p style="font-size: 13px; color: var(--text-muted);">Define asset and deployable capital.</p>
    </div>

    <div style="margin-bottom: 16px;">
      <label class="label">TARGET ASSET</label>
      <input id="ticker" class="input" value="BTC/USDT" style="text-transform: uppercase; font-weight: 700; letter-spacing: 1px;">
    </div>
    
    <div style="margin-bottom: 20px;">
      <label class="label">AVAILABLE CAPITAL ($)</label>
      <input id="capital" class="input" type="number" value="100000" style="font-family: monospace; font-weight: 700;">
    </div>

    <button onclick="run Analysis()" id="run-btn" class="btn primary" style="width: 100%; display: flex; justify-content: center; align-items: center; gap: 10px;">
      <span>RUN CYCLE ANALYSIS</span>
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>
    </button>
  </div>

  <div class="bento-card" id="results-panel" style="display: none; border-left: 4px solid var(--glass-border);">
    <div style="margin-bottom: 15px;">
      <h3 style="color: #fff; margin-bottom: 4px;"><span class="gradient-text">Step 2:</span> Execution Plan</h3>
    </div>

    <div style="background: rgba(255,255,255,0.03); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <span class="label" style="margin: 0;">MARKET PHASE</span>
            <div id="badge-mode" style="padding: 5px 10px; border-radius: 4px; font-size: 11px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; background: var(--glass-border); color: #fff;">--</div>
        </div>
        <p id="rationale" style="font-size: 14px; color: #fff; line-height: 1.5; margin: 0;">--</p>
    </div>

    <div>
        <div class="label" style="margin-bottom: 10px;">DEPLOYMENT SCHEDULE</div>
        <div id="orders-list" style="display: grid; gap: 8px;">
            </div>
    </div>
  </div>

  <div class="bento-card wide" style="height: 550px; padding: 0; overflow: hidden; position: relative; border: 1px solid var(--glass-border);">
     <div id="chart-mount" style="width: 100%; height: 100%;"></div>
     <div id="chart-loader" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-weight: 700; color: var(--text-muted); display: none;">LOADING DEEP HISTORY...</div>
  </div>

</div>

<script>
  // --- 1. CHART SETUP ---
  const chart = LightweightCharts.createChart(document.getElementById('chart-mount'), {
    layout: { background: { type: 'solid', color: '#020617' }, textColor: '#94a3b8' },
    grid: { vertLines: { color: 'rgba(30, 41, 59, 0.5)' }, horzLines: { color: 'rgba(30, 41, 59, 0.5)' } },
    rightPriceScale: { borderColor: '#334155', scaleMargins: { top: 0.1, bottom: 0.1 } },
    timeScale: { borderColor: '#334155', timeVisible: true, rightOffset: 5 },
    crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
  });

  const candles = chart.addCandlestickSeries({
    upColor: '#10b981', downColor: '#ef4444',
    borderVisible: false, wickUpColor: '#10b981', wickDownColor: '#ef4444'
  });
  
  // Trend Lines: 21 EMA (Cyan) & 200 SMA (White)
  const emaSeries = chart.addLineSeries({ color: '#38bdf8', lineWidth: 2, title: '21 EMA (Speed)' });
  const smaSeries = chart.addLineSeries({ color: 'rgba(255,255,255,0.7)', lineWidth: 1, lineStyle: 2, title: '200 SMA (River)' });

  // Responsive Resize
  new ResizeObserver(e => chart.applyOptions({ width: e[0].contentRect.width, height: e[0].contentRect.height }))
    .observe(document.getElementById('chart-mount'));

  let fibLines = [];

  // --- 2. EXECUTION LOGIC ---
  async function runAnalysis() {
    const ticker = document.getElementById('ticker').value;
    const capital = document.getElementById('capital').value;
    const btn = document.getElementById('run-btn');
    const loader = document.getElementById('chart-loader');
    
    // UI Loading State
    btn.innerHTML = 'ANALYZING DEEP DATA...';
    btn.disabled = true;
    btn.style.opacity = '0.7';
    loader.style.display = 'block';
    document.getElementById('results-panel').style.display = 'none';

    // Clear previous fibs
    fibLines.forEach(l => candles.removePriceLine(l));
    fibLines = [];

    try {
      const res = await fetch('/api/analyze-s-jan', {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ symbol: ticker, capital: parseFloat(capital) })
      });
      
      if (!res.ok) throw new Error("Analysis failed");
      const data = await res.json();

      // A. Populate Chart
      if(data.candles) {
        candles.setData(data.candles.sort((a,b)=>a.time-b.time));
        if(data.analysis.charts) {
            emaSeries.setData(data.analysis.charts.ema_21);
            smaSeries.setData(data.analysis.charts.sma_200);
        }
        
        // Draw Key Levels
        const fibs = data.analysis.fibs;
        fibLines.push(candles.createPriceLine({ price: fibs.golden, color: '#eab308', lineWidth: 2, axisLabelVisible: true, title: 'BUY: GOLDEN POCKET (.618)' }));
        fibLines.push(candles.createPriceLine({ price: fibs.premium_zone, color: '#ef4444', lineWidth: 1, lineStyle: 2, axisLabelVisible: true, title: 'SELL: PREMIUM ZONE' }));
        
        chart.timeScale().fitContent();
      }

      // B. Populate Results Panel
      if(data.plan && data.plan.status === 'READY') {
        const p = data.plan;
        const panel = document.getElementById('results-panel');
        panel.style.display = 'block';
        
        // Dynamic Badge Coloring based on Phase
        const badge = document.getElementById('badge-mode');
        badge.innerText = p.mode;
        let badgeColor = 'var(--glass-border)';
        let badgeText = '#fff';
        
        if (p.mode.includes('MOMENTUM') || p.mode.includes('ROTATION')) {
            badgeColor = '#10b981'; // Green
            badgeText = '#000';
            panel.style.borderLeftColor = '#10b981';
        } else if (p.mode.includes('PULLBACK')) {
            badgeColor = '#eab308'; // Yellow/Gold
            badgeText = '#000';
            panel.style.borderLeftColor = '#eab308';
        } else if (p.mode.includes('BEAR')) {
            badgeColor = '#ef4444'; // Red
            panel.style.borderLeftColor = '#ef4444';
        }
        badge.style.background = badgeColor;
        badge.style.color = badgeText;

        document.getElementById('rationale').innerText = p.rationale;

        // Generate Actionable Order Cards
        const list = document.getElementById('orders-list');
        list.innerHTML = '';
        if(p.orders.length === 0) {
             list.innerHTML = '<div style="color:var(--text-muted); font-size:13px; font-style:italic;">No actions required at current levels.</div>';
        } else {
            p.orders.forEach(o => {
                const isBuy = !o.note.includes('TAKE PROFIT');
                const actionColor = isBuy ? '#10b981' : '#ef4444';
                
                list.innerHTML += `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 6px; border-left: 3px solid ${actionColor};">
                  <div>
                    <div style="font-size:11px; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.5px;">${o.note}</div>
                    <div style="font-weight:700; color:#fff; font-size: 15px;">
                        <span style="color:${actionColor};">${isBuy ? 'BUY' : 'SELL'}</span> 
                        $${o.amount ? o.amount.toLocaleString() : '---'}
                    </div>
                  </div>
                  <div style="text-align:right;">
                     <div style="font-size:11px; color:var(--text-muted);">AT LEVEL</div>
                     <div style="font-family:monospace; color:var(--primary-bright); font-size:15px; font-weight:700;">$${o.price.toLocaleString()}</div>
                  </div>
                </div>`;
            });
        }
      }

    } catch(e) {
      console.error(e);
      alert("Analysis failed. Please check the symbol or try again.");
    } finally {
      // Reset UI State
      btn.innerHTML = `<span>RUN CYCLE ANALYSIS</span><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>`;
      btn.disabled = false;
      btn.style.opacity = '1';
      loader.style.display = 'none';
    }
  }
</script>
{% endblock %}