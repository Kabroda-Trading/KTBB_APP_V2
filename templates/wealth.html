{% extends "base.html" %}
{% block content %}
<script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>

<div class="text-center" style="margin-bottom: 40px;">
  <div class="pill">INSTITUTIONAL GRADE</div>
  <h1 class="display-title">Wealth <span class="gradient-text">OS</span></h1>
</div>

<div class="bento-grid">
  <div class="bento-card">
    <h3 style="margin-bottom: 20px;">Configuration</h3>
    <label class="label">TARGET ASSET</label>
    <input id="ticker" class="input" value="BTC/USDT">
    <label class="label" style="margin-top: 15px;">CAPITAL ($)</label>
    <input id="capital" class="input" type="number" value="100000">
    <button onclick="run()" class="btn primary" style="width: 100%; margin-top: 20px;">GENERATE PLAN</button>
  </div>

  <div class="bento-card" id="results" style="display: none; border-left: 4px solid var(--primary);">
    <div id="badge-mode" class="badge-mode" style="padding: 4px 8px; font-weight: 800; border-radius: 4px; font-size: 11px; background: var(--primary); color: #000;">--</div>
    <p id="rationale" style="font-size: 13px; color: var(--text-muted); margin-top: 12px;">--</p>
    <div id="order-list" style="margin-top: 20px; border-top: 1px solid var(--glass-border);"></div>
  </div>

  <div class="bento-card wide" style="height: 600px; padding: 0; overflow: hidden;">
    <div id="chart-mount" style="width: 100%; height: 100%;"></div>
  </div>
</div>

<script>
  const chart = LightweightCharts.createChart(document.getElementById('chart-mount'), {
    layout: { background: { color: '#020617' }, textColor: '#94a3b8' },
    grid: { vertLines: { color: '#1e293b' }, horzLines: { color: '#1e293b' } },
    rightPriceScale: { borderColor: '#334155' },
    timeScale: { borderColor: '#334155', timeVisible: true }
  });
  const series = chart.addCandlestickSeries({ upColor: '#10b981', downColor: '#ef4444', borderVisible: false });
  const ema21 = chart.addLineSeries({ color: '#38bdf8', lineWidth: 2, title: '21 EMA' });
  const sma200 = chart.addLineSeries({ color: '#ffffff', lineWidth: 2, lineStyle: 2, title: '200 SMA' });

  async function run() {
    const res = await fetch('/api/analyze-s-jan', {
      method: 'POST', headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ symbol: document.getElementById('ticker').value, capital: parseFloat(document.getElementById('capital').value) })
    });
    const data = await res.json();
    if(data.candles) {
      series.setData(data.candles.sort((a,b)=>a.time-b.time));
      ema21.setData(data.analysis.charts.ema_21);
      sma200.setData(data.analysis.charts.sma_200);
      const fib = data.analysis.fibs;
      series.createPriceLine({ price: fib.golden, color: '#eab308', lineWidth: 2, title: '0.618 GOLDEN' });
      chart.timeScale().fitContent();
    }
    if(data.plan.status === 'READY') {
      document.getElementById('results').style.display = 'block';
      const p = data.plan;
      document.getElementById('badge-mode').innerText = p.mode;
      document.getElementById('rationale').innerText = p.rationale;
      const list = document.getElementById('order-list');
      list.innerHTML = '';
      p.orders.forEach(o => {
        list.innerHTML += `<div style="display:flex; justify-content:space-between; font-size:13px; padding: 12px 0; border-bottom:1px solid rgba(255,255,255,0.05);">
          <span>BUY $${o.amount.toLocaleString()}</span><span style="font-family:monospace; color:var(--primary-bright);">@ ${o.price.toLocaleString()}</span></div>`;
      });
    }
  }
</script>
{% endblock %}