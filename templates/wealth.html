{% extends "base.html" %}
{% block content %}
<script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>

<style>
/* ... [Existing Animations & Styles] ... */
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
@keyframes scan { 0% { top: 0%; opacity: 0; } 50% { opacity: 1; } 100% { top: 100%; opacity: 0; } }
@keyframes pulse-glow { 0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); } 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); } }
@keyframes slide-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

.spinner {
   width: 40px; height: 40px;
   border: 4px solid var(--glass-border);
   border-top: 4px solid var(--primary);
   border-radius: 50%;
   animation: spin 1s linear infinite;
   margin: 0 auto;
}
.pulse-btn { animation: pulse-glow 2s infinite; }
.radar-grid {
    background-image: linear-gradient(rgba(56, 189, 248, 0.1) 1px, transparent 1px), linear-gradient(90deg, rgba(56, 189, 248, 0.1) 1px, transparent 1px);
    background-size: 40px 40px;
    width: 100%; height: 100%;
    position: relative;
    overflow: hidden;
}
.radar-scan {
    position: absolute; width: 100%; height: 4px;
    background: linear-gradient(90deg, transparent, var(--success), transparent);
    box-shadow: 0 0 15px var(--success);
    animation: scan 3s ease-in-out infinite;
    top: 0; left: 0;
}
.results-enter { animation: slide-in 0.5s ease-out forwards; }

/* CALIBRATION PANEL STYLES */
.calibration-panel {
    background: rgba(0,0,0,0.3);
    border: 1px solid var(--glass-border);
    border-radius: 6px;
    padding: 15px;
    margin-bottom: 20px;
    display: none; /* Hidden by default */
}
.cal-toggle {
    font-size: 11px; 
    color: var(--primary); 
    cursor: pointer; 
    text-decoration: underline; 
    margin-bottom: 10px; 
    display: inline-block;
}
</style>

<div class="text-center" style="margin-bottom: 40px;">
  <div class="pill">INSTITUTIONAL GRADE</div>
  <h1 class="display-title">Wealth <span class="gradient-text">OS</span></h1>
  <p class="lead-text" style="max-width: 600px; margin: 10px auto; color: var(--text-muted);">
    Calibrated Macro Cycle & Micro Trend Execution.
  </p>
</div>

<div class="bento-grid">
  
  <div class="bento-card">
    <div style="margin-bottom: 20px;">
      <h3 style="color: #fff; margin-bottom: 4px;"><span class="gradient-text">Step 1:</span> Tactical Setup</h3>
      <p style="font-size: 13px; color: var(--text-muted);">Define strategy and calibrate anchors.</p>
    </div>

    <div style="margin-bottom: 16px;">
      <label class="label">STRATEGIC PROFILE</label>
      <select id="strategy" class="input" style="cursor: pointer; font-weight: 700; border-left: 4px solid var(--primary);">
        <option value="ACCUMULATOR">üõ°Ô∏è ASSET ACCUMULATOR (Pure HODL)</option>
        <option value="CYCLE">üîÑ CYCLE INVESTOR (Grid Extraction)</option>
        <option value="HYBRID">üöÄ HYBRID (Alt-Beta Hunter)</option>
      </select>
    </div>

    <div style="margin-bottom: 16px;">
      <label class="label">TARGET ASSET</label>
      <input id="ticker" class="input" value="BTC/USDT" style="text-transform: uppercase; letter-spacing: 1px; font-weight: 700;">
    </div>
    
    <div style="margin-bottom: 16px;">
      <label class="label">DEPLOYABLE CAPITAL ($)</label>
      <input id="capital" class="input" type="number" value="50000" style="font-family: monospace; font-weight: 700;">
    </div>

    <div class="cal-toggle" onclick="toggleCalibration()">+ Advanced Calibration (Manual Override)</div>
    
    <div id="calibration-box" class="calibration-panel">
        <div style="color: #fff; font-size: 12px; font-weight: 700; margin-bottom: 10px;">MACRO ANCHOR (Cycle Low)</div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px;">
            <input id="macro_low_date" class="input" type="date" value="2022-11-21" style="font-size: 11px;">
            <input id="macro_low_price" class="input" type="number" placeholder="Price ($)" value="15476" style="font-size: 11px;">
        </div>
        
        <div style="color: #fff; font-size: 12px; font-weight: 700; margin-bottom: 10px;">MICRO ANCHOR (Current Leg)</div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
            <input id="micro_low_date" class="input" type="date" placeholder="Start Date" style="font-size: 11px;">
            <input id="micro_low_price" class="input" type="number" placeholder="Low Price ($)" style="font-size: 11px;">
        </div>
        <div style="color: var(--text-muted); font-size: 10px; margin-top: 5px; font-style: italic;">Leave blank to use Auto-Detection (7Y scan).</div>
    </div>

    <button onclick="runAnalysis()" id="run-btn" class="btn primary pulse-btn" style="width: 100%; display: flex; justify-content: center; align-items: center; gap: 10px; padding: 16px;">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>
      <span style="font-weight: 800; letter-spacing: 1px;">INITIALIZE ENGINE</span>
    </button>
  </div>

  <div class="bento-card" id="results-panel" style="border-left: 4px solid var(--glass-border); position: relative; overflow: hidden;">
    <div id="results-standby" style="position: absolute; top:0; left:0; width:100%; height:100%; background: #0b0f19; z-index: 20; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px;">
        <div style="font-size: 30px; opacity: 0.5; margin-bottom: 15px;">üîí</div>
        <div style="font-weight: 700; color: #fff; letter-spacing: 1px;">PROTOCOL LOCKED</div>
        <div style="color: var(--text-muted); font-size: 12px; margin-top: 5px;">Awaiting Initialization Signal.</div>
    </div>

    <div id="results-content" style="opacity: 0;">
        <div style="margin-bottom: 15px;">
          <h3 style="color: #fff; margin-bottom: 4px;"><span class="gradient-text">Step 2:</span> Execution Protocol</h3>
        </div>
        
        <div style="background: rgba(255,255,255,0.03); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <span class="label" style="margin:0;">DETECTED PHASE</span>
                <div id="badge-mode" style="padding: 5px 10px; border-radius: 4px; font-size: 11px; font-weight: 800; text-transform: uppercase; background: var(--glass-border); color: #fff; letter-spacing: 0.5px;">--</div>
            </div>
            <p id="rationale" style="font-size: 14px; color: #fff; line-height: 1.5; margin: 0;">--</p>
        </div>
        
        <div id="pattern-alert" style="display: none; background: rgba(16, 185, 129, 0.1); border: 1px solid #10b981; padding: 10px; border-radius: 6px; margin-bottom: 20px;">
            <div style="color: #10b981; font-weight: 700; font-size: 12px; margin-bottom: 4px;">üïØÔ∏è CANDLE PATTERN DETECTED</div>
            <div id="pattern-msg" style="color: #fff; font-size: 13px;">Bullish Engulfing in Buy Zone</div>
        </div>

        <div>
            <div class="label" style="margin-bottom: 10px;">TACTICAL ORDERS</div>
            <div id="orders-list" style="display: grid; gap: 8px;"></div>
        </div>
    </div>
  </div>

  <div class="bento-card wide" style="height: 550px; padding: 0; overflow: hidden; position: relative; background: #020617;">
     <div id="chart-placeholder" class="radar-grid" style="display: flex; flex-direction: column; justify-content: center; align-items: center;">
        <div class="radar-scan"></div>
        <div style="z-index: 5; text-align: center; background: rgba(2,6,23,0.8); padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border); backdrop-filter: blur(4px);">
            <div style="font-weight: 700; color: #fff; letter-spacing: 2px; font-size: 18px; margin-bottom: 5px;">MARKET SCANNER ACTIVE</div>
            <div style="color: var(--text-muted); font-size: 12px;">Monitoring 7-Year Cycle Structure...</div>
        </div>
     </div>

     <div id="chart-loader" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; z-index: 10;">
        <div class="spinner"></div>
        <div style="margin-top: 20px; font-weight: 700; color: #fff; letter-spacing: 1px; font-size: 14px;">PROCESSING DATA...</div>
        <div style="color: var(--text-muted); font-size: 12px; margin-top: 5px;">Applying Calibration Anchors</div>
     </div>

     <div id="chart-mount" style="width: 100%; height: 100%; visibility: hidden; position: absolute; top: 0; left: 0;"></div>
  </div>
</div>

<script>
  function toggleCalibration() {
    const p = document.getElementById('calibration-box');
    p.style.display = (p.style.display === 'block') ? 'none' : 'block';
  }

  const chart = LightweightCharts.createChart(document.getElementById('chart-mount'), {
    layout: { background: { type: 'solid', color: '#020617' }, textColor: '#94a3b8' },
    grid: { vertLines: { color: 'rgba(30, 41, 59, 0.5)' }, horzLines: { color: 'rgba(30, 41, 59, 0.5)' } },
    rightPriceScale: { borderColor: '#334155' },
    timeScale: { borderColor: '#334155', timeVisible: true },
  });
  
  const candles = chart.addCandlestickSeries({ upColor: '#10b981', downColor: '#ef4444', borderVisible: false });
  const emaSeries = chart.addLineSeries({ color: '#38bdf8', lineWidth: 2, title: '21 EMA' });
  const smaSeries = chart.addLineSeries({ color: 'rgba(255,255,255,0.5)', lineWidth: 1, lineStyle: 2, title: '200 SMA' });
  
  new ResizeObserver(e => chart.applyOptions({ width: e[0].contentRect.width, height: e[0].contentRect.height })).observe(document.getElementById('chart-mount'));
  let primitives = []; 

  async function runAnalysis() {
    const ticker = document.getElementById('ticker').value;
    const capital = document.getElementById('capital').value;
    const strategy = document.getElementById('strategy').value;
    
    // Capture Calibration Inputs
    const overrides = {
        macro_low_date: document.getElementById('macro_low_date').value,
        macro_low_price: document.getElementById('macro_low_price').value,
        micro_low_date: document.getElementById('micro_low_date').value,
        micro_low_price: document.getElementById('micro_low_price').value
    };

    const btn = document.getElementById('run-btn');
    const placeholder = document.getElementById('chart-placeholder');
    const loader = document.getElementById('chart-loader');
    const chartMount = document.getElementById('chart-mount');
    
    btn.innerHTML = 'PROCESSING...';
    btn.disabled = true;
    btn.classList.remove('pulse-btn'); 
    placeholder.style.display = 'none'; 
    loader.style.display = 'block'; 
    
    // Remove old lines/shapes
    primitives.forEach(p => { try { candles.removePriceLine(p); } catch(e){} });
    primitives = [];
    // Clear Histogram series if we add one later for clouds (Todo in next step)

    try {
      const res = await fetch('/api/analyze-s-jan', {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ symbol: ticker, capital: parseFloat(capital), strategy: strategy, overrides: overrides })
      });
      const data = await res.json();

      loader.style.display = 'none'; 
      chartMount.style.visibility = 'visible'; 

      if(data.candles) {
        candles.setData(data.candles.sort((a,b)=>a.time-b.time));
        emaSeries.setData(data.analysis.charts.ema_21);
        smaSeries.setData(data.analysis.charts.sma_200);
        
        const zones = data.analysis.zones;
        const fibs = data.analysis.fibs;

        // DRAW ZONES (Lines for now, will upgrade to Filled Shapes next)
        zones.deploy.levels.forEach((lvl, i) => primitives.push(candles.createPriceLine({ price: lvl, color: '#10b981', lineWidth: 1, lineStyle: 2, axisLabelVisible: false, title: `DEPLOY ${i+1}` })));
        if (strategy !== 'ACCUMULATOR') {
            zones.extract.levels.forEach((lvl, i) => primitives.push(candles.createPriceLine({ price: lvl, color: '#ef4444', lineWidth: 1, lineStyle: 2, axisLabelVisible: false, title: `EXTRACT ${i+1}` })));
        }
        
        // DRAW PREVIOUS TOP (Cloud Context)
        if(fibs.prev_top) {
             primitives.push(candles.createPriceLine({ price: fibs.prev_top, color: '#64748b', lineWidth: 1, lineStyle: 3, axisLabelVisible: false, title: 'PREV CYCLE TOP' }));
        }

        primitives.push(candles.createPriceLine({ price: fibs.macro_50, color: '#f97316', lineWidth: 2, lineStyle: 0, axisLabelVisible: true, title: '‚ö†Ô∏è CYCLE BREAKER (0.5)' }));
        
        chart.timeScale().fitContent();
      }

      if(data.plan) {
        document.getElementById('results-standby').style.display = 'none';
        const content = document.getElementById('results-content');
        content.style.opacity = '1';
        content.classList.add('results-enter');

        const p = data.plan;
        const badge = document.getElementById('badge-mode');
        
        let badgeColor = 'var(--glass-border)';
        if (p.mode.includes('STAIR_STEP') || p.mode.includes('CLIMB')) badgeColor = '#10b981';
        if (p.mode.includes('WARNING') || p.mode.includes('BREAKDOWN')) badgeColor = '#ef4444';
        badge.innerText = p.mode;
        badge.style.background = badgeColor;

        document.getElementById('rationale').innerText = p.rationale;
        
        // CANDLE ALERT
        const alertBox = document.getElementById('pattern-alert');
        if (data.analysis.patterns && data.analysis.patterns.length > 0) {
            alertBox.style.display = 'block';
            document.getElementById('pattern-msg').innerText = data.analysis.patterns.join(", ");
        } else {
            alertBox.style.display = 'none';
        }

        const list = document.getElementById('orders-list');
        list.innerHTML = '';
        
        p.orders.forEach(o => {
            let color = '#10b981'; 
            if (o.action && (o.action.includes('SELL') || o.action.includes('EXTRACT'))) color = '#ef4444';
            if (o.action && o.action.includes('ALT')) color = '#a855f7'; 
            if (o.action && o.action.includes('HOLD')) color = '#f97316'; 

            list.innerHTML += `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 6px; border-left: 3px solid ${color}; margin-bottom: 8px;">
              <div>
                <div style="font-size:10px; color:var(--text-muted); font-weight:700; text-transform:uppercase;">${o.note}</div>
                <div style="font-weight:700; color:#fff; font-size:14px; margin-top:2px;">
                    <span style="color:${color};">${o.action.replace(/_/g, ' ')}</span> 
                    ${o.amount !== '---' ? '$'+o.amount.toLocaleString() : ''}
                </div>
              </div>
              <div style="font-family:monospace; color:var(--primary-bright); font-size:14px; font-weight:700;">@ ${o.price.toLocaleString()}</div>
            </div>`;
        });
      }
    } catch(e) { 
      console.error(e); 
      alert("Analysis Error: " + e.message);
      placeholder.style.display = 'flex'; 
      chartMount.style.visibility = 'hidden';
    } 
    finally { 
      loader.style.display = 'none';
      btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg><span style="font-weight: 800; letter-spacing: 1px;">INITIALIZE ENGINE</span>`;
      btn.disabled = false; 
      btn.classList.add('pulse-btn'); 
    }
  }
</script>
{% endblock %}