{% extends "base.html" %}
{% block content %}

<script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>

<style>
  /* TERMINAL THEME */
  :root {
    --bg-dark: #131722;
    --panel-bg: #1E222D;
    --border: 1px solid #2A2E39;
    --text-main: #D9D9D9;
    --text-muted: #787B86;
    --accent-green: #089981;
    --accent-red: #F23645;
    --accent-blue: #2962FF;
  }

  body { background-color: var(--bg-dark); }

  /* Grid Layout */
  .terminal-grid {
    display: grid;
    grid-template-columns: 280px 1fr;
    grid-template-rows: 60px 1fr;
    height: calc(100vh - 80px); /* Adjust for nav */
    max-width: 100%;
    overflow: hidden;
  }

  /* 1. Top Bar (Header) */
  .terminal-header {
    grid-column: 1 / -1;
    background: var(--panel-bg);
    border-bottom: var(--border);
    display: flex;
    align-items: center;
    padding: 0 20px;
    justify-content: space-between;
  }

  .ticker-display {
    display: flex;
    align-items: baseline;
    gap: 10px;
  }
  .ticker-main { font-size: 20px; font-weight: 700; color: #fff; letter-spacing: 1px; }
  .price-live { font-family: 'Roboto Mono', monospace; color: var(--accent-green); font-size: 16px; }

  /* 2. Sidebar (Controls) */
  .terminal-sidebar {
    background: var(--panel-bg);
    border-right: var(--border);
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  /* Input Styling */
  .search-box {
    display: flex;
    gap: 5px;
  }
  .input-dark {
    background: #2A2E39;
    border: 1px solid #434651;
    color: #fff;
    padding: 8px;
    border-radius: 4px;
    width: 100%;
    font-family: 'Roboto Mono', monospace;
    text-transform: uppercase;
  }
  .btn-run {
    background: var(--accent-blue);
    color: #fff;
    border: none;
    border-radius: 4px;
    padding: 0 15px;
    font-weight: 600;
    cursor: pointer;
  }
  .btn-run:hover { background: #1e53e5; }

  /* Data Table Styling */
  .data-table {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }
  .data-row {
    display: flex;
    justify-content: space-between;
    padding: 10px;
    background: rgba(255,255,255,0.02);
    font-size: 13px;
  }
  .data-label { color: var(--text-muted); text-transform: uppercase; font-size: 11px; }
  .data-val { color: var(--text-main); font-family: 'Roboto Mono', monospace; font-weight: 600; }

  /* Bias Badges */
  .badge { padding: 4px 8px; border-radius: 3px; font-size: 11px; font-weight: 700; }
  .b-bull { background: rgba(8, 153, 129, 0.2); color: var(--accent-green); }
  .b-bear { background: rgba(242, 54, 69, 0.2); color: var(--accent-red); }
  .b-neu { background: rgba(255, 255, 255, 0.1); color: #ccc; }

  /* 3. Chart Area */
  .terminal-chart {
    background: var(--bg-dark);
    position: relative;
    width: 100%;
    height: 100%;
  }
</style>

<div class="terminal-grid">
  
  <div class="terminal-header">
    <div class="ticker-display">
      <span class="ticker-main" id="display-ticker">BTC/USDT</span>
      <span class="price-live" id="display-price">--</span>
    </div>
    <div style="font-size: 12px; color: #666;">S JAN MARKET STRUCTURE MAP</div>
  </div>

  <div class="terminal-sidebar">
    <div class="search-box">
      <input type="text" id="tickerInput" class="input-dark" value="BTC/USDT">
      <button onclick="loadAnalysis()" class="btn-run">GO</button>
    </div>

    <div style="height: 1px; background: #2A2E39; margin: 10px 0;"></div>

    <div class="data-table" id="scorecard" style="display: none;">
      
      <div class="data-row">
        <span class="data-label">BIAS</span>
        <span id="bias-badge" class="badge b-neu">--</span>
      </div>

      <div class="data-row">
        <span class="data-label">GRADE</span>
        <span class="data-val" id="grade-val">--</span>
      </div>

      <div class="data-row">
        <span class="data-label">SUPPLY</span>
        <span class="data-val" id="sup-val" style="color: var(--accent-red);">--</span>
      </div>

      <div class="data-row">
        <span class="data-label">DEMAND</span>
        <span class="data-val" id="dem-val" style="color: var(--accent-green);">--</span>
      </div>

    </div>

    <div id="loader" style="color: #666; font-size: 12px; text-align: center; margin-top: 20px;">
      READY TO SCAN
    </div>
  </div>

  <div id="chart-mount" class="terminal-chart"></div>

</div>

<script>
  // 1. SETUP CHART (Professional Theme)
  const container = document.getElementById('chart-mount');
  const chart = LightweightCharts.createChart(container, {
    layout: { background: { color: '#131722' }, textColor: '#787B86' },
    grid: { vertLines: { color: '#1E222D' }, horzLines: { color: '#1E222D' } },
    rightPriceScale: { borderColor: '#2A2E39', scaleMargins: { top: 0.1, bottom: 0.1 } },
    timeScale: { borderColor: '#2A2E39', timeVisible: true },
    crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
  });

  const candleSeries = chart.addCandlestickSeries({
    upColor: '#089981', downColor: '#F23645', 
    borderVisible: false, wickUpColor: '#089981', wickDownColor: '#F23645'
  });

  // Responsive Resize
  new ResizeObserver(entries => {
    if (entries.length === 0 || entries[0].target !== container) { return; }
    const newRect = entries[0].contentRect;
    chart.applyOptions({ width: newRect.width, height: newRect.height });
  }).observe(container);

  // 2. LOGIC
  async function loadAnalysis() {
    const ticker = document.getElementById('tickerInput').value;
    const loader = document.getElementById('loader');
    const scorecard = document.getElementById('scorecard');
    
    loader.innerText = "SCANNING MARKET...";
    loader.style.display = 'block';
    scorecard.style.display = 'none';

    try {
      const response = await fetch('/api/analyze-s-jan', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ symbol: ticker })
      });
      
      const json = await response.json();
      
      // Update Header
      document.getElementById('display-ticker').innerText = ticker.toUpperCase();
      
      // Plot Candles (Check if data exists)
      if (json.candles && json.candles.length > 0) {
        const sorted = json.candles.sort((a, b) => a.time - b.time);
        candleSeries.setData(sorted);
        chart.timeScale().fitContent();
        
        // Update Price in Header
        const lastClose = sorted[sorted.length - 1].close;
        document.getElementById('display-price').innerText = '$' + lastClose.toFixed(2);
      } else {
        loader.innerText = "NO DATA FOUND (Try valid symbol)";
        return;
      }

      // Update Scorecard
      const s = json.structure;
      const m = json.map;
      
      loader.style.display = 'none';
      scorecard.style.display = 'flex';
      
      // Badges
      const biasBadge = document.getElementById('bias-badge');
      biasBadge.innerText = s.bias.replace('_', ' ');
      biasBadge.className = 'badge';
      if(s.bias.includes('BULL')) biasBadge.classList.add('b-bull');
      else if(s.bias.includes('BEAR')) biasBadge.classList.add('b-bear');
      else biasBadge.classList.add('b-neu');

      document.getElementById('grade-val').innerText = s.grade;
      document.getElementById('sup-val').innerText = s.nearest_supply_level ? s.nearest_supply_level.toFixed(2) : '--';
      document.getElementById('dem-val').innerText = s.nearest_demand_level ? s.nearest_demand_level.toFixed(2) : '--';

      // Draw Lines
      if(m.supply_zones) {
        m.supply_zones.forEach(z => {
           candleSeries.createPriceLine({
             price: z.level, color: '#F23645', lineWidth: 2, 
             title: `SUPPLY (${z.tf})`, axisLabelVisible: true 
           });
        });
      }
      if(m.demand_zones) {
        m.demand_zones.forEach(z => {
           candleSeries.createPriceLine({
             price: z.level, color: '#089981', lineWidth: 2, 
             title: `DEMAND (${z.tf})`, axisLabelVisible: true 
           });
        });
      }

    } catch (err) {
      console.error(err);
      loader.innerText = "API ERROR";
    }
  }
</script>
{% endblock %}