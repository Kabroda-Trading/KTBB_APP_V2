<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kabroda | Session Control</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/site.css">
    <style>
        .gradient-text { background: linear-gradient(to right, #00ff9d, #06b6d4); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    </style>
</head>
<body>
    
    {% include 'nav.html' %}

    <div style="width: 100%; max-width: 1200px; margin: 0 auto; display: flex; flex-direction: column; gap: 30px; padding-top: 40px;">
      
      <div style="display: flex; justify-content: space-between; align-items: flex-end; padding-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1);">
        <div>
          <div class="pill" style="margin-bottom: 8px; font-size: 11px; letter-spacing: 2px; color: #06b6d4; border: 1px solid rgba(6,182,212,0.3); padding: 4px 10px; border-radius: 100px; display: inline-block;">BATTLEBOX COMMAND</div>
          <h1 style="font-size: 36px; margin: 0; text-transform: uppercase; letter-spacing: 0.05em; line-height: 1; text-shadow: 0 0 30px rgba(0,255,157,0.15); color: #fff;">
            Session <span class="gradient-text">Control</span>
          </h1>
        </div>
        <div style="text-align: right;">
          <div style="font-size: 11px; color: #94a3b8; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 2px;">Operative ID</div>
          <div style="font-family: monospace; color: #22d3ee; font-size: 16px; letter-spacing: 0.1em; font-weight: 700; text-transform: uppercase;">
            {{ user.username if user.username else user.email }}
          </div>
        </div>
      </div>

      <div class="bento-card wide" style="border-left: 4px solid #00ff9d; display: flex; flex-direction: column; gap: 24px; padding: 30px; background: #0f1623; border: 1px solid rgba(255,255,255,0.05);">
        <div style="display: flex; flex-wrap: wrap; gap: 24px; align-items: flex-end; justify-content: space-between;">
          <div style="flex: 1; min-width: 240px;">
            <label class="label" style="color: #22d3ee; font-size: 12px; margin-bottom: 8px; letter-spacing: 1px;">TARGET ASSET</label>
            <div style="position: relative;">
              <select id="symbol" class="input" style="cursor:pointer; font-weight: 700; font-size: 16px; height: 55px; appearance: none; padding-right: 40px; text-transform: uppercase; width: 100%; background: #050b14; color: #fff; border: 1px solid rgba(255,255,255,0.1); padding: 15px;">
                <option value="BTCUSDT">BTC (Bitcoin)</option>
                <option value="ETHUSDT">ETH (Ethereum)</option>
                <option value="SOLUSDT">SOL (Solana)</option>
                <option value="XRPUSDT">XRP (Ripple)</option>
                <option value="DOGEUSDT">DOGE (Dogecoin)</option>
                <option value="TRXUSDT">TRX (Tron)</option>
              </select>
              <span style="position: absolute; right: 20px; top: 50%; transform: translateY(-50%); color: #22d3ee; pointer-events: none;">‚ñº</span>
            </div>
          </div>
          <div style="flex: 1; min-width: 240px;">
            <label class="label" style="color: #10b981; font-size: 12px; margin-bottom: 8px; letter-spacing: 1px;">TARGET SESSION</label>
            <div style="position: relative;">
              <select id="sessionSelect" class="input" style="cursor:pointer; font-weight: 700; font-size: 16px; height: 55px; appearance: none; padding-right: 40px; border-color: rgba(16, 185, 129, 0.4); width: 100%; background: #050b14; color: #fff; border: 1px solid rgba(255,255,255,0.1); padding: 15px;">
                <option value="us_ny_futures">üá∫üá∏ NY FUTURES (08:30 ET)</option>
                <option value="us_ny_equity">üá∫üá∏ NY EQUITY (09:30 ET)</option>
                <option value="eu_london">üá¨üáß LONDON (08:00 GMT)</option>
                <option value="asia_tokyo">üáØüáµ TOKYO (09:00 JST)</option>
                <option value="au_sydney">üá¶üá∫ SYDNEY (10:00 AEDT)</option>
                <option value="utc_default">üåê UTC (CRYPTO DEFAULT)</option>
              </select>
              <span style="position: absolute; right: 20px; top: 50%; transform: translateY(-50%); color: #10b981; pointer-events: none;">‚ñº</span>
            </div>
          </div>
          <div style="flex: 0 0 auto;">
            <button id="levelsBtn" class="btn primary" onclick="calibrateBattlefield()" style="height: 55px; padding: 0 32px; font-size: 14px; font-weight: 800; letter-spacing: 1px; white-space: nowrap; box-shadow: 0 0 20px rgba(0,255,157,0.2); background: #00ff9d; color: #000; border: none; cursor: pointer;">
              <span style="margin-right: 8px;">‚ö° INITIATE CALIBRATION</span>
            </button>
          </div>
        </div>
        <div id="status" style="border-top: 1px solid rgba(255,255,255,0.08); padding-top: 15px; font-size: 13px; font-family: monospace; color: #94a3b8; text-align: right;">
          > SYSTEM STANDBY... SELECT TARGET
        </div>
      </div>

      <div class="bento-card wide" style="padding: 30px; background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.08);">
        <h3 style="font-size: 14px; color: #94a3b8; margin-bottom: 25px; text-transform: uppercase; letter-spacing: 0.15em; display:flex; align-items:center; gap:10px;">
          <span style="width:6px; height:6px; background:#fff; border-radius:50%; opacity:0.5;"></span> MISSION TIMELINE <span style="opacity:0.3; font-size:11px;">(LOCAL SYNC)</span>
        </h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
          <div style="background: rgba(255,255,255,0.03); border-left: 3px solid #94a3b8; padding: 20px; border-radius: 0 8px 8px 0;">
            <div style="font-size: 11px; color: #94a3b8; font-weight: 800; letter-spacing: 0.1em; margin-bottom: 6px;">MARKET OPEN</div>
            <div id="time_open" style="font-size: 22px; color: #fff; font-weight: 700; font-family: monospace;">--:--</div>
            <div style="font-size: 12px; color: #94a3b8; margin-top: 4px;">Session Start</div>
          </div>
          <div style="background: rgba(16, 185, 129, 0.05); border-left: 3px solid #f59e0b; padding: 20px; border-radius: 0 8px 8px 0;">
            <div style="font-size: 11px; color: #f59e0b; font-weight: 800; letter-spacing: 0.1em; margin-bottom: 6px;">CALIBRATION</div>
            <div id="time_calib" style="font-size: 22px; color: #fff; font-weight: 700; font-family: monospace;">--:--</div>
            <div style="font-size: 12px; color: #f59e0b; margin-top: 4px;">Initial Balance (30m)</div>
          </div>
          <div style="background: rgba(56, 189, 248, 0.05); border-left: 3px solid #10b981; padding: 20px; border-radius: 0 8px 8px 0;">
            <div style="font-size: 11px; color: #10b981; font-weight: 800; letter-spacing: 0.1em; margin-bottom: 6px;">EXECUTION</div>
            <div id="time_exec" style="font-size: 22px; color: #fff; font-weight: 700; font-family: monospace;">--:--</div>
            <div style="font-size: 12px; color: #10b981; margin-top: 4px;">Strategy Active</div>
          </div>
          <div style="background: rgba(168, 85, 247, 0.05); border-left: 3px solid #a855f7; padding: 20px; border-radius: 0 8px 8px 0;">
            <div style="font-size: 11px; color: #a855f7; font-weight: 800; letter-spacing: 0.1em; margin-bottom: 6px;">CLOSE</div>
            <div id="time_close" style="font-size: 22px; color: #fff; font-weight: 700; font-family: monospace;">--:--</div>
            <div style="font-size: 12px; color: #a855f7; margin-top: 4px;">Session End</div>
          </div>
        </div>
      </div>

      <div class="bento-card wide" style="position: relative; overflow: hidden; min-height: 320px; padding: 30px; background: #0f1623; border: 1px solid rgba(255,255,255,0.08);">
        <div style="position: absolute; inset: 0; background-image: radial-gradient(rgba(255,255,255,0.1) 1px, transparent 1px); background-size: 20px 20px; opacity: 0.1; pointer-events: none;"></div>
        <div style="display: flex; flex-wrap: wrap; gap: 20px; justify-content: space-between; align-items: flex-start; margin-bottom: 40px; position: relative;">
          <div>
            <h3 style="display: flex; align-items: center; gap: 12px; margin: 0 0 8px 0; font-size: 18px; color: #fff;">
              <span style="width: 10px; height: 10px; background: #10b981; border-radius: 50%; box-shadow: 0 0 10px #10b981;"></span>
              BATTLEFIELD TELEMETRY
            </h3>
            <p style="font-size: 13px; color: #888; margin: 0;">Live Structural Levels & Triggers</p>
          </div>
          <div style="display: flex; gap: 12px;">
            <button id="tvCopyBtn" class="btn secondary" onclick="copyForTV()" style="display:none; font-size: 12px; padding: 12px 20px; font-weight:700; background: transparent; border: 1px solid rgba(255,255,255,0.2); color: #e2e8f0; cursor: pointer;">COPY INDICATOR DATA</button>
            <button id="openGptBtn" onclick="openLaunchModal()" style="display:none; cursor: pointer; background: #00ff9d; color: #000; font-weight: 900; font-size: 12px; padding: 12px 24px; border: none; border-radius: 4px; box-shadow: 0 0 20px rgba(0, 255, 157, 0.4); text-transform: uppercase; letter-spacing: 1px; transition: all 0.2s;">
              üöÄ LAUNCH BATTLEBOX AI
            </button>
          </div>
        </div>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; position: relative;">
          <div class="lvl-card c-red">
            <div class="lvl-lbl" style="color: #fca5a5;">DAILY RESISTANCE</div>
            <div id="lv_dr" class="lvl-val">‚Äî</div>
          </div>
          <div class="lvl-card c-green">
            <div class="lvl-lbl" style="color: #6ee7b7;">BREAKOUT TRIGGER</div>
            <div id="lv_bo" class="lvl-val">‚Äî</div>
          </div>
          <div class="lvl-card c-purple">
            <div class="lvl-lbl" style="color: #d8b4fe;">BREAKDOWN TRIGGER</div>
            <div id="lv_bd" class="lvl-val">‚Äî</div>
          </div>
          <div class="lvl-card c-blue">
            <div class="lvl-lbl" style="color: #93c5fd;">DAILY SUPPORT</div>
            <div id="lv_ds" class="lvl-val">‚Äî</div>
          </div>
        </div>
        <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; color: #94a3b8; font-size: 13px; font-family: monospace;">
          <span>30M ANCHOR HIGH: <strong id="lv_30h" style="color: #fff;">‚Äî</strong></span>
          <span>30M ANCHOR LOW: <strong id="lv_30l" style="color: #fff;">‚Äî</strong></span>
        </div>
      </div>
    </div>

    <div id="launchModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); backdrop-filter:blur(5px); z-index:9999; align-items:center; justify-content:center;">
        <div style="background:#111; border:1px solid #333; padding:40px; border-radius:12px; max-width:500px; width:90%; text-align:center; box-shadow:0 0 50px rgba(0,0,0,0.8);">
            <h2 style="color:#fff; margin-bottom:10px; font-size:24px;">NEURAL LINK ESTABLISHED</h2>
            <div style="height:2px; width:50px; background:#00ff9d; margin:0 auto 30px auto;"></div>
            <div style="text-align:left; background:#000; padding:20px; border-radius:8px; border:1px solid #222; margin-bottom:30px;">
                <div style="color:#00ff9d; font-size:12px; font-weight:bold; margin-bottom:5px;">‚úì FULL COMMAND PROMPT COPIED</div>
                <div style="font-family:monospace; color:#ccc; font-size:12px; word-break: break-all;">
                    Generate today‚Äôs Daily Market Review... { JSON }
                </div>
            </div>
            <p style="color:#888; font-size:14px; margin-bottom:30px; line-height:1.5;">
                The BattleBox Command Prompt is ready.<br><strong>Paste (Ctrl+V)</strong> into the GPT.
            </p>
            <div style="display:flex; gap:10px; justify-content:center;">
                <button onclick="closeLaunchModal()" style="background:transparent; border:1px solid #444; color:#888; padding:12px 24px; cursor:pointer; font-weight:bold; border-radius:4px;">CANCEL</button>
                <button onclick="proceedToAI()" style="background:#00ff9d; color:#000; border:none; padding:12px 30px; cursor:pointer; font-weight:900; border-radius:4px;">PROCEED TO TERMINAL &rarr;</button>
            </div>
        </div>
    </div>

    <script>
      const BATTLEBOX_GPT_URL = "https://chatgpt.com/g/g-6949c388d8c48191833b3c35af02d809-kabroda-trading-battlebox";
      const SPECS = {
        "us_ny_futures": { tz: "America/New_York", h: 8, m: 30, label: "NY FUTURES" },
        "us_ny_equity": { tz: "America/New_York", h: 9, m: 30, label: "NY EQUITY" },
        "eu_london": { tz: "Europe/London", h: 8, m: 0, label: "LONDON" },
        "asia_tokyo": { tz: "Asia/Tokyo", h: 9, m: 0, label: "TOKYO" },
        "au_sydney": { tz: "Australia/Sydney", h: 10, m: 0, label: "SYDNEY" },
        "utc_default": { tz: "UTC", h: 0, m: 0, label: "UTC CORE" }
      };

      let _lastDmrPayload = null;
      
      // UPDATED FORMATTER (v3.1)
      function fmt(x){ 
        if(!x && x !== 0) return "‚Äî";
        const f = parseFloat(x);
        if(isNaN(f)) return "‚Äî";
        
        // 1. Get current Asset
        const sym = document.getElementById("symbol").value;
        
        // 2. Specific Asset Overrides
        if(sym.includes("DOGE")) return f.toFixed(7);
        if(sym.includes("TRX")) return f.toFixed(5);
        if(sym.includes("XRP")) return f.toFixed(5);
        
        // 3. General Price Magnitude Rule
        if(Math.abs(f) < 1.0 && Math.abs(f) > 0) return f.toFixed(6);
        
        // 4. Default for High Value Assets (BTC, SOL, ETH)
        return f.toFixed(2); 
      }

      function openLaunchModal() {
          if (!_lastDmrPayload) { alert("Please Initialize Sequence First"); return; }
          const payload = { ..._lastDmrPayload };
          payload.viewer = { local_tz: Intl.DateTimeFormat().resolvedOptions().timeZone, source: "browser" };
          const jsonBody = JSON.stringify(payload, null, 2);
          const promptText = `Generate today‚Äôs Daily Market Review using the Kabroda methodology.\nUse the following session packet as the authoritative data source:\n\n${jsonBody}`;
          navigator.clipboard.writeText(promptText);
          document.getElementById('launchModal').style.display = 'flex';
      }
      
      function closeLaunchModal() { document.getElementById('launchModal').style.display = 'none'; }
      function proceedToAI() { window.open(BATTLEBOX_GPT_URL, "_blank"); closeLaunchModal(); }

      function getSessionContext() {
        const key = document.getElementById("sessionSelect").value;
        const spec = SPECS[key] || SPECS["us_ny_futures"];
        const now = new Date();
        const targetTimeStr = now.toLocaleString("en-US", {timeZone: spec.tz, hour12: false});
        const targetDate = new Date(targetTimeStr); 
        const currentMins = (targetDate.getHours() * 60) + targetDate.getMinutes();
        const openMins = (spec.h * 60) + spec.m;
        let diff = currentMins - openMins;
        if (diff > 1200) diff -= 1440; 
        if (diff < -1200) diff += 1440;

        let uiMsg = "", uiColor = "#94a3b8", btnLabel = "‚ö° INITIATE CALIBRATION", isReview = false;

        if (diff < 0) {
           const h = Math.floor(Math.abs(diff) / 60);
           const m = Math.abs(diff % 60);
           uiMsg = `> ‚ö†Ô∏è PRE-MARKET: OPENS IN ${h}H ${m}M. BUTTON RUNS PREVIOUS SESSION.`;
           uiColor = "#22d3ee";
           btnLabel = "RUN PREVIOUS SESSION";
           isReview = true;
        } else if (diff >= 0 && diff < 30) {
           uiMsg = `> üü° MARKET OPEN | CALIBRATING LIVE DATA... READY IN ${30 - diff} MINS.`;
           uiColor = "#f59e0b";
        } else if (diff >= 30 && diff < 90) {
           uiMsg = `> üü¢ ACTIVE SESSION: ${spec.label} | INITIAL BALANCE | EXECUTION ONLINE.`;
           uiColor = "#10b981";
        } else if (diff >= 90 && diff < 480) { 
           uiMsg = `> üü¢ ACTIVE SESSION: ${spec.label} | SESSION FLOW | EXECUTION ONLINE.`;
           uiColor = "#10b981";
        } else {
           uiMsg = `> üîµ MARKET CLOSED. PREPARING NEXT SESSION.`;
           uiColor = "#94a3b8";
           btnLabel = "RUN REVIEW SESSION";
           isReview = true;
        }
        return { uiMsg, uiColor, btnLabel, isReview, now, diff };
      }

      function updateSessionStatus() {
        const ctx = getSessionContext();
        const btn = document.getElementById("levelsBtn");
        document.getElementById("status").innerHTML = ctx.uiMsg;
        document.getElementById("status").style.color = ctx.uiColor;
        
        if(btn.innerText !== "CALIBRATING...") {
            btn.innerText = ctx.btnLabel;
            if(ctx.isReview) {
               btn.style.border = "1px solid rgba(255,255,255,0.2)";
               btn.style.boxShadow = "none";
            } else if (ctx.uiColor.includes("success") || ctx.uiColor.includes("#10b981")) {
               btn.style.border = "1px solid #10b981";
               btn.style.boxShadow = "0 0 20px rgba(16, 185, 129, 0.2)";
            } else {
               btn.style.border = "1px solid #f59e0b";
               btn.style.boxShadow = "none";
            }
        }
        updateTimelineVisuals(ctx.now, ctx.diff);
      }

      function updateTimelineVisuals(now, diffMins) {
        const openTime = new Date(now.getTime() - (diffMins * 60000));
        const t_calib = new Date(openTime.getTime() + 30*60000);
        const t_close = new Date(openTime.getTime() + 8*60*60000); 
        const opt = {hour:'2-digit', minute:'2-digit'};
        document.getElementById("time_open").innerText = openTime.toLocaleTimeString([], opt);
        document.getElementById("time_calib").innerText = openTime.toLocaleTimeString([], opt) + " - " + t_calib.toLocaleTimeString([], opt);
        document.getElementById("time_exec").innerText = t_calib.toLocaleTimeString([], opt) + " +";
        document.getElementById("time_close").innerText = t_close.toLocaleTimeString([], opt);
      }

      async function calibrateBattlefield(){
        const sym = document.getElementById("symbol").value;
        const sess = document.getElementById("sessionSelect").value;
        const btn = document.getElementById("levelsBtn");
        const prevText = btn.innerText;
        btn.innerText = "CALIBRATING...";
        btn.disabled = true;
        try {
          const r = await fetch("/api/dmr/run-raw", {
            method: "POST", headers: {"Content-Type":"application/json"},
            body: JSON.stringify({ symbol: sym, session_id: sess })
          });
          const data = await r.json();
          _lastDmrPayload = data;
          const l = data.levels || {};
          const r30 = data.range_30m || {};
          
          // Updated to use the smart fmt() function
          document.getElementById("lv_ds").innerText = fmt(l.daily_support);
          document.getElementById("lv_dr").innerText = fmt(l.daily_resistance);
          document.getElementById("lv_bo").innerText = fmt(l.breakout_trigger);
          document.getElementById("lv_bd").innerText = fmt(l.breakdown_trigger);
          document.getElementById("lv_30h").innerText = fmt(r30.high);
          document.getElementById("lv_30l").innerText = fmt(r30.low);
          
          document.getElementById("tvCopyBtn").style.display = "inline-flex";
          document.getElementById("openGptBtn").style.display = "inline-flex"; 
          document.getElementById("status").innerText = "> SYSTEM READY. DATA SYNCED.";
          document.getElementById("status").style.color = "#10b981";
        } catch(e) {
          document.getElementById("status").innerText = "> ERROR: " + e.message;
        } finally {
          btn.disabled = false;
          btn.innerText = prevText;
          updateSessionStatus();
        }
      }

      async function copyForTV(){
        if (!_lastDmrPayload) return;
        const l = _lastDmrPayload.levels;
        const r = _lastDmrPayload.range_30m;
        // Also apply formatting to copied text
        const text = `${fmt(l.breakout_trigger)},${fmt(l.breakdown_trigger)},${fmt(l.daily_resistance)},${fmt(l.daily_support)},${fmt(r.high)},${fmt(r.low)}`;
        await navigator.clipboard.writeText(text);
        alert("COPIED for Indicator: " + text);
      }

      setInterval(updateSessionStatus, 1000);
      document.addEventListener("DOMContentLoaded", updateSessionStatus);
      document.getElementById("sessionSelect").addEventListener("change", updateSessionStatus);
    </script>
    {% include 'footer.html' %}
</body>
</html>