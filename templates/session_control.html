<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>KABRODA // SUITE</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&family=Inter:wght@400;600;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/site.css">
    <style>
        /* TOP SECRET DROPDOWN STYLE */
        .ts-wrapper { position: relative; display: inline-block; margin-left: 15px; }
        .ts-btn { 
            color: #ef4444; font-weight: 800; font-family: 'JetBrains Mono'; 
            cursor: pointer; text-decoration: none; padding: 5px 10px; border: 1px solid rgba(239,68,68,0.3); border-radius: 4px;
            transition: 0.2s;
        }
        .ts-btn:hover { background: rgba(239,68,68,0.1); box-shadow: 0 0 10px rgba(239,68,68,0.2); }
        
        .ts-menu {
            display: none; position: absolute; top: 100%; left: 0; 
            background: #0f172a; border: 1px solid #ef4444; border-radius: 6px; 
            min-width: 180px; z-index: 100; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            margin-top: 8px;
        }
        .ts-wrapper:hover .ts-menu { display: block; }
        .ts-item { 
            display: block; padding: 12px 15px; color: #fff; text-decoration: none; 
            font-family: 'JetBrains Mono'; font-size: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); 
        }
        .ts-item:hover { background: #ef4444; color: #000; }
        .ts-item:last-child { border-bottom: none; }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="nav-brand"><span class="brand-blue">KABRODA</span> <span style="color:#64748b">//</span> SUITE</div>
        <div class="nav-links">
            <a href="/suite" class="nav-item active">SESSION CONTROL</a>
            <a href="/suite/battle-control" class="nav-item">BATTLE CONTROL</a>
            
            {% if is_admin %}
            <div class="ts-wrapper">
                <div class="ts-btn">‚ö† TOP SECRET ‚ñº</div>
                <div class="ts-menu">
                    <a href="/suite/omega" class="ts-item">PROJECT OMEGA</a>
                    <a href="/suite/research-lab" class="ts-item">RESEARCH LAB</a>
                </div>
            </div>
            {% endif %}
            
            <div style="margin-left: 20px; border-left: 1px solid #334155; height: 20px;"></div>
            <a href="/account" class="nav-item">ACCOUNT</a>
            <a href="/logout" class="nav-item">LOGOUT</a>
        </div>
    </nav>

    <div class="container" style="margin-top: 40px;">
        <div class="dashboard-header">
            <div>
                <div class="tag-pill">BATTLEBOX COMMAND</div>
                <h1>SESSION CONTROL</h1>
                <p class="subtext">War Map Context & Session Execution</p>
            </div>
            <div class="user-badge">
                OPERATIVE ID<br>
                <span style="color:#38bdf8">{{ user.username if user else 'GUEST' }}</span>
            </div>
        </div>

        <div class="control-panel">
            <div class="cp-grid">
                <div>
                    <label class="cp-label">TARGET ASSET</label>
                    <select id="symbolSelect" class="cp-select">
                        <option value="BTCUSDT">BTC (BITCOIN)</option>
                        <option value="ETHUSDT">ETH (ETHEREUM)</option>
                        <option value="SOLUSDT">SOL (SOLANA)</option>
                    </select>
                </div>
                <div>
                    <label class="cp-label">TARGET SESSION</label>
                    <select id="sessionSelect" class="cp-select">
                        <option value="us_ny_futures">us NY FUTURES (08:30 ET)</option>
                        <option value="us_ny_equity">us NY EQUITY (09:30 ET)</option>
                        <option value="eu_london">gb LONDON (08:00 GMT)</option>
                        <option value="asia_tokyo">jp TOKYO (09:00 JST)</option>
                        <option value="au_sydney">au SYDNEY (10:00 AEDT)</option>
                        <option value="utc_default">üåê UTC (CRYPTO DEFAULT)</option>
                    </select>
                </div>
                <div style="display:flex; align-items:flex-end;">
                    <button onclick="runReview()" class="action-btn primary-btn" style="width:100%">RUN REVIEW SESSION</button>
                </div>
            </div>
            <div id="statusMsg" style="margin-top:10px; font-size:12px; color:#94a3b8; font-family:'JetBrains Mono'">READY.</div>
        </div>

        <div id="resultArea" style="display:none; margin-top:30px;">
            <div class="grid-2">
                <div class="card">
                    <div class="card-header">SESSION INTEL</div>
                    <div class="data-row"><span>SESSION ID</span><span id="resSession" class="mono-val">--</span></div>
                    <div class="data-row"><span>ANCHOR TIME</span><span id="resAnchor" class="mono-val">--</span></div>
                    <div class="data-row"><span>PRICE REF</span><span id="resPrice" class="mono-val">--</span></div>
                    <hr style="border-color:#1e293b; margin:15px 0;">
                    <div class="data-row"><span>STATUS</span><span id="resStatus" style="font-weight:700">--</span></div>
                </div>

                <div class="card">
                    <div class="card-header">STRUCTURAL LEVELS</div>
                    <div class="data-row"><span>DAILY RESISTANCE</span><span id="lvlDr" class="mono-val text-red">--</span></div>
                    <div class="data-row"><span>BREAKOUT TRIGGER</span><span id="lvlBo" class="mono-val text-green">--</span></div>
                    <div class="data-row"><span>BREAKDOWN TRIGGER</span><span id="lvlBd" class="mono-val text-red">--</span></div>
                    <div class="data-row"><span>DAILY SUPPORT</span><span id="lvlDs" class="mono-val text-green">--</span></div>
                    <hr style="border-color:#1e293b; margin:15px 0;">
                    <div class="data-row"><span>R30 HIGH</span><span id="lvlRh" class="mono-val">--</span></div>
                    <div class="data-row"><span>R30 LOW</span><span id="lvlRl" class="mono-val">--</span></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        async function runReview() {
            const btn = document.querySelector('.action-btn');
            const msg = document.getElementById('statusMsg');
            const symbol = document.getElementById('symbolSelect').value;
            const session = document.getElementById('sessionSelect').value; // <--- THIS GETS YOUR SELECTION

            btn.disabled = true;
            btn.innerText = "CALIBRATING...";
            msg.innerText = `Connecting to Pipeline for ${session}...`;

            try {
                // FIXED: SENDING SESSION_ID TO SWITCHBOARD
                const res = await fetch('/api/dmr/run-raw', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ symbol: symbol, session_id: session }) 
                });

                const data = await res.json();
                
                if (data.ok) {
                    msg.innerText = "DATA LOCKED.";
                    document.getElementById('resultArea').style.display = "block";
                    
                    // Populate UI
                    document.getElementById('resSession').innerText = data.session.name;
                    document.getElementById('resAnchor').innerText = data.session.anchor_time.replace('T', ' ').substring(0, 16);
                    document.getElementById('resPrice').innerText = data.price;
                    document.getElementById('resStatus').innerText = data.mode;
                    
                    if(data.mode === "LOCKED") {
                        document.getElementById('resStatus').style.color = "#10b981";
                        document.getElementById('lvlDr').innerText = data.levels.daily_resistance.toFixed(2);
                        document.getElementById('lvlBo').innerText = data.levels.breakout_trigger.toFixed(2);
                        document.getElementById('lvlBd').innerText = data.levels.breakdown_trigger.toFixed(2);
                        document.getElementById('lvlDs').innerText = data.levels.daily_support.toFixed(2);
                        document.getElementById('lvlRh').innerText = data.levels.range30m_high.toFixed(2);
                        document.getElementById('lvlRl').innerText = data.levels.range30m_low.toFixed(2);
                    } else {
                        document.getElementById('resStatus').style.color = "#f59e0b";
                        msg.innerText = data.message || "Session Calibrating (First 30m)...";
                    }

                } else {
                    msg.innerText = "ERROR: " + (data.error || "Unknown");
                }

            } catch (e) {
                msg.innerText = "CONNECTION FAILURE";
                console.error(e);
            }

            btn.disabled = false;
            btn.innerText = "RUN REVIEW SESSION";
        }
    </script>
</body>
</html>