<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PROJECT OMEGA | COMMAND</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --bg: #020617; --panel: rgba(15, 23, 42, 0.6); --border: rgba(56, 189, 248, 0.2); 
            --cyan: #06b6d4; --green: #10b981; --red: #ef4444; --gold: #facc15; 
            --text-glow: 0 0 10px rgba(6, 182, 212, 0.5);
        }
        body { 
            background: var(--bg); color: #fff; font-family: 'JetBrains Mono', monospace; 
            margin: 0; padding: 20px; height: 100vh; box-sizing: border-box; 
            background-image: radial-gradient(circle at 50% 50%, #0f172a 0%, #020617 100%);
            overflow: hidden; /* Lock scroll like a cockpit */
        }

        /* --- LAYOUT GRID --- */
        .cockpit { 
            display: grid; 
            grid-template-columns: 300px 1fr 320px; 
            grid-template-rows: 60px 1fr 200px;
            gap: 15px; 
            height: 100%;
        }
        
        .header { grid-column: 1 / 4; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
        .panel { background: var(--panel); border: 1px solid var(--border); border-radius: 8px; padding: 15px; backdrop-filter: blur(5px); position: relative; }
        .panel-left { grid-row: 2 / 3; grid-column: 1 / 2; }
        .panel-center { grid-row: 2 / 3; grid-column: 2 / 3; display: flex; flex-direction: column; }
        .panel-right { grid-row: 2 / 4; grid-column: 3 / 4; display: flex; flex-direction: column; } /* Full height right */
        .panel-bottom { grid-row: 3 / 4; grid-column: 1 / 3; border-top: 1px solid var(--border); display: flex; flex-direction: column; }

        /* --- TYPOGRAPHY --- */
        .glitch-text { font-family: 'Rajdhani', sans-serif; font-weight: 700; font-size: 24px; color: var(--cyan); text-shadow: var(--text-glow); letter-spacing: 2px; }
        .label { font-size: 10px; color: #64748b; letter-spacing: 1px; text-transform: uppercase; display: block; margin-bottom: 5px; }
        .val-lg { font-size: 24px; font-weight: 800; color: #fff; }
        
        /* --- RADAR / HUD (CENTER) --- */
        .hud-container { 
            flex-grow: 1; border: 1px solid var(--cyan); border-radius: 12px; margin-bottom: 15px; 
            position: relative; overflow: hidden; background: rgba(6, 182, 212, 0.05);
            display: flex; align-items: center; justify-content: center;
            box-shadow: inset 0 0 50px rgba(6, 182, 212, 0.1);
        }
        .scan-line {
            position: absolute; width: 100%; height: 2px; background: rgba(6, 182, 212, 0.5);
            top: 0; animation: scan 3s linear infinite; box-shadow: 0 0 10px var(--cyan);
        }
        @keyframes scan { 0% { top: 0%; opacity: 0; } 50% { opacity: 1; } 100% { top: 100%; opacity: 0; } }

        .radar-circle {
            width: 300px; height: 300px; border: 1px dashed rgba(6, 182, 212, 0.3); border-radius: 50%;
            position: absolute; animation: rotate 10s linear infinite;
        }
        .radar-crosshair {
            width: 20px; height: 20px; border: 1px solid var(--cyan); position: absolute;
        }
        @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .hud-overlay { position: absolute; text-align: center; z-index: 10; }
        .hud-status { font-size: 48px; font-family: 'Rajdhani'; font-weight: 800; color: #fff; text-shadow: 0 0 20px var(--cyan); letter-spacing: 5px; }
        .hud-sub { font-size: 16px; color: var(--cyan); font-weight: 700; background: rgba(0,0,0,0.5); padding: 5px 15px; border: 1px solid var(--cyan); display: inline-block; margin-top: 10px; }

        /* --- GAUGES --- */
        .gauge-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .gauge-box { background: rgba(0,0,0,0.3); padding: 10px; border-left: 2px solid #334155; }
        .bar-container { width: 100%; height: 6px; background: #1e293b; margin-top: 5px; position: relative; }
        .bar-fill { height: 100%; background: var(--cyan); width: 0%; transition: width 1s ease; box-shadow: 0 0 8px var(--cyan); }

        /* --- BLACK BOX (LOG) --- */
        .log-terminal { 
            flex-grow: 1; background: #000; font-family: 'Courier New', monospace; font-size: 12px; 
            padding: 10px; overflow-y: auto; color: #33ff00; opacity: 0.8;
        }
        .log-entry { margin-bottom: 4px; border-bottom: 1px solid #111; padding-bottom: 2px; }
        .log-time { color: #666; margin-right: 10px; }

        /* --- CONTROLS --- */
        .btn-action { width: 100%; background: transparent; border: 1px solid var(--cyan); color: var(--cyan); padding: 10px; font-family: 'JetBrains Mono'; font-weight: 800; cursor: pointer; transition: 0.2s; margin-bottom: 10px; }
        .btn-action:hover { background: var(--cyan); color: #000; box-shadow: 0 0 15px var(--cyan); }
        .inp-risk { background: #000; border: 1px solid #334155; color: #fff; width: 100%; padding: 8px; font-family: inherit; font-size: 14px; text-align: right; margin-bottom: 10px; }

        /* --- STATES --- */
        .state-RED .hud-status { color: var(--red); text-shadow: 0 0 20px var(--red); }
        .state-RED .radar-circle { border-color: var(--red); }
        .state-GOLD .hud-status { color: var(--gold); text-shadow: 0 0 20px var(--gold); }
        
        .copy-btn { float: right; font-size: 10px; background: #1e293b; border: 1px solid #475569; color: #fff; cursor: pointer; padding: 2px 6px; }
        .copy-btn:active { background: var(--green); }

    </style>
</head>
<body>

<div class="cockpit">
    
    <div class="header">
        <div class="glitch-text">PROJECT OMEGA <span style="font-size:12px; opacity:0.5;">v11.0</span></div>
        <div style="display:flex; gap:15px; align-items:center;">
            <div id="connectionStatus" style="width:8px; height:8px; background:var(--red); border-radius:50%; box-shadow:0 0 5px var(--red);"></div>
            <span class="label" style="margin:0;">NY FUTURES</span>
            <span class="label" id="clockUTC" style="color:#fff;">--:--:-- UTC</span>
        </div>
    </div>

    <div class="panel panel-left">
        <div class="label">/// RISK THROTTLE</div>
        <div style="margin-bottom: 20px;">
            <label class="label">BALANCE ($)</label>
            <input type="number" id="inpBal" class="inp-risk" value="4000" oninput="updateRisk()">
        </div>
        <div style="margin-bottom: 20px;">
            <label class="label">RISK %</label>
            <input type="number" id="inpRisk" class="inp-risk" value="10.0" step="0.1" oninput="updateRisk()">
        </div>
        <div style="border-top: 1px dashed #334155; padding-top: 10px;">
            <label class="label">MAX LOSS</label>
            <div id="valRisk" class="val-lg" style="color:var(--red); font-size:20px;">$400.00</div>
        </div>
        
        <div style="margin-top:auto; padding-top:20px;">
            <button class="btn-action" onclick="toggleAudio()">AUDIO: <span id="txtAudio">OFF</span></button>
            <button class="btn-action" onclick="requestNotify()">ENABLE NOTIFY</button>
        </div>
    </div>

    <div class="panel panel-center">
        <div class="hud-container" id="hudFrame">
            <div class="scan-line"></div>
            <div class="radar-circle"></div>
            <div class="radar-crosshair"></div>
            
            <div class="hud-overlay">
                <div class="hud-status" id="hudMain">SCANNING</div>
                <div class="hud-sub" id="hudSub">WAITING FOR LOCK</div>
            </div>
        </div>

        <div class="gauge-grid">
            <div class="gauge-box">
                <div style="display:flex; justify-content:space-between;">
                    <span class="label">ENERGY (BPS)</span>
                    <span class="label" id="valEnergy" style="color:#fff">--</span>
                </div>
                <div class="bar-container"><div class="bar-fill" id="barEnergy"></div></div>
            </div>
            <div class="gauge-box">
                <div style="display:flex; justify-content:space-between;">
                    <span class="label">RUNWAY (ATR)</span>
                    <span class="label" id="valSpace" style="color:#fff">--</span>
                </div>
                <div class="bar-container"><div class="bar-fill" id="barSpace"></div></div>
            </div>
            <div class="gauge-box">
                <div style="display:flex; justify-content:space-between;">
                    <span class="label">WIND (SLOPE)</span>
                    <span class="label" id="valSlope" style="color:#fff">--</span>
                </div>
                <div class="bar-container"><div class="bar-fill" id="barSlope"></div></div>
            </div>
            <div class="gauge-box">
                <div style="display:flex; justify-content:space-between;">
                    <span class="label">HULL (STRUCT)</span>
                    <span class="label" id="valStruct" style="color:#fff">--</span>
                </div>
                <div class="bar-container"><div class="bar-fill" id="barStruct"></div></div>
            </div>
        </div>
    </div>

    <div class="panel panel-right">
        <div class="label">/// TARGETING COMPUTER</div>
        
        <div style="display:flex; gap:5px; margin-bottom:15px;">
            <button id="btnLong" class="btn-action" style="flex:1" onclick="forceSide('LONG')">LONG</button>
            <button id="btnShort" class="btn-action" style="flex:1" onclick="forceSide('SHORT')">SHORT</button>
        </div>

        <div class="data-row">
            <span class="label">ENTRY <button class="copy-btn" onclick="cp('pEntry')">CP</button></span>
            <div id="pEntry" class="val-lg" style="color:var(--cyan)">--</div>
        </div>
        <br>
        <div class="data-row">
            <span class="label">STOP LOSS <button class="copy-btn" onclick="cp('pStop')">CP</button></span>
            <div id="pStop" class="val-lg" style="color:var(--red); font-size:20px;">--</div>
        </div>
        <br>
        <div class="data-row">
            <span class="label">SIZE (USD) <button class="copy-btn" onclick="cp('pSize')">CP</button></span>
            <div id="pSize" class="val-lg" style="font-size:20px;">--</div>
        </div>

        <hr style="border:0; border-top:1px solid #334155; margin:15px 0;">

        <div class="data-row">
            <span class="label">TARGET 1 (75%)</span>
            <div id="pT1" style="color:var(--gold); font-weight:800;">--</div>
        </div>
        <div class="data-row" style="margin-top:5px;">
            <span class="label">MOVE BE @</span>
            <div id="pBE" style="color:#fff; font-weight:700;">--</div>
        </div>
        
    </div>

    <div class="panel panel-bottom">
        <div class="label" style="background:#111; padding:5px;">/// BLACK BOX RECORDER [REC]</div>
        <div id="logTerminal" class="log-terminal">
            <div class="log-entry"><span class="log-time">SYS</span> SYSTEM BOOT SEQUENCE INITIATED...</div>
        </div>
    </div>

</div>

<script>
    // --- STATE ---
    let state = {
        data: null,
        lastStatus: "",
        manualSide: null,
        audio: false,
        log: []
    };

    // --- UTILS ---
    function log(msg) {
        const now = new Date().toLocaleTimeString('en-US', {hour12:false});
        const line = `<div class="log-entry"><span class="log-time">${now}</span> ${msg}</div>`;
        const term = document.getElementById('logTerminal');
        term.innerHTML += line;
        term.scrollTop = term.scrollHeight;
    }

    function notify(title, body) {
        if (Notification.permission === "granted") {
            new Notification(title, { body: body, icon: '/static/icon.png' });
        }
    }

    function requestNotify() { Notification.requestPermission().then(p => { if(p==="granted") log("COMMS LINK ESTABLISHED."); }); }
    function toggleAudio() { state.audio = !state.audio; document.getElementById('txtAudio').innerText = state.audio ? "ON" : "OFF"; }
    function cp(id) { navigator.clipboard.writeText(document.getElementById(id).innerText.replace(/,/g,'')); log("COPIED TO CLIPBOARD."); }
    
    function speak(text) {
        if(!state.audio) return;
        const u = new SpeechSynthesisUtterance(text);
        speechSynthesis.speak(u);
    }

    // --- RENDER LOGIC ---
    function updateGauges(k) {
        // Parse "SUPER COILED (43bps)" -> 43
        let bps = 0; try { bps = parseInt(k.breakdown.energy.match(/\d+/)[0]); } catch(e){}
        let atr = 0; try { atr = parseFloat(k.breakdown.space.match(/([\d\.]+)R/)[1]); } catch(e){}
        
        // Bars (0-100%)
        // Energy: Lower is better (0-100bps is prime). Invert logic visually? 
        // Actually, let's map: 0bps=100%, 300bps=0%
        let ePct = Math.max(0, Math.min(100, (300 - bps)/3));
        document.getElementById('barEnergy').style.width = ePct + "%";
        document.getElementById('barEnergy').style.background = ePct > 66 ? "var(--green)" : "var(--red)";
        document.getElementById('valEnergy').innerText = bps + " bps";

        // Space: 2R is 100%
        let sPct = Math.max(0, Math.min(100, (atr / 2.0) * 100));
        document.getElementById('barSpace').style.width = sPct + "%";
        document.getElementById('valSpace').innerText = atr + " R";

        // Structure
        let struct = k.breakdown.structure.includes("SOLID") ? 100 : 30;
        document.getElementById('barStruct').style.width = struct + "%";
        document.getElementById('valStruct').innerText = k.breakdown.structure;
    }

    function monitorSortie(plan, price) {
        if (!plan || !plan.valid || !price) return;
        
        // Active Sortie Monitor
        // Check T1
        let t1 = plan.targets[0];
        if (t1 && ((plan.trigger < t1 && price >= t1) || (plan.trigger > t1 && price <= t1))) {
            // T1 HIT
            document.getElementById('hudFrame').className = "hud-container state-GOLD";
            document.getElementById('hudMain').innerText = "TARGET 1 HIT";
            document.getElementById('hudSub').innerText = "BANK 75% NOW";
            if (state.lastStatus !== "T1_HIT") {
                log(`>>> OBJECTIVE ALPHA (T1) ACHIEVED @ ${price}`);
                notify("PROJECT OMEGA", "Target 1 Hit. Bank 75%.");
                speak("Target one hit. Bank profit.");
                state.lastStatus = "T1_HIT";
            }
            return; // Priority display
        }

        // Check Stop
        let stop = plan.stop;
        if (stop && ((plan.trigger < t1 && price <= stop) || (plan.trigger > t1 && price >= stop))) {
            document.getElementById('hudFrame').className = "hud-container state-RED";
            document.getElementById('hudMain').innerText = "STOP HIT";
            document.getElementById('hudSub').innerText = "SORTIE FAILED - EJECT";
            if (state.lastStatus !== "STOP_HIT") {
                log(`!!! CRITICAL FAILURE. STOP HIT @ ${price}`);
                state.lastStatus = "STOP_HIT";
            }
            return;
        }
    }

    async function fetchLoop() {
        try {
            const res = await fetch('/api/omega/status', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ session_id: "us_ny_futures" })
            });
            const d = await res.json();
            state.data = d;

            // Connection Dot
            document.getElementById('connectionStatus').style.background = "var(--green)";
            document.getElementById('connectionStatus').style.boxShadow = "0 0 5px var(--green)";
            
            // Clock
            document.getElementById('clockUTC').innerText = new Date().toISOString().split('T')[1].split('.')[0] + " UTC";

            // Price
            const price = d.price;

            // Determine Side
            let side = state.manualSide || (d.active_side !== "NONE" ? d.active_side : "LONG");
            const k = d.kinetic;
            const plan = d.plans[side];

            // Render HUD
            const hudBox = document.getElementById('hudFrame');
            const main = document.getElementById('hudMain');
            const sub = document.getElementById('hudSub');

            if (d.status === "CLOSED") {
                main.innerText = "SESSION CLOSED";
                sub.innerText = "MARKET OFFLINE";
                hudBox.className = "hud-container";
                hudBox.style.opacity = "0.5";
            } else if (d.status === "EXECUTING") {
                main.innerText = "EXECUTE " + side;
                sub.innerText = "ENTRY TRIGGERED";
                hudBox.className = "hud-container state-GOLD";
                // Only alert once per signal
                if (state.lastStatus !== "EXEC") {
                    log(`>>> EXECUTION SIGNAL: ${side} @ ${price}`);
                    notify("PROJECT OMEGA", `EXECUTE ${side} NOW`);
                    speak(`Execute ${side} now.`);
                    state.lastStatus = "EXEC";
                }
            } else if (d.status === "ACTIVE") {
                main.innerText = "IN COMBAT";
                sub.innerText = "TRACKING TARGETS...";
                hudBox.className = "hud-container";
                monitorSortie(plan, price);
            } else {
                // Scanning
                main.innerText = k.protocol || "SCANNING";
                sub.innerText = `SCORE: ${k.total_score} // ${d.status}`;
                hudBox.className = "hud-container";
            }

            // Render Gauges
            if (k.breakdown) updateGauges(k);

            // Render Right Panel (Cheat Sheet)
            if (plan) {
                document.getElementById('pEntry').innerText = plan.trigger ? plan.trigger.toLocaleString() : "--";
                document.getElementById('pStop').innerText = plan.stop ? plan.stop.toLocaleString() : "--";
                document.getElementById('pT1').innerText = plan.targets[0] ? plan.targets[0].toLocaleString() : "--";
                document.getElementById('pBE').innerText = plan.be_trigger ? plan.be_trigger.toLocaleString() : "--";

                // Calc Size
                const bal = parseFloat(document.getElementById('inpBal').value) || 0;
                const riskPct = parseFloat(document.getElementById('inpRisk').value) || 0;
                let riskAmt = bal * (riskPct / 100);
                if(riskAmt > 5000) riskAmt = 5000; // Safety cap
                document.getElementById('valRisk').innerText = "$" + riskAmt.toFixed(2);

                if (plan.trigger && plan.stop) {
                    const riskPerUnit = Math.abs(plan.trigger - plan.stop);
                    const units = riskAmt / riskPerUnit;
                    const sizeUsd = units * plan.trigger;
                    document.getElementById('pSize').innerText = Math.floor(sizeUsd).toLocaleString();
                }
            }

            // Button highlights
            document.getElementById('btnLong').style.border = side === "LONG" ? "2px solid var(--green)" : "1px solid var(--cyan)";
            document.getElementById('btnShort').style.border = side === "SHORT" ? "2px solid var(--red)" : "1px solid var(--cyan)";

        } catch(e) {
            console.error(e);
            document.getElementById('connectionStatus').style.background = "var(--red)";
        }
    }

    function forceSide(s) { state.manualSide = s; fetchLoop(); }
    function updateRisk() { fetchLoop(); } // Re-calc on input

    // Init
    setInterval(fetchLoop, 2000);
    fetchLoop();
    log("SYSTEM READY. WAITING FOR TELEMETRY...");

</script>
</body>
</html>