<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>KABRODA // ACCOUNT</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&family=Inter:wght@400;600;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/site.css">
    <style>
        /* SHARED STYLES FOR CONSISTENCY */
        :root { --bg: #020617; --panel: #0f172a; --border: #1e293b; --green: #10b981; --red: #ef4444; --text-main: #ffffff; --text-dim: #94a3b8; }
        body { background: var(--bg); color: var(--text-main); font-family: 'Inter', sans-serif; margin: 0; padding: 20px; }
        
        .navbar { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); padding-bottom: 20px; margin-bottom: 40px; }
        .nav-brand { font-family: 'JetBrains Mono'; font-weight: 800; font-size: 20px; color: #fff; }
        .nav-links { display: flex; align-items: center; gap: 20px; }
        .nav-item { color: var(--text-dim); text-decoration: none; font-size: 13px; font-weight: 700; transition: 0.2s; }
        .nav-item:hover, .nav-item.active { color: #fff; }

        /* DROPDOWN (Fixed) */
        .ts-wrapper { position: relative; display: inline-block; padding-bottom: 10px; margin-bottom: -10px; }
        .ts-btn { color: var(--red); font-weight: 800; font-family: 'JetBrains Mono'; cursor: pointer; padding: 6px 12px; border: 1px solid rgba(239,68,68,0.3); border-radius: 4px; font-size: 12px; }
        .ts-btn:hover { background: rgba(239,68,68,0.1); }
        .ts-menu { display: none; position: absolute; top: 100%; left: 0; background: #0f172a; border: 1px solid var(--red); border-radius: 6px; min-width: 180px; z-index: 100; box-shadow: 0 10px 30px rgba(0,0,0,0.5); margin-top: 2px; }
        .ts-wrapper:hover .ts-menu { display: block; }
        .ts-item { display: block; padding: 12px 15px; color: #fff; text-decoration: none; font-family: 'JetBrains Mono'; font-size: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .ts-item:hover { background: var(--red); color: #000; }

        .container { max-width: 800px; margin: 0 auto; }
        .card { background: var(--panel); border: 1px solid var(--border); border-radius: 8px; padding: 30px; margin-bottom: 25px; }
        .section-title { font-family: 'JetBrains Mono'; font-size: 14px; color: var(--text-dim); margin-bottom: 20px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; border-left: 3px solid var(--text-dim); padding-left: 10px; }
        
        .input-group { margin-bottom: 20px; }
        .input-label { display: block; font-size: 11px; color: var(--text-dim); margin-bottom: 8px; font-weight: 700; }
        .cyber-input { width: 100%; background: #020617; border: 1px solid var(--border); color: #fff; padding: 12px; border-radius: 4px; font-family: 'JetBrains Mono'; font-size: 14px; box-sizing: border-box; }
        .cyber-input:focus { border-color: var(--green); outline: none; }

        .btn-save { background: var(--green); color: #000; border: none; padding: 10px 20px; border-radius: 4px; font-family: 'JetBrains Mono'; font-weight: 800; cursor: pointer; float: right; }
        .btn-danger { background: var(--red); color: #fff; border: none; padding: 10px 20px; border-radius: 4px; font-family: 'JetBrains Mono'; font-weight: 800; cursor: pointer; float: right; }
        
        .status-msg { font-size: 12px; font-family: 'JetBrains Mono'; margin-top: 10px; display: inline-block; }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="nav-brand">KABRODA // ACCOUNT</div>
        <div class="nav-links">
            <a href="/suite" class="nav-item">SESSION CONTROL</a>
            <a href="/suite/battle-control" class="nav-item">BATTLE CONTROL</a>
            
            {% if is_admin %}
            <div class="ts-wrapper">
                <div class="ts-btn">⚠ TOP SECRET ▼</div>
                <div class="ts-menu">
                    <a href="/suite/system-monitor" class="ts-item">SYSTEM MONITOR</a>
                    <a href="/suite/omega" class="ts-item">PROJECT OMEGA</a>
                    <a href="/suite/research-lab" class="ts-item">RESEARCH LAB</a>
                </div>
            </div>
            {% endif %}
            
            <a href="/account" class="nav-item active" style="margin-left:20px;">ACCOUNT</a>
            <a href="/logout" class="nav-item">LOGOUT</a>
        </div>
    </nav>

    <div class="container">
        
        <div class="card">
            <div class="section-title" style="border-color: #38bdf8;">OPERATIVE PROFILE</div>
            <div class="input-group">
                <label class="input-label">CODENAME (USERNAME)</label>
                <input type="text" id="username" class="cyber-input" value="{{ user.username or '' }}">
            </div>
            <div class="input-group">
                <label class="input-label">TRADINGVIEW ID</label>
                <input type="text" id="tvid" class="cyber-input" value="{{ user.tradingview_id or '' }}">
            </div>
            <div style="overflow: hidden;">
                <span id="profileMsg" class="status-msg"></span>
                <button onclick="saveProfile()" class="btn-save">UPDATE PROFILE</button>
            </div>
        </div>

        <div class="card" style="border-color: rgba(239,68,68,0.3);">
            <div class="section-title" style="border-color: var(--red); color: var(--red);">SECURITY PROTOCOL</div>
            <div class="input-group">
                <label class="input-label">UPDATE ACCESS KEY (PASSWORD)</label>
                <input type="password" id="newPass" class="cyber-input" placeholder="••••••••">
            </div>
            <div style="overflow: hidden;">
                <span id="passMsg" class="status-msg"></span>
                <button onclick="updatePassword()" class="btn-danger">UPDATE KEY</button>
            </div>
        </div>

        <div class="card">
            <div class="section-title" style="border-color: #06b6d4;">BILLING COMMAND</div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <span style="color: var(--text-dim); font-size: 13px;">CURRENT PLAN</span>
                <span style="color: var(--green); font-weight: 800; font-family: 'JetBrains Mono';">ACTIVE</span>
            </div>
            <button style="width: 100%; background: transparent; border: 1px solid var(--border); color: var(--text-dim); padding: 12px; border-radius: 4px; cursor: pointer; font-family: 'JetBrains Mono'; font-size: 12px;">
                MANAGE SUBSCRIPTION & INVOICES ↗
            </button>
        </div>

    </div>

    <script>
        async function saveProfile() {
            const btn = document.querySelector('.btn-save');
            const msg = document.getElementById('profileMsg');
            btn.innerText = "SAVING...";
            
            const payload = {
                username: document.getElementById('username').value,
                tradingview_id: document.getElementById('tvid').value
            };

            try {
                const res = await fetch('/account/profile', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                if(res.ok) {
                    msg.innerText = "PROFILE UPDATED.";
                    msg.style.color = "#10b981";
                } else { throw new Error("Failed"); }
            } catch(e) {
                msg.innerText = "ERROR SAVING.";
                msg.style.color = "#ef4444";
            }
            setTimeout(() => { btn.innerText = "UPDATE PROFILE"; msg.innerText = ""; }, 2000);
        }

        async function updatePassword() {
            const pass = document.getElementById('newPass').value;
            const msg = document.getElementById('passMsg');
            const btn = document.querySelector('.btn-danger');

            if(!pass) { msg.innerText = "ENTER PASSWORD FIRST"; msg.style.color = "#ef4444"; return; }
            
            btn.innerText = "UPDATING...";
            try {
                // THIS CALLS THE NEW ENDPOINT IN MAIN.PY
                const res = await fetch('/account/password', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ password: pass })
                });
                if(res.ok) {
                    msg.innerText = "KEY UPDATED SUCCESSFULLY.";
                    msg.style.color = "#10b981";
                    document.getElementById('newPass').value = "";
                } else { throw new Error("Failed"); }
            } catch(e) {
                msg.innerText = "UPDATE FAILED.";
                msg.style.color = "#ef4444";
            }
            setTimeout(() => { btn.innerText = "UPDATE KEY"; }, 2000);
        }
    </script>
</body>
</html>