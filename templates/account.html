{% extends "base.html" %}
{% block content %}

<div class="text-center" style="margin-bottom: 40px;">
  <div class="pill">OPERATIVE PROFILE</div>
  <h1 class="display-title" style="font-size: 32px;">Command <span class="gradient-text">Settings</span></h1>
</div>

<div class="bento-grid">

  <div class="bento-card">
    <div style="margin-bottom: 20px;">
      <h3 style="color: #fff; margin-bottom: 4px;">Operative Identity</h3>
      <p style="font-size: 13px; color: var(--text-muted);">Set your secure callsign.</p>
    </div>
    
    <div style="margin-bottom: 16px;">
      <label class="label">Email Identity (Read Only)</label>
      <input class="input" value="{{ user.email }}" disabled style="opacity: 0.6; cursor: not-allowed;">
    </div>

    <div style="margin-bottom: 16px;">
      <label class="label" style="color: var(--primary-bright);">Operative Callsign</label>
      <input id="usernameInput" class="input" placeholder="e.g. SpiritMaker" value="{{ user.username or '' }}" style="border-color: var(--primary-glow);">
      <div style="font-size: 11px; color: var(--text-muted); margin-top: 6px;">This name will appear on your BattleBox Command header.</div>
    </div>

    <button id="saveProfileBtn" class="btn primary" onclick="saveProfile()" style="width: 100%;">
      UPDATE CALLSIGN
    </button>
    <div id="profileMsg" style="margin-top: 10px; font-size: 12px; text-align: center; height: 16px;"></div>
  </div>

  <div class="bento-card" style="border: 1px solid rgba(255,255,255,0.1);">
    <div style="margin-bottom: 16px;">
      <h3 style="color: #fff; margin-bottom: 4px;">Subscription Control</h3>
      <div style="font-size: 12px; font-weight: 700; color: var(--success); letter-spacing: 0.1em; margin-bottom: 8px;">
        STATUS: {{ tier_label|default('ACTIVE') }}
      </div>
    </div>

    <div style="display: grid; gap: 12px;">
      <button onclick="openPortal()" class="btn secondary" style="width: 100%; justify-content: center;">
        Update Payment Method
      </button>
      
      <button onclick="openPortal()" class="btn secondary" style="width: 100%; justify-content: center; border-color: rgba(239, 68, 68, 0.4); color: #fca5a5;">
        Cancel Subscription
      </button>
    </div>
    <p style="text-align: center; font-size: 11px; color: var(--text-muted); margin-top: 12px;">
      Redirects to secure Stripe Portal.
    </p>
  </div>

</div>

<div class="text-center" style="margin-top: 60px;">
  <form action="/logout" method="post">
    <button type="submit" class="btn secondary" style="border: none; color: var(--text-muted);">
      Log Out
    </button>
  </form>
</div>

<script>
// --- 1. PROFILE/CALLSIGN LOGIC ---
async function saveProfile(){
  const name = document.getElementById('usernameInput').value;
  const btn = document.getElementById('saveProfileBtn');
  const msg = document.getElementById('profileMsg');
  btn.innerText = "UPDATING...";
  
  try {
    const r = await fetch("/account/profile", {
      method: "POST", headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ username: name })
    });
    if(r.ok){ 
      msg.style.color = "var(--success)"; 
      msg.innerText = "CALLSIGN UPDATED"; 
      btn.innerText = "UPDATE CALLSIGN"; 
    }
  } catch(e) { 
    msg.style.color = "var(--danger)"; 
    msg.innerText = "ERROR"; 
    btn.innerText = "RETRY";
  }
}

// --- 2. BILLING PORTAL LOGIC ---
async function openPortal(){
  const r = await fetch("/billing/portal", {method:"POST"});
  const d = await r.json();
  if(d.url) window.location.href = d.url;
}
</script>
{% endblock %}