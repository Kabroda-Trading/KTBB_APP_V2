{% extends "base.html" %}
{% block content %}

<div class="text-center" style="margin-bottom: 40px;">
  <div class="pill">OPERATIVE PROFILE</div>
  <h1 class="display-title" style="font-size: 32px;">Command <span class="gradient-text">Settings</span></h1>
</div>

<div class="bento-grid">

  <div class="bento-card">
    <div style="margin-bottom: 20px;">
      <h3 style="color: #fff; margin-bottom: 4px;">Operative Identity</h3>
      <p style="font-size: 13px; color: var(--text-muted);">Set your secure callsign.</p>
    </div>
    
    <div style="margin-bottom: 16px;">
      <label class="label">Email Identity (Read Only)</label>
      <input class="input" value="{{ user.email }}" disabled style="opacity: 0.6; cursor: not-allowed;">
    </div>

    <div style="margin-bottom: 16px;">
      <label class="label" style="color: var(--primary-bright);">Operative Callsign</label>
      <input id="usernameInput" class="input" placeholder="e.g. SpiritMaker" value="{{ user.username or '' }}" style="border-color: var(--primary-glow);">
    </div>

    <button id="saveProfileBtn" class="btn primary" onclick="saveProfile()" style="width: 100%;">
      UPDATE CALLSIGN
    </button>
    <div id="profileMsg" style="margin-top: 10px; font-size: 12px; text-align: center; height: 16px;"></div>
  </div>

  <div style="display: flex; flex-direction: column; gap: 24px;">
    
    <div class="bento-card" style="border: 1px solid rgba(255,255,255,0.1);">
      <div style="margin-bottom: 16px;">
        <h3 style="color: #fff; margin-bottom: 4px;">Subscription Control</h3>
        <div style="font-size: 12px; font-weight: 700; color: var(--success); letter-spacing: 0.1em; margin-bottom: 8px;">
          STATUS: {{ tier_label|default('ACTIVE') }}
        </div>
      </div>
      <div style="display: grid; gap: 12px;">
        <button onclick="openPortal()" class="btn secondary" style="width: 100%; justify-content: center;">
          Update Payment Method
        </button>
        <button onclick="openPortal()" class="btn secondary" style="width: 100%; justify-content: center; border-color: rgba(239, 68, 68, 0.4); color: #fca5a5;">
          Cancel Subscription
        </button>
      </div>
    </div>

    <div class="bento-card" style="border-left: 4px solid var(--warning);">
      <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px;">
        <div>
          <h3 style="color: #fff; font-size: 16px; margin-bottom: 4px;">Dev Settings</h3>
          <p style="font-size: 12px; color: var(--text-muted);">Advanced execution logic.</p>
        </div>
        <div class="tooltip-container">
          ? INFO
          <span class="tooltip-text">
            <strong>Operator Flex (5m Gate)</strong><br><br>
            Relaxes the five-minute structure requirement only after higher-timeframe permission is already earned.<br><br>
            It does not change your levels, triggers, or permission logic.
          </span>
        </div>
      </div>

      <div style="display: flex; align-items: center; justify-content: space-between; background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px;">
        <label for="opFlexToggle" style="font-size: 13px; font-weight: 700; color: #fff; cursor: pointer;">
          Enable Operator Flex
        </label>
        <input type="checkbox" id="opFlexToggle" {% if user.operator_flex %}checked{% endif %} style="accent-color: var(--warning); transform: scale(1.2); cursor: pointer;">
      </div>

      <button id="saveDevBtn" onclick="saveDevSettings()" class="btn secondary" style="width: 100%; margin-top: 16px; font-size: 12px;">
        SAVE CONFIGURATION
      </button>
      <div id="devMsg" style="margin-top: 8px; font-size: 11px; text-align: center; height: 16px; color: var(--text-muted);"></div>
    </div>

  </div>
</div>

<div class="text-center" style="margin-top: 60px;">
  <form action="/logout" method="post">
    <button type="submit" class="btn secondary" style="border: none; color: var(--text-muted);">
      Log Out
    </button>
  </form>
</div>

<script>
// 1. PROFILE LOGIC
async function saveProfile(){
  const name = document.getElementById('usernameInput').value;
  const btn = document.getElementById('saveProfileBtn');
  const msg = document.getElementById('profileMsg');
  btn.innerText = "UPDATING...";
  
  try {
    const r = await fetch("/account/profile", {
      method: "POST", headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ username: name })
    });
    if(r.ok){ 
      msg.style.color = "var(--success)"; 
      msg.innerText = "CALLSIGN UPDATED"; 
      btn.innerText = "UPDATE CALLSIGN"; 
    }
  } catch(e) { 
    msg.style.color = "var(--danger)"; 
    msg.innerText = "ERROR"; 
    btn.innerText = "RETRY";
  }
}

// 2. DEV SETTINGS LOGIC (NEW)
async function saveDevSettings(){
  const isFlex = document.getElementById('opFlexToggle').checked;
  const btn = document.getElementById('saveDevBtn');
  const msg = document.getElementById('devMsg');
  btn.innerText = "SAVING...";

  try {
    const r = await fetch("/account/settings", {
      method: "POST", headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ operator_flex: isFlex })
    });
    if(r.ok){
      msg.style.color = "var(--warning)";
      msg.innerText = "CONFIGURATION SAVED";
      btn.innerText = "SAVE CONFIGURATION";
      setTimeout(() => { msg.innerText = ""; }, 3000);
    }
  } catch(e) {
    msg.innerText = "SAVE FAILED";
  }
}

// 3. BILLING PORTAL
async function openPortal(){
  const r = await fetch("/billing/portal", {method:"POST"});
  const d = await r.json();
  if(d.url) window.location.href = d.url;
}
</script>
{% endblock %}